{% extends "public/public_base.html" %}
{% from "components/nvc_components.html" import metric_card, action_card, account_card, transaction_row, form_input, form_select, notification_banner, progress_bar, stats_grid, loading_spinner, empty_state %}

{% block title %}Reset Password - NVC Banking Platform{% endblock %}

{% block content %}
<!-- Modern NVC Password Reset Hero Section -->
<section class="nvc-auth-hero">
    <div class="nvc-auth-container">
        <div class="nvc-auth-layout">
            <div class="nvc-auth-content">
                <div class="nvc-auth-grid">
                    <!-- Security Information Section -->
                    <div class="nvc-auth-welcome">
                        <div class="nvc-welcome-content">
                            <div class="nvc-welcome-header">
                                <div class="nvc-brand-icon">
                                    <i class="fas fa-lock" aria-hidden="true"></i>
                                </div>
                                <h1 class="nvc-welcome-title nvc-wcag-high-contrast">Create New Password</h1>
                                <p class="nvc-welcome-subtitle nvc-wcag-medium-contrast">
                                    Set a strong, secure password to protect your NVC Banking account with enterprise-grade security standards.
                                </p>
                            </div>

                            <!-- Security Requirements Grid -->
                            <div class="nvc-trust-features">
                                <div class="nvc-features-grid">
                                    <div class="nvc-feature-item">
                                        <div class="nvc-feature-icon nvc-feature-security">
                                            <i class="fas fa-shield-check" aria-hidden="true"></i>
                                        </div>
                                        <div class="nvc-feature-content">
                                            <h3 class="nvc-feature-title nvc-wcag-high-contrast">Secure Standards</h3>
                                            <p class="nvc-feature-description nvc-wcag-medium-contrast">Minimum 8 characters with complexity requirements</p>
                                        </div>
                                    </div>

                                    <div class="nvc-feature-item">
                                        <div class="nvc-feature-icon nvc-feature-encryption">
                                            <i class="fas fa-key" aria-hidden="true"></i>
                                        </div>
                                        <div class="nvc-feature-content">
                                            <h3 class="nvc-feature-title nvc-wcag-high-contrast">Encrypted Storage</h3>
                                            <p class="nvc-feature-description nvc-wcag-medium-contrast">Passwords encrypted with industry standards</p>
                                        </div>
                                    </div>

                                    <div class="nvc-feature-item">
                                        <div class="nvc-feature-icon nvc-feature-audit">
                                            <i class="fas fa-file-shield" aria-hidden="true"></i>
                                        </div>
                                        <div class="nvc-feature-content">
                                            <h3 class="nvc-feature-title nvc-wcag-high-contrast">FINRA Compliant</h3>
                                            <p class="nvc-feature-description nvc-wcag-medium-contrast">Password changes logged for audit compliance</p>
                                        </div>
                                    </div>

                                    <div class="nvc-feature-item">
                                        <div class="nvc-feature-icon nvc-feature-time">
                                            <i class="fas fa-clock" aria-hidden="true"></i>
                                        </div>
                                        <div class="nvc-feature-content">
                                            <h3 class="nvc-feature-title nvc-wcag-high-contrast">Secure Link</h3>
                                            <p class="nvc-feature-description nvc-wcag-medium-contrast">Reset link expires for security</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modern Password Reset Form -->
                    <div class="nvc-auth-form">
                        <div class="nvc-reset-card">
                            <!-- Form Header -->
                            <div class="nvc-form-header">
                                <div class="nvc-form-icon">
                                    <i class="fas fa-lock" aria-hidden="true"></i>
                                </div>
                                <h2 class="nvc-form-title nvc-wcag-high-contrast">Create New Password</h2>
                                <p class="nvc-form-subtitle nvc-wcag-medium-contrast">Set a strong password to secure your account</p>
                            </div>

                            <!-- Flash Messages -->
                            {% with messages = get_flashed_messages(with_categories=true) %}
                                {% if messages %}
                                    <div class="nvc-flash-messages">
                                        {% for category, message in messages %}
                                            <div class="nvc-alert nvc-alert-{{ 'danger' if category == 'error' else 'info' if category == 'info' else 'success' }}" role="alert">
                                                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' if category == 'info' else 'check-circle' }}" aria-hidden="true"></i>
                                                <span>{{ message }}</span>
                                                <button type="button" class="nvc-alert-close nvc-wcag-focus" aria-label="Dismiss alert">
                                                    <i class="fas fa-times" aria-hidden="true"></i>
                                                </button>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endwith %}

                            <!-- Password Reset Form -->
                            <form method="POST" action="{{ url_for('auth.reset_password', token=token) if url_for else '#' }}" class="nvc-auth-form-container" novalidate>
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}"/>
                                <input type="hidden" name="token" value="{{ token if token else '' }}"/>

                                <!-- New Password Field -->
                                <div class="nvc-form-group">
                                    <label for="newPassword" class="nvc-form-label nvc-wcag-high-contrast">
                                        <i class="fas fa-key" aria-hidden="true"></i>
                                        New Password
                                    </label>
                                    <div class="nvc-input-container">
                                        <input type="password"
                                               class="nvc-form-control nvc-wcag-focus"
                                               id="newPassword"
                                               name="newPassword"
                                               required
                                               placeholder="Enter your new password"
                                               aria-describedby="newPassword-help newPassword-error password-strength"
                                               autocomplete="new-password">
                                        <div class="nvc-input-icon">
                                            <i class="fas fa-key" aria-hidden="true"></i>
                                        </div>
                                        <button type="button" class="nvc-password-toggle nvc-wcag-focus" aria-label="Toggle password visibility">
                                            <i class="fas fa-eye" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                    <div id="newPassword-help" class="nvc-form-help nvc-wcag-medium-contrast">Create a strong password with at least 8 characters</div>
                                    <div id="newPassword-error" class="nvc-form-error" role="alert" aria-live="polite"></div>

                                    <!-- Password Strength Indicator -->
                                    <div id="password-strength" class="nvc-password-strength">
                                        <div class="nvc-strength-bar">
                                            <div class="nvc-strength-fill" id="passwordStrengthBar"></div>
                                        </div>
                                        <span class="nvc-strength-text nvc-wcag-medium-contrast">Password strength: <span class="nvc-strength-level" id="passwordStrengthText">Weak</span></span>
                                    </div>
                                </div>

                                <!-- Confirm Password Field -->
                                <div class="nvc-form-group">
                                    <label for="confirmPassword" class="nvc-form-label nvc-wcag-high-contrast">
                                        <i class="fas fa-check-circle" aria-hidden="true"></i>
                                        Confirm New Password
                                    </label>
                                    <div class="nvc-input-container">
                                        <input type="password"
                                               class="nvc-form-control nvc-wcag-focus"
                                               id="confirmPassword"
                                               name="confirmPassword"
                                               required
                                               placeholder="Confirm your new password"
                                               aria-describedby="confirmPassword-help confirmPassword-error"
                                               autocomplete="new-password">
                                        <div class="nvc-input-icon">
                                            <i class="fas fa-check-circle" aria-hidden="true"></i>
                                        </div>
                                        <div class="nvc-match-indicator" id="password-match"></div>
                                    </div>
                                    <div id="confirmPassword-help" class="nvc-form-help nvc-wcag-medium-contrast">Re-enter your password to confirm</div>
                                    <div id="confirmPassword-error" class="nvc-form-error" role="alert" aria-live="polite"></div>
                                </div>

                                <!-- Password Requirements -->
                                <div class="nvc-password-requirements">
                                    <h3 class="nvc-requirements-title nvc-wcag-high-contrast">
                                        <i class="fas fa-shield-alt" aria-hidden="true"></i>
                                        Password Requirements
                                    </h3>
                                    <div class="nvc-requirements-list">
                                        <div class="nvc-requirement" id="lengthReq">
                                            <i class="fas fa-times nvc-requirement-icon" aria-hidden="true"></i>
                                            <span class="nvc-requirement-text nvc-wcag-medium-contrast">At least 8 characters long</span>
                                        </div>
                                        <div class="nvc-requirement" id="uppercaseReq">
                                            <i class="fas fa-times nvc-requirement-icon" aria-hidden="true"></i>
                                            <span class="nvc-requirement-text nvc-wcag-medium-contrast">Contains uppercase letter (A-Z)</span>
                                        </div>
                                        <div class="nvc-requirement" id="lowercaseReq">
                                            <i class="fas fa-times nvc-requirement-icon" aria-hidden="true"></i>
                                            <span class="nvc-requirement-text nvc-wcag-medium-contrast">Contains lowercase letter (a-z)</span>
                                        </div>
                                        <div class="nvc-requirement" id="numberReq">
                                            <i class="fas fa-times nvc-requirement-icon" aria-hidden="true"></i>
                                            <span class="nvc-requirement-text nvc-wcag-medium-contrast">Contains number (0-9)</span>
                                        </div>
                                        <div class="nvc-requirement" id="specialReq">
                                            <i class="fas fa-times nvc-requirement-icon" aria-hidden="true"></i>
                                            <span class="nvc-requirement-text nvc-wcag-medium-contrast">Contains special character (!@#$%^&*)</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Security Options -->
                                <div class="nvc-security-options">
                                    <h3 class="nvc-security-title nvc-wcag-high-contrast">
                                        <i class="fas fa-cog" aria-hidden="true"></i>
                                        Security Options
                                    </h3>
                                    <div class="nvc-security-list">
                                        <div class="nvc-checkbox-group">
                                            <input type="checkbox"
                                                   class="nvc-checkbox nvc-wcag-focus"
                                                   id="logoutAllDevices"
                                                   name="logoutAllDevices"
                                                   checked>
                                            <label class="nvc-checkbox-label nvc-wcag-high-contrast" for="logoutAllDevices">
                                                <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                                                Log out all other devices after password reset
                                            </label>
                                        </div>

                                        <div class="nvc-checkbox-group">
                                            <input type="checkbox"
                                                   class="nvc-checkbox nvc-wcag-focus"
                                                   id="enableMFA"
                                                   name="enableMFA">
                                            <label class="nvc-checkbox-label nvc-wcag-high-contrast" for="enableMFA">
                                                <i class="fas fa-shield-alt" aria-hidden="true"></i>
                                                Enable two-factor authentication for enhanced security
                                            </label>
                                        </div>

                                        <div class="nvc-checkbox-group">
                                            <input type="checkbox"
                                                   class="nvc-checkbox nvc-wcag-focus"
                                                   id="emailNotification"
                                                   name="emailNotification"
                                                   checked>
                                            <label class="nvc-checkbox-label nvc-wcag-high-contrast" for="emailNotification">
                                                <i class="fas fa-envelope" aria-hidden="true"></i>
                                                Send email confirmation of password change
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- FINRA Compliance Notice -->
                                <div class="nvc-compliance-notice">
                                    <div class="nvc-compliance-header">
                                        <i class="fas fa-balance-scale" aria-hidden="true"></i>
                                        <h4 class="nvc-compliance-title nvc-wcag-high-contrast">Regulatory Compliance</h4>
                                    </div>
                                    <div class="nvc-compliance-content">
                                        <p class="nvc-compliance-text nvc-wcag-medium-contrast">
                                            This password change will be logged for FINRA compliance and audit purposes.
                                            All security events are monitored and recorded in accordance with financial industry regulations.
                                        </p>
                                        <div class="nvc-compliance-features">
                                            <div class="nvc-compliance-item">
                                                <i class="fas fa-file-alt" aria-hidden="true"></i>
                                                <span class="nvc-wcag-medium-contrast">Audit Trail Maintained</span>
                                            </div>
                                            <div class="nvc-compliance-item">
                                                <i class="fas fa-clock" aria-hidden="true"></i>
                                                <span class="nvc-wcag-medium-contrast">Timestamp Recorded</span>
                                            </div>
                                            <div class="nvc-compliance-item">
                                                <i class="fas fa-shield-check" aria-hidden="true"></i>
                                                <span class="nvc-wcag-medium-contrast">Secure Encryption</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="nvc-form-actions">
                                    <div class="nvc-action-buttons">
                                        <a href="{{ url_for('auth.login') if url_for else '/auth/login' }}"
                                           class="nvc-btn nvc-btn-outline nvc-wcag-focus">
                                            <i class="fas fa-arrow-left" aria-hidden="true"></i>
                                            Back to Login
                                        </a>

                                        <button type="button"
                                                class="nvc-btn nvc-btn-secondary nvc-wcag-focus"
                                                id="generatePassword">
                                            <i class="fas fa-random" aria-hidden="true"></i>
                                            Generate Secure Password
                                        </button>

                                        <button type="submit"
                                                class="nvc-btn nvc-btn-primary nvc-wcag-focus"
                                                id="resetPasswordBtn">
                                            <i class="fas fa-check" aria-hidden="true"></i>
                                            Reset Password
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- FINRA-Compliant Transaction Table for Password Reset Events -->
<section class="nvc-transaction-section">
    <div class="nvc-container">
        <div class="nvc-transaction-header">
            <h2 class="nvc-section-title nvc-wcag-high-contrast">
                <i class="fas fa-history" aria-hidden="true"></i>
                Recent Security Events
            </h2>
            <p class="nvc-section-subtitle nvc-wcag-medium-contrast">
                FINRA-compliant audit trail of password and security changes
            </p>
        </div>

        <div class="nvc-transaction-table-container">
            <table class="nvc-transaction-table" role="table" aria-label="Security events audit trail">
                <thead>
                    <tr>
                        <th scope="col" class="nvc-wcag-high-contrast">Date/Time</th>
                        <th scope="col" class="nvc-wcag-high-contrast">Event Type</th>
                        <th scope="col" class="nvc-wcag-high-contrast">IP Address</th>
                        <th scope="col" class="nvc-wcag-high-contrast">Device</th>
                        <th scope="col" class="nvc-wcag-high-contrast">Status</th>
                        <th scope="col" class="nvc-wcag-high-contrast">Compliance ID</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="nvc-transaction-row">
                        <td class="nvc-wcag-medium-contrast">{{ moment().format('YYYY-MM-DD HH:mm:ss') if moment else '2024-07-28 14:30:15' }}</td>
                        <td>
                            <span class="nvc-event-type nvc-event-password-reset">
                                <i class="fas fa-key" aria-hidden="true"></i>
                                Password Reset Request
                            </span>
                        </td>
                        <td class="nvc-wcag-medium-contrast">{{ request.remote_addr if request else '192.168.1.100' }}</td>
                        <td class="nvc-wcag-medium-contrast">{{ request.user_agent.platform if request and request.user_agent else 'Desktop' }}</td>
                        <td>
                            <span class="nvc-status nvc-status-pending">
                                <i class="fas fa-clock" aria-hidden="true"></i>
                                Pending
                            </span>
                        </td>
                        <td class="nvc-compliance-id nvc-wcag-medium-contrast">PWD-{{ moment().format('YYYYMMDD') if moment else '20240728' }}-{{ range(1000, 9999) | random if range else '1234' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- Enhanced JavaScript for Password Reset -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordField = document.getElementById('newPassword');
    const confirmField = document.getElementById('confirmPassword');
    const strengthBar = document.getElementById('passwordStrengthBar');
    const strengthText = document.getElementById('passwordStrengthText');
    const requirements = {
        length: document.getElementById('lengthReq'),
        uppercase: document.getElementById('uppercaseReq'),
        lowercase: document.getElementById('lowercaseReq'),
        number: document.getElementById('numberReq'),
        special: document.getElementById('specialReq')
    };

    // Password strength checking
    function checkPasswordStrength(password) {
        let score = 0;
        const checks = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };

        // Update requirement indicators
        Object.keys(checks).forEach(key => {
            const req = requirements[key];
            const icon = req.querySelector('.nvc-requirement-icon');
            if (checks[key]) {
                score++;
                icon.className = 'fas fa-check nvc-requirement-icon nvc-requirement-met';
                req.classList.add('nvc-requirement-satisfied');
            } else {
                icon.className = 'fas fa-times nvc-requirement-icon';
                req.classList.remove('nvc-requirement-satisfied');
            }
        });

        // Update strength bar and text
        const percentage = (score / 5) * 100;
        strengthBar.style.width = percentage + '%';

        let strengthLevel = 'Weak';
        let strengthClass = 'nvc-strength-weak';

        if (score >= 5) {
            strengthLevel = 'Very Strong';
            strengthClass = 'nvc-strength-very-strong';
        } else if (score >= 4) {
            strengthLevel = 'Strong';
            strengthClass = 'nvc-strength-strong';
        } else if (score >= 3) {
            strengthLevel = 'Medium';
            strengthClass = 'nvc-strength-medium';
        } else if (score >= 2) {
            strengthLevel = 'Fair';
            strengthClass = 'nvc-strength-fair';
        }

        strengthBar.className = 'nvc-strength-fill ' + strengthClass;
        strengthText.textContent = strengthLevel;
    }

    // Password matching
    function checkPasswordMatch() {
        const match = passwordField.value === confirmField.value && passwordField.value.length > 0;
        const indicator = document.getElementById('password-match');

        if (confirmField.value.length > 0) {
            if (match) {
                indicator.innerHTML = '<i class="fas fa-check" aria-hidden="true"></i>';
                indicator.className = 'nvc-match-indicator nvc-match-success';
            } else {
                indicator.innerHTML = '<i class="fas fa-times" aria-hidden="true"></i>';
                indicator.className = 'nvc-match-indicator nvc-match-error';
            }
        } else {
            indicator.innerHTML = '';
            indicator.className = 'nvc-match-indicator';
        }
    }

    // Event listeners
    passwordField.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        checkPasswordMatch();
    });

    confirmField.addEventListener('input', checkPasswordMatch);

    // Password visibility toggles
    document.querySelectorAll('.nvc-password-toggle').forEach(toggle => {
        toggle.addEventListener('click', function() {
            const input = this.parentElement.querySelector('input');
            const icon = this.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
                this.setAttribute('aria-label', 'Hide password');
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
                this.setAttribute('aria-label', 'Show password');
            }
        });
    });

    // Generate secure password
    document.getElementById('generatePassword').addEventListener('click', function() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
        let password = '';

        // Ensure at least one of each required character type
        password += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[Math.floor(Math.random() * 26)];
        password += 'abcdefghijklmnopqrstuvwxyz'[Math.floor(Math.random() * 26)];
        password += '0123456789'[Math.floor(Math.random() * 10)];
        password += '!@#$%^&*'[Math.floor(Math.random() * 8)];

        // Fill remaining characters
        for (let i = 4; i < 12; i++) {
            password += chars[Math.floor(Math.random() * chars.length)];
        }

        // Shuffle the password
        password = password.split('').sort(() => Math.random() - 0.5).join('');

        passwordField.value = password;
        confirmField.value = password;
        checkPasswordStrength(password);
        checkPasswordMatch();
    });

    // Form submission
    document.querySelector('.nvc-auth-form-container').addEventListener('submit', function(e) {
        e.preventDefault();

        // Validate password strength
        const password = passwordField.value;
        const confirmPassword = confirmField.value;

        if (password !== confirmPassword) {
            alert('Passwords do not match. Please try again.');
            return;
        }

        if (password.length < 8) {
            alert('Password must be at least 8 characters long.');
            return;
        }

        // Show loading state
        const submitBtn = document.getElementById('resetPasswordBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin" aria-hidden="true"></i> Resetting Password...';
        submitBtn.disabled = true;

        // Simulate form submission (replace with actual submission)
        setTimeout(() => {
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;

            // Show success message (replace with actual success handling)
            alert('Password reset successfully! You will be redirected to login.');
        }, 2000);
    });
});
</script>
{% endblock %}