{% extends "unified_base.html" %}
{% from "components/nvc_components.html" import metric_card, action_card, account_card, transaction_row, form_input, form_select, notification_banner, progress_bar, stats_grid, loading_spinner, empty_state %}
{% from "components/unified_card_system.html" import metric_card_standard, action_card_standard, content_card_standard, account_card_standard, transaction_row_standard, stats_grid_standard, quick_actions_grid_standard, notification_banner_standard, progress_bar_standard, loading_spinner_standard, empty_state_standard, form_input_standard, form_select_standard %}


{% block title %}Pending Loan Applications - NVC Banking Platform{% endblock %}

{% block page_title %}Pending Loan Applications{% endblock %}
{% block page_description %}Review and manage pending loan applications with comprehensive evaluation tools{% endblock %}

{% block page_actions %}
<button type="button" class="nvc-btn nvc-btn-outline-enterprise" data-action="custom-action">
    <i class="fas fa-download"></i>
    Export Applications
</button>
<button type="button" class="nvc-btn nvc-btn-primary-enterprise" data-action="navigate">
    <i class="fas fa-plus"></i>
    New Application
</button>
{% endblock %}

{% block content %}
<div class="nvc-page-content">
    <div class="enterprise-dashboard-container">
    <!-- Applications Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="enterprise-metric-nvc-card">
                <div class="metric-icon bg-warning">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-content">
                    <h3>{{ applications_data.pending_count }}</h3>
                    <p>Pending Applications</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="enterprise-metric-nvc-card">
                <div class="metric-icon bg-info">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="metric-content">
                    <h3>{{ applications_data.applications|length }}</h3>
                    <p>Total Applications</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="enterprise-metric-nvc-card">
                <div class="metric-icon bg-success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="metric-content">
                    <h3>85%</h3>
                    <p>Approval Rate</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="enterprise-metric-nvc-card">
                <div class="metric-icon bg-primary">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="metric-content">
                    <h3>$2.5M</h3>
                    <p>Total Amount</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Applications Table -->
    <div class="enterprise-nvc-card">
        <div class="nvc-nvc-card-header">
            <h5><i class="fas fa-list"></i> Pending Applications</h5>
        </div>
        <div class="nvc-nvc-card-body">
            <div class="table-responsive">
                <table class="table table-hover enterprise-table">
                    <thead>
                        <tr>
                            <th>Application ID</th>
                            <th>Applicant</th>
                            <th>Loan Type</th>
                            <th>Amount</th>
                            <th>Submitted</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for app in applications_data.applications %}
                        <tr class="application-row" data-app-id="{{ app.id }}">
                            <td><strong>{{ app.id }}</strong></td>
                            <td>{{ app.applicant }}</td>
                            <td>{{ app.type }}</td>
                            <td>${{ "{:,.2f}".format(app.amount) }}</td>
                            <td>{{ app.submitted }}</td>
                            <td>
                                <span class="badge badge-warning">{{ app.status }}</span>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm nvc-btn nvc-btn-primary" data-action="custom-action">
                                    <i class="fas fa-eye"></i> Review
                                </button>
                                <button type="button" class="btn btn-sm nvc-btn nvc-btn-success" data-action="custom-action">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced Applications Management with Security
document.addEventListener('DOMContentLoaded', function() {
    // Add drilldown functionality for application metric cards
    const appCards = document.querySelectorAll('.enterprise-metric-card');
    appCards.forEach(card => {
        card.style.cursor = 'pointer';
        card.addEventListener('click', function() {
            const cardTitle = this.querySelector('h3').nextElementSibling.textContent;
            handleApplicationsDrilldown(cardTitle);
        });
    });

    // Add row click functionality for application table
    const appRows = document.querySelectorAll('.application-row');
    appRows.forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', function() {
            const appId = this.getAttribute('data-app-id');
            if (appId) {
                reviewApplication(appId);
            }
        });
    });
});

function handleApplicationsDrilldown(cardTitle) {
    const baseUrl = "{{ url_for('loans.pending_applications') }}";
    let url = baseUrl;

    if (cardTitle.includes('Pending Applications')) {
        url += '?filter=status:pending&view=detailed';
    } else if (cardTitle.includes('Total Applications')) {
        url += '?view=all&sort=submitted:desc';
    } else if (cardTitle.includes('Total Amount')) {
        url += '?sort=amount:desc&view=financial';
    }

    window.location.href = url;
}

function exportApplicationsData() {
    // Secure export with CSRF protection
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{{ url_for('loans.export_applications') }}";

    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrf_token';
    csrfToken.value = "{{ csrf_token() }}";
    form.appendChild(csrfToken);

    const exportType = document.createElement('input');
    exportType.type = 'hidden';
    exportType.name = 'export_type';
    exportType.value = 'pending_applications';
    form.appendChild(exportType);

    const timestamp = document.createElement('input');
    timestamp.type = 'hidden';
    timestamp.name = 'timestamp';
    timestamp.value = new Date().toISOString();
    form.appendChild(timestamp);

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

function reviewApplication(appId) {
    // Navigate to detailed application review
    window.location.href = `{{ url_for('loans.review_application') }}/${encodeURIComponent(appId)}?view=comprehensive`;
}

function approveApplication(appId) {
    // Secure application approval
    if (confirm('Are you sure you want to approve this application?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('loans.approve_application') }}";

        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrf_token';
        csrfToken.value = "{{ csrf_token() }}";
        form.appendChild(csrfToken);

        const appIdInput = document.createElement('input');
        appIdInput.type = 'hidden';
        appIdInput.name = 'application_id';
        appIdInput.value = appId;
        form.appendChild(appIdInput);

        const action = document.createElement('input');
        action.type = 'hidden';
        action.name = 'action';
        action.value = 'approve';
        form.appendChild(action);

        const timestamp = document.createElement('input');
        timestamp.type = 'hidden';
        timestamp.name = 'timestamp';
        timestamp.value = new Date().toISOString();
        form.appendChild(timestamp);

        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }
}

function rejectApplication(appId) {
    const reason = prompt('Please provide a reason for rejection:');
    if (reason && reason.trim()) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('loans.reject_application') }}";

        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrf_token';
        csrfToken.value = "{{ csrf_token() }}";
        form.appendChild(csrfToken);

        const appIdInput = document.createElement('input');
        appIdInput.type = 'hidden';
        appIdInput.name = 'application_id';
        appIdInput.value = appId;
        form.appendChild(appIdInput);

        const reasonInput = document.createElement('input');
        reasonInput.type = 'hidden';
        reasonInput.name = 'rejection_reason';
        reasonInput.value = reason;
        form.appendChild(reasonInput);

        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }
}
</script>

<style>
.application-row {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.application-row:hover {
    background-color: rgba(0,123,255,0.05);
}

.enterprise-metric-card {
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.enterprise-metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
</style>
</div>
{% endblock %}
