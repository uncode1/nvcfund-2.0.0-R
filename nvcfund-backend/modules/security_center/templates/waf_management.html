{% extends "unified_base.html" %}
{% from "components/nvc_components.html" import metric_card, action_card, account_card, transaction_row, form_input, form_select, notification_banner, progress_bar, stats_grid, loading_spinner, empty_state %}


{% block title %}WAF Management - NVC Banking Platform{% endblock %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<style>
    .waf-management {
        background: linear-gradient(135deg, #0a2447 0%, #1a365d 100%);
        min-height: 100vh;
        color: #ffffff;
        padding: 20px;
    }
    
    .waf-header {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .waf-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .status-card {
        background: rgba(255,255,255,0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .status-card:hover {
        background: rgba(255,255,255,0.15);
        transform: translateY(-3px);
    }
    
    .status-active { border-left: 4px solid #00ff88; }
    .status-warning { border-left: 4px solid #ffaa00; }
    .status-critical { border-left: 4px solid #ff4444; }
    .status-blocked { border-left: 4px solid #ff0000; }
    
    .status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .status-title {
        font-size: 1.1rem;
        font-weight: bold;
    }
    
    .status-value {
        font-size: 2rem;
        font-weight: bold;
        color: #66ccff;
    }
    
    .value-good { color: #00ff88; }
    .value-warning { color: #ffaa00; }
    .value-critical { color: #ff4444; }
    
    .status-description {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-top: 10px;
    }
    
    .waf-charts {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }
    
    .chart-container {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .rule-management {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 30px;
    }
    
    .rule-actions {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .rules-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .rules-table th,
    .rules-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .rules-table th {
        background: rgba(255,255,255,0.1);
        font-weight: bold;
        color: #66ccff;
        position: sticky;
        top: 0;
    }
    
    .rule-row {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .rule-row:hover {
        background: rgba(255,255,255,0.05);
    }
    
    .rule-status-badge {
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .status-enabled { background: #00ff88; color: #000; }
    .status-disabled { background: #90a4ae; color: #fff; }
    .status-testing { background: #ffaa00; color: #000; }
    .status-error { background: #ff4444; color: #fff; }
    
    .rule-type-badge {
        padding: 3px 6px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: bold;
    }
    
    .type-security { background: #ff6b6b; color: #fff; }
    .type-rate-limit { background: #4ecdc4; color: #000; }
    .type-geo-block { background: #45b7d1; color: #fff; }
    .type-custom { background: #96ceb4; color: #000; }
    .type-owasp { background: #feca57; color: #000; }
    
    .priority-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .priority-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    
    .priority-critical { background: #ff0000; }
    .priority-high { background: #ff4444; }
    .priority-medium { background: #ffaa00; }
    .priority-low { background: #66ccff; }
    
    .blocked-requests {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 30px;
    }
    
    .blocked-item {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .blocked-sql-injection { border-left-color: #ff0000; }
    .blocked-xss { border-left-color: #ff4444; }
    .blocked-rate-limit { border-left-color: #ffaa00; }
    .blocked-geo { border-left-color: #66ccff; }
    .blocked-bot { border-left-color: #9966ff; }
    
    .blocked-info {
        flex: 1;
    }
    
    .blocked-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .blocked-details {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 5px;
    }
    
    .blocked-meta {
        font-size: 0.8rem;
        opacity: 0.7;
    }
    
    .threat-score {
        background: rgba(255,255,255,0.1);
        padding: 8px 12px;
        border-radius: 8px;
        text-align: center;
        min-width: 60px;
        margin-left: 15px;
    }
    
    .score-critical { background: #ff4444; color: #fff; }
    .score-high { background: #ff6666; color: #fff; }
    .score-medium { background: #ffaa00; color: #000; }
    .score-low { background: #00ff88; color: #000; }
    
    .action-btn {
        background: #66ccff;
        color: #0a2447;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .action-btn:hover {
        background: #4db8ff;
        transform: scale(1.05);
    }
    
    .action-btn.danger {
        background: #ff4444;
        color: #fff;
    }
    
    .action-btn.success {
        background: #4caf50;
        color: #fff;
    }
    
    .action-btn.warning {
        background: #ffaa00;
        color: #000;
    }
    
    .filters-section {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-input,
    .filter-select {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        padding: 8px;
        color: #fff;
        min-width: 150px;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
    }
    
    .modal-content {
        background: linear-gradient(135deg, #0a2447 0%, #1a365d 100%);
        margin: 3% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 800px;
        border: 1px solid rgba(255,255,255,0.2);
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: #fff;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #66ccff;
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        background: rgba(255,255,255,0.1);
        color: #fff;
        font-size: 14px;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #66ccff;
        box-shadow: 0 0 5px rgba(102, 204, 255, 0.5);
    }
    
    .realtime-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }
    
    .realtime-dot {
        width: 8px;
        height: 8px;
        background: #00ff88;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="nvc-page-content">
    <div class="waf-management">
    <!-- WAF Header -->
    <div class="waf-header">
        <div>
            <h1><i class="fas fa-shield-alt"></i> Web Application Firewall Management</h1>
            <p>Comprehensive WAF rule management with real-time threat protection and analytics</p>
        </div>
        <div class="realtime-indicator">
            <span class="realtime-dot"></span>
            <span>Live Protection</span>
        </div>
    </div>

    <!-- WAF Status Overview -->
    <div class="waf-status-grid">
        <div class="status-nvc-card status-active" data-action="custom-action">
            <div class="status-header">
                <div class="status-title">Protection Status</div>
                <i class="fas fa-shield-check nvc-colored-1aebf3" ></i>
            </div>
            <div class="status-value value-good" id="protection-status">ACTIVE</div>
            <div class="status-description">All WAF modules operational with 99.7% uptime</div>
        </div>
        
        <div class="status-nvc-card status-warning" data-action="custom-action">
            <div class="status-header">
                <div class="status-title">Requests Blocked (24h)</div>
                <i class="fas fa-ban" style="color: #ffaa00; font-size: 1.5rem;"></i>
            </div>
            <div class="status-value value-warning" id="blocked-requests">{{ waf_data.blocked_requests or 15847 }}</div>
            <div class="status-description">↑ 23% increase from yesterday</div>
        </div>
        
        <div class="status-nvc-card status-active" data-action="custom-action">
            <div class="status-header">
                <div class="status-title">Active Rules</div>
                <i class="fas fa-list-check nvc-colored-3d9145" ></i>
            </div>
            <div class="status-value" id="active-rules">{{ waf_data.active_rules or 247 }}</div>
            <div class="status-description">12 custom + 235 OWASP rules</div>
        </div>
        
        <div class="status-nvc-card status-critical" data-action="custom-action">
            <div class="status-header">
                <div class="status-title">False Positives</div>
                <i class="fas fa-exclamation-triangle" style="color: #ff4444; font-size: 1.5rem;"></i>
            </div>
            <div class="status-value value-critical" id="false-positives">{{ waf_data.false_positives or 3 }}</div>
            <div class="status-description">Requires immediate attention</div>
        </div>
        
        <div class="status-nvc-card status-active" data-action="custom-action">
            <div class="status-header">
                <div class="status-title">Bandwidth Saved</div>
                <i class="fas fa-tachometer-alt nvc-colored-1aebf3" ></i>
            </div>
            <div class="status-value value-good" id="bandwidth-saved">{{ waf_data.bandwidth_saved or '2.3 TB' }}</div>
            <div class="status-description">Malicious traffic blocked this month</div>
        </div>
        
        <div class="status-nvc-card status-active" data-action="custom-action">
            <div class="status-header">
                <div class="status-title">Avg Response Time</div>
                <i class="fas fa-clock nvc-colored-3d9145" ></i>
            </div>
            <div class="status-value" id="response-time">{{ waf_data.response_time or '1.2ms' }}</div>
            <div class="status-description">Minimal performance impact</div>
        </div>
    </div>

    <!-- WAF Analytics Charts -->
    <div class="waf-charts">
        <div class="chart-container">
            <h3><i class="fas fa-chart-line"></i> Threat Blocking Trends</h3>
            <canvas id="threatBlockingChart" width="400" height="300"></canvas>
        </div>
        
        <div class="chart-container">
            <h3><i class="fas fa-chart-pie"></i> Attack Types Distribution</h3>
            <canvas id="attackTypesChart" width="400" height="300"></canvas>
        </div>
    </div>

    <!-- Recent Blocked Requests -->
    <div class="blocked-requests">
        <h3><i class="fas fa-ban"></i> Recent Blocked Requests</h3>
        <div id="blocked-requests-container">
            {% set blocked_data = [
                {
                    'type': 'SQL Injection',
                    'class': 'sql-injection',
                    'ip': '185.220.101.47',
                    'country': 'Russia',
                    'payload': "' UNION SELECT * FROM users--",
                    'rule': 'OWASP-942-100',
                    'time': '2 min ago',
                    'score': 'critical'
                },
                {
                    'type': 'XSS Attempt',
                    'class': 'xss',
                    'ip': '103.85.24.156',
                    'country': 'China',
                    'payload': '<script>alert("xss")</script>',
                    'rule': 'OWASP-941-110',
                    'time': '5 min ago',
                    'score': 'high'
                },
                {
                    'type': 'Rate Limit Exceeded',
                    'class': 'rate-limit',
                    'ip': '198.23.145.78',
                    'country': 'USA',
                    'payload': '1247 requests in 60 seconds',
                    'rule': 'RATE-LIMIT-001',
                    'time': '8 min ago',
                    'score': 'medium'
                },
                {
                    'type': 'Geo-blocked Access',
                    'class': 'geo',
                    'ip': '91.203.67.123',
                    'country': 'Romania',
                    'payload': 'Access from blocked region',
                    'rule': 'GEO-BLOCK-001',
                    'time': '12 min ago',
                    'score': 'low'
                },
                {
                    'type': 'Bot Detection',
                    'class': 'bot',
                    'ip': '45.142.214.98',
                    'country': 'Netherlands',
                    'payload': 'Automated scanner detected',
                    'rule': 'BOT-DETECT-001',
                    'time': '15 min ago',
                    'score': 'medium'
                }
            ] %}
            
            {% for block in blocked_data %}
            <div class="blocked-item blocked-{{ block.class }}">
                <div class="blocked-info">
                    <div class="blocked-title">{{ block.type }}</div>
                    <div class="blocked-details">
                        <strong>Source:</strong> {{ block.ip }} ({{ block.country }}) • 
                        <strong>Rule:</strong> {{ block.rule }}
                    </div>
                    <div class="blocked-meta">
                        <strong>Payload:</strong> <code>{{ block.payload }}</code> • {{ block.time }}
                    </div>
                </div>
                <div class="threat-score score-{{ block.score }}">
                    {{ block.score.upper() }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- WAF Rule Management -->
    <div class="rule-management">
        <div class="filters-section">
            <input type="text" class="filter-input" id="rule-search" placeholder="Search rules by name, ID, or description...">
            <select class="filter-select" id="rule-type-filter">
                <option value="">All Rule Types</option>
                <option value="security">Security Rules</option>
                <option value="rate-limit">Rate Limiting</option>
                <option value="geo-block">Geo Blocking</option>
                <option value="custom">Custom Rules</option>
                <option value="owasp">OWASP Core Rules</option>
            </select>
            <select class="filter-select" id="rule-status-filter">
                <option value="">All Statuses</option>
                <option value="enabled">Enabled</option>
                <option value="disabled">Disabled</option>
                <option value="testing">Testing</option>
                <option value="error">Error</option>
            </select>
            <select class="filter-select" id="priority-filter">
                <option value="">All Priorities</option>
                <option value="critical">Critical</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>
        </div>
        
        <div class="rule-actions">
            <button type="button" class="action-btn success" data-action="custom-action">
                <i class="fas fa-plus"></i> Create Rule
            </button>
            <button type="button" class="action-btn" data-action="custom-action">
                <i class="fas fa-upload"></i> Import Rules
            </button>
            <button type="button" class="action-btn" data-action="custom-action">
                <i class="fas fa-download"></i> Export Rules
            </button>
            <button type="button" class="action-btn warning" data-action="custom-action">
                <i class="fas fa-vial"></i> Test All Rules
            </button>
            <button type="button" class="action-btn" data-action="custom-action">
                <i class="fas fa-sync"></i> Refresh
            </button>
            <button type="button" class="action-btn danger" data-action="custom-action">
                <i class="fas fa-power-off"></i> Emergency Disable
            </button>
        </div>

        <h3><i class="fas fa-cogs"></i> WAF Rule Configuration</h3>
        <table class="rules-table">
            <thead>
                <tr>
                    <th>Rule ID</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Matches (24h)</th>
                    <th>False Positives</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="rules-table-body">
                {% if waf_data.rules %}
                    {% for rule in waf_data.rules %}
                    <tr class="rule-row" data-rule-id="{{ rule.id }}" data-action="custom-action">
                        <td><code>{{ rule.rule_id }}</code></td>
                        <td>{{ rule.name }}</td>
                        <td><span class="rule-type-badge type-{{ rule.type.lower().replace(' ', '-') }}">{{ rule.type }}</span></td>
                        <td><span class="rule-status-badge status-{{ rule.status.lower() }}">{{ rule.status }}</span></td>
                        <td>
                            <div class="priority-indicator">
                                <div class="priority-dot priority-{{ rule.priority.lower() }}"></div>
                                <span>{{ rule.priority }}</span>
                            </div>
                        </td>
                        <td>{{ rule.matches }}</td>
                        <td>{{ rule.false_positives }}</td>
                        <td data-action="custom-action">
                            <div class="nvc-flex-9d6126">
                                <button type="button" class="action-btn" data-action="custom-action" title="Edit Rule">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="action-btn warning" data-action="custom-action" title="Test Rule">
                                    <i class="fas fa-vial"></i>
                                </button>
                                <button type="button" class="action-btn" data-action="custom-action" title="Toggle Status">
                                    <i class="fas fa-power-off"></i>
                                </button>
                                <button type="button" class="action-btn danger" data-action="custom-action" title="Delete Rule">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="nvc-center-spaced-854720">
                            No WAF rules configured
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Rule Creation/Edit Modal -->
<div id="ruleModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modal-title"><i class="fas fa-plus"></i> Create New WAF Rule</h2>
        <form id="rule-form">
            <div class="form-group">
                <label for="rule-name">Rule Name</label>
                <input type="text" id="rule-name" class="nvc-form-input" placeholder="Enter descriptive rule name" required>
            </div>
            
            <div class="form-group">
                <label for="rule-type">Rule Type</label>
                <select id="rule-type" class="nvc-form-input" required>
                    <option value="">Select rule type</option>
                    <option value="security">Security Rule</option>
                    <option value="rate-limit">Rate Limiting</option>
                    <option value="geo-block">Geographic Blocking</option>
                    <option value="custom">Custom Rule</option>
                    <option value="owasp">OWASP Core Rule</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="rule-priority">Priority</label>
                <select id="rule-priority" class="nvc-form-input" required>
                    <option value="">Select priority</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="rule-action">Action</label>
                <select id="rule-action" class="nvc-form-input" required>
                    <option value="">Select action</option>
                    <option value="block">Block Request</option>
                    <option value="challenge">Challenge (CAPTCHA)</option>
                    <option value="rate-limit">Rate Limit</option>
                    <option value="log">Log Only</option>
                    <option value="redirect">Redirect</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="rule-pattern">Pattern/Condition</label>
                <textarea id="rule-pattern" class="nvc-form-input" rows="4" placeholder="Enter rule pattern, regex, or condition logic" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="rule-description">Description</label>
                <textarea id="rule-description" class="nvc-form-input" rows="3" placeholder="Describe what this rule does and when it triggers"></textarea>
            </div>
            
            <div class="form-group">
                <label for="rule-enabled">
                    <input type="checkbox" id="rule-enabled" checked> Enable rule immediately
                </label>
            </div>
            
            <div class="nvc-flex-spaced-813fba">
                <button type="button" class="action-btn" data-action="custom-action">Cancel</button>
                <button type="button" class="action-btn warning" data-action="custom-action">Test Rule</button>
                <button type="submit" class="action-btn success">Save Rule</button>
            </div>
        </form>
    </div>
</div>

<script>
// Socket.IO connection for real-time WAF data
const socket = io('/security-center');

// Chart instances
let threatBlockingChart, attackTypesChart;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setupEventListeners();
    
    // Connect to socket for real-time updates
    if (socket.connected) {
        socket.emit('request_waf_data');
    }
});

// Socket event handlers
socket.on('connect', function() {
    console.log('Connected to security center socket for WAF management');
    socket.emit('request_waf_data');
});

socket.on('waf_threat_blocked', function(threat) {
    addBlockedRequestToList(threat);
    updateWAFMetrics();
});

socket.on('waf_rule_triggered', function(data) {
    updateRuleMetrics(data.rule_id, data.matches, data.false_positives);
});

socket.on('waf_metrics_update', function(metrics) {
    updateWAFDashboard(metrics);
});

socket.on('waf_trends_update', function(data) {
    updateThreatBlockingChart(data);
});

// Initialize charts
function initializeCharts() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: { color: '#ffffff' }
            }
        },
        scales: {
            x: {
                ticks: { color: '#ffffff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
                ticks: { color: '#ffffff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    };

    // Threat Blocking Trends Chart
    const trendsCtx = document.getElementById('threatBlockingChart').getContext('2d');
    threatBlockingChart = new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Blocked Requests',
                    data: [],
                    borderColor: '#ff4444',
                    backgroundColor: 'rgba(255, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'False Positives',
                    data: [],
                    borderColor: '#ffaa00',
                    backgroundColor: 'rgba(255, 170, 0, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: chartOptions
    });

    // Attack Types Distribution Chart
    const typesCtx = document.getElementById('attackTypesChart').getContext('2d');
    attackTypesChart = new Chart(typesCtx, {
        type: 'doughnut',
        data: {
            labels: ['SQL Injection', 'XSS', 'Rate Limiting', 'Geo-blocking', 'Bot Detection', 'Other'],
            datasets: [{
                data: [35, 25, 15, 12, 8, 5],
                backgroundColor: [
                    '#ff0000',
                    '#ff4444',
                    '#ffaa00',
                    '#66ccff',
                    '#9966ff',
                    '#ff9966'
                ],
                borderWidth: 2,
                borderColor: '#0a2447'
            }]
        },
        options: {
            ...chartOptions,
            scales: {} // Remove scales for doughnut chart
        }
    });
}

// Setup event listeners
function setupEventListeners() {
    // Search and filter inputs
    document.getElementById('rule-search').addEventListener('input', filterRules);
    document.getElementById('rule-type-filter').addEventListener('change', filterRules);
    document.getElementById('rule-status-filter').addEventListener('change', filterRules);
    document.getElementById('priority-filter').addEventListener('change', filterRules);
    
    // Modal close events
    document.querySelector('.close').addEventListener('click', closeModal);
    window.addEventListener('click', function(e) {
        const modal = document.getElementById('ruleModal');
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // Form submission
    document.getElementById('rule-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveRule();
    });
}

// Update functions
function updateThreatBlockingChart(data) {
    if (threatBlockingChart && data.labels) {
        threatBlockingChart.data.labels = data.labels;
        threatBlockingChart.data.datasets[0].data = data.blocked || [];
        threatBlockingChart.data.datasets[1].data = data.false_positives || [];
        threatBlockingChart.update('none');
    }
}

function updateWAFDashboard(metrics) {
    document.getElementById('blocked-requests').textContent = metrics.blocked_requests || 0;
    document.getElementById('active-rules').textContent = metrics.active_rules || 0;
    document.getElementById('false-positives').textContent = metrics.false_positives || 0;
    document.getElementById('bandwidth-saved').textContent = metrics.bandwidth_saved || '0 GB';
    document.getElementById('response-time').textContent = metrics.response_time || '0ms';
}

function addBlockedRequestToList(threat) {
    const container = document.getElementById('blocked-requests-container');
    const item = document.createElement('div');
    item.className = `blocked-item blocked-${threat.type.toLowerCase().replace(' ', '-')}`;
    item.innerHTML = `
        <div class="blocked-info">
            <div class="blocked-title">${threat.type}</div>
            <div class="blocked-details">
                <strong>Source:</strong> ${threat.ip} (${threat.country}) • 
                <strong>Rule:</strong> ${threat.rule}
            </div>
            <div class="blocked-meta">
                <strong>Payload:</strong> <code>${threat.payload}</code> • ${threat.time}
            </div>
        </div>
        <div class="threat-score score-${threat.score}">
            ${threat.score.toUpperCase()}
        </div>
    `;
    
    container.insertBefore(item, container.firstChild);
    
    // Keep only latest 10 blocked requests
    while (container.children.length > 10) {
        container.removeChild(container.lastChild);
    }
}

// Rule management functions
function createRule() {
    document.getElementById('modal-title').innerHTML = '<i class="fas fa-plus"></i> Create New WAF Rule';
    document.getElementById('rule-form').reset();
    document.getElementById('ruleModal').style.display = 'block';
}

function editRule(ruleId) {
    document.getElementById('modal-title').innerHTML = '<i class="fas fa-edit"></i> Edit WAF Rule';
    
    // Fetch rule data and populate form
    fetch(`/security/api/waf/rules/${ruleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const rule = data.rule;
                document.getElementById('rule-name').value = rule.name;
                document.getElementById('rule-type').value = rule.type;
                document.getElementById('rule-priority').value = rule.priority;
                document.getElementById('rule-action').value = rule.action;
                document.getElementById('rule-pattern').value = rule.pattern;
                document.getElementById('rule-description').value = rule.description;
                document.getElementById('rule-enabled').checked = rule.enabled;
                
                document.getElementById('ruleModal').style.display = 'block';
            } else {
                alert('Error loading rule: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading rule');
        });
}

function saveRule() {
    const formData = {
        name: document.getElementById('rule-name').value,
        type: document.getElementById('rule-type').value,
        priority: document.getElementById('rule-priority').value,
        action: document.getElementById('rule-action').value,
        pattern: document.getElementById('rule-pattern').value,
        description: document.getElementById('rule-description').value,
        enabled: document.getElementById('rule-enabled').checked
    };
    
    fetch('/security/api/waf/rules', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('WAF rule saved successfully');
            closeModal();
            refreshRules();
        } else {
            alert('Error saving rule: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving rule');
    });
}

function testRule(ruleId) {
    if (confirm('Are you sure you want to run a test for this WAF rule?')) {
        fetch(`/security/api/waf/rules/${ruleId}/test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Test completed: ${data.result}`);
            } else {
                alert('Error testing rule: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error testing rule');
        });
    }
}

function toggleRule(ruleId) {
    fetch(`/security/api/waf/rules/${ruleId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Rule ${data.enabled ? 'enabled' : 'disabled'} successfully`);
            refreshRules();
        } else {
            alert('Error toggling rule: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error toggling rule');
    });
}

function deleteRule(ruleId) {
    if (confirm('Are you sure you want to delete this WAF rule? This action cannot be undone.')) {
        fetch(`/security/api/waf/rules/${ruleId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Rule deleted successfully');
                refreshRules();
            } else {
                alert('Error deleting rule: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting rule');
        });
    }
}

function testAllRules() {
    if (confirm('Are you sure you want to test all WAF rules? This may take several minutes.')) {
        fetch('/security/api/waf/rules/test-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Rule testing started. Results will be available in the audit log.');
            } else {
                alert('Error starting rule tests: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error starting rule tests');
        });
    }
}

function emergencyDisable() {
    if (confirm('EMERGENCY DISABLE: This will disable ALL WAF protection. Are you absolutely sure?')) {
        if (confirm('This will leave your application vulnerable. Confirm emergency disable?')) {
            fetch('/security/api/waf/emergency-disable', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('WAF protection has been emergency disabled. Re-enable as soon as possible.');
                    updateWAFDashboard({ protection_status: 'DISABLED' });
                } else {
                    alert('Error disabling WAF: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error disabling WAF');
            });
        }
    }
}

function testRulePreview() {
    const pattern = document.getElementById('rule-pattern').value;
    if (!pattern) {
        alert('Please enter a rule pattern to test');
        return;
    }
    
    const testPayload = prompt('Enter test payload to validate against the rule:');
    if (testPayload) {
        fetch('/security/api/waf/rules/test-preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ pattern: pattern, payload: testPayload })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Test result: ${data.match ? 'MATCH' : 'NO MATCH'}\nDetails: ${data.details}`);
            } else {
                alert('Error testing rule: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error testing rule');
        });
    }
}

// Utility functions
function filterRules() {
    const search = document.getElementById('rule-search').value.toLowerCase();
    const typeFilter = document.getElementById('rule-type-filter').value;
    const statusFilter = document.getElementById('rule-status-filter').value;
    const priorityFilter = document.getElementById('priority-filter').value;
    
    const rows = document.querySelectorAll('#rules-table-body tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const type = row.querySelector('.rule-type-badge')?.textContent.toLowerCase().replace(' ', '-');
        const status = row.querySelector('.rule-status-badge')?.textContent.toLowerCase();
        const priority = row.querySelector('.priority-indicator span')?.textContent.toLowerCase();
        
        const matchesSearch = !search || text.includes(search);
        const matchesType = !typeFilter || type === typeFilter;
        const matchesStatus = !statusFilter || status === statusFilter;
        const matchesPriority = !priorityFilter || priority === priorityFilter;
        
        row.style.display = matchesSearch && matchesType && matchesStatus && matchesPriority ? '' : 'none';
    });
}

function closeModal() {
    document.getElementById('ruleModal').style.display = 'none';
}

function refreshRules() {
    socket.emit('request_waf_data');
}

function importRules() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,.xml,.conf';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('rules_file', file);
            
            fetch('/security/api/waf/rules/import', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Successfully imported ${data.count} rules`);
                    refreshRules();
                } else {
                    alert('Error importing rules: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error importing rules');
            });
        }
    };
    input.click();
}

function exportRules() {
    window.location.href = '/security/waf/rules/export';
}

function viewDetailedStatus(statusType) {
    window.location.href = `/security/waf/status/${statusType}`;
}

function updateWAFMetrics() {
    socket.emit('request_waf_metrics');
}

function updateRuleMetrics(ruleId, matches, falsePositives) {
    const row = document.querySelector(`tr[data-rule-id="${ruleId}"]`);
    if (row) {
        row.cells[5].textContent = matches;
        row.cells[6].textContent = falsePositives;
    }
}
</script>
</div>
{% endblock %}