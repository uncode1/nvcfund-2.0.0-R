{% extends "unified_base.html" %}
{% from "components/nvc_components.html" import metric_card, action_card, account_card, transaction_row, form_input, form_select, notification_banner, progress_bar, stats_grid, loading_spinner, empty_state %}


{% block title %}NGFW Management - NVC Banking Platform{% endblock %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<style>
    .ngfw-management {
        background: linear-gradient(135deg, #0a2447 0%, #1a365d 100%);
        min-height: 100vh;
        color: #ffffff;
        padding: 20px;
    }
    
    .ngfw-header {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .firewall-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .firewall-card {
        background: rgba(255,255,255,0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .firewall-card:hover {
        background: rgba(255,255,255,0.15);
        transform: translateY(-3px);
    }
    
    .firewall-online { border-left: 4px solid #00ff88; }
    .firewall-warning { border-left: 4px solid #ffaa00; }
    .firewall-offline { border-left: 4px solid #ff4444; }
    .firewall-maintenance { border-left: 4px solid #66ccff; }
    
    .firewall-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .firewall-name {
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .firewall-status {
        padding: 3px 8px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .status-online { background: #00ff88; color: #000; }
    .status-warning { background: #ffaa00; color: #000; }
    .status-offline { background: #ff4444; color: #fff; }
    .status-maintenance { background: #66ccff; color: #000; }
    
    .firewall-metrics {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
    }
    
    .metric-item {
        text-align: center;
        padding: 8px;
        background: rgba(255,255,255,0.05);
        border-radius: 6px;
    }
    
    .metric-value {
        font-weight: bold;
        color: #66ccff;
        font-size: 1.2rem;
    }
    
    .metric-label {
        font-size: 0.8rem;
        opacity: 0.8;
    }
    
    .network-topology {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 30px;
    }
    
    .topology-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .network-segment {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        border: 2px solid;
    }
    
    .segment-dmz { border-color: #ff6b6b; }
    .segment-internal { border-color: #4ecdc4; }
    .segment-external { border-color: #45b7d1; }
    .segment-management { border-color: #96ceb4; }
    
    .segment-icon {
        font-size: 2rem;
        margin-bottom: 10px;
    }
    
    .segment-name {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .segment-info {
        font-size: 0.8rem;
        opacity: 0.8;
    }
    
    .traffic-monitoring {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }
    
    .chart-container {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .rules-management {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 30px;
    }
    
    .rule-categories {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .rule-category {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .rule-category:hover {
        background: rgba(255,255,255,0.1);
    }
    
    .category-icon {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: #66ccff;
    }
    
    .category-name {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .category-count {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .rules-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .rules-table th,
    .rules-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .rules-table th {
        background: rgba(255,255,255,0.1);
        font-weight: bold;
        color: #66ccff;
        position: sticky;
        top: 0;
    }
    
    .rule-row {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .rule-row:hover {
        background: rgba(255,255,255,0.05);
    }
    
    .rule-action-badge {
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .action-allow { background: #00ff88; color: #000; }
    .action-deny { background: #ff4444; color: #fff; }
    .action-drop { background: #ff6666; color: #fff; }
    .action-log { background: #66ccff; color: #000; }
    .action-inspect { background: #ffaa00; color: #000; }
    
    .protocol-badge {
        padding: 3px 6px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: bold;
        background: rgba(255,255,255,0.1);
    }
    
    .threat-analytics {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 30px;
    }
    
    .threat-item {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .threat-critical { border-left-color: #ff0000; }
    .threat-high { border-left-color: #ff4444; }
    .threat-medium { border-left-color: #ffaa00; }
    .threat-low { border-left-color: #66ccff; }
    
    .threat-info {
        flex: 1;
    }
    
    .threat-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .threat-details {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 5px;
    }
    
    .threat-meta {
        font-size: 0.8rem;
        opacity: 0.7;
    }
    
    .threat-actions {
        display: flex;
        gap: 5px;
    }
    
    .action-btn {
        background: #66ccff;
        color: #0a2447;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .action-btn:hover {
        background: #4db8ff;
        transform: scale(1.05);
    }
    
    .action-btn.danger {
        background: #ff4444;
        color: #fff;
    }
    
    .action-btn.success {
        background: #4caf50;
        color: #fff;
    }
    
    .action-btn.warning {
        background: #ffaa00;
        color: #000;
    }
    
    .filters-section {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-input,
    .filter-select {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        padding: 8px;
        color: #fff;
        min-width: 150px;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
    }
    
    .modal-content {
        background: linear-gradient(135deg, #0a2447 0%, #1a365d 100%);
        margin: 3% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 900px;
        border: 1px solid rgba(255,255,255,0.2);
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: #fff;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #66ccff;
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        background: rgba(255,255,255,0.1);
        color: #fff;
        font-size: 14px;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #66ccff;
        box-shadow: 0 0 5px rgba(102, 204, 255, 0.5);
    }
    
    .realtime-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }
    
    .realtime-dot {
        width: 8px;
        height: 8px;
        background: #00ff88;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="nvc-page-content">
    <div class="ngfw-management">
    <!-- NGFW Header -->
    <div class="ngfw-header">
        <div>
            <h1><i class="fas fa-network-wired"></i> Next-Generation Firewall Management</h1>
            <p>Advanced network security with deep packet inspection and threat prevention</p>
        </div>
        <div class="realtime-indicator">
            <span class="realtime-dot"></span>
            <span>Live Monitoring</span>
        </div>
    </div>

    <!-- Firewall Status Grid -->
    <div class="firewall-status-grid">
        <div class="firewall-nvc-card firewall-online" data-action="custom-action">
            <div class="firewall-header">
                <div class="firewall-name">Perimeter Firewall</div>
                <div class="firewall-status status-online">ONLINE</div>
            </div>
            <div class="firewall-metrics">
                <div class="metric-item">
                    <div class="metric-value" id="perimeter-throughput">{{ ngfw_data.perimeter_throughput or '2.3 Gbps' }}</div>
                    <div class="metric-label">Throughput</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="perimeter-sessions">{{ ngfw_data.perimeter_sessions or '45.2K' }}</div>
                    <div class="metric-label">Sessions</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="perimeter-threats">{{ ngfw_data.perimeter_threats or '127' }}</div>
                    <div class="metric-label">Threats Blocked</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="perimeter-cpu">{{ ngfw_data.perimeter_cpu or '23%' }}</div>
                    <div class="metric-label">CPU Usage</div>
                </div>
            </div>
        </div>
        
        <div class="firewall-nvc-card firewall-online" data-action="custom-action">
            <div class="firewall-header">
                <div class="firewall-name">Internal Segmentation</div>
                <div class="firewall-status status-online">ONLINE</div>
            </div>
            <div class="firewall-metrics">
                <div class="metric-item">
                    <div class="metric-value" id="internal-throughput">{{ ngfw_data.internal_throughput or '1.8 Gbps' }}</div>
                    <div class="metric-label">Throughput</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="internal-sessions">{{ ngfw_data.internal_sessions or '32.1K' }}</div>
                    <div class="metric-label">Sessions</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="internal-threats">{{ ngfw_data.internal_threats or '43' }}</div>
                    <div class="metric-label">Threats Blocked</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="internal-cpu">{{ ngfw_data.internal_cpu or '18%' }}</div>
                    <div class="metric-label">CPU Usage</div>
                </div>
            </div>
        </div>
        
        <div class="firewall-nvc-card firewall-warning" data-action="custom-action">
            <div class="firewall-header">
                <div class="firewall-name">DMZ Protection</div>
                <div class="firewall-status status-warning">WARNING</div>
            </div>
            <div class="firewall-metrics">
                <div class="metric-item">
                    <div class="metric-value" id="dmz-throughput">{{ ngfw_data.dmz_throughput or '950 Mbps' }}</div>
                    <div class="metric-label">Throughput</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="dmz-sessions">{{ ngfw_data.dmz_sessions or '28.7K' }}</div>
                    <div class="metric-label">Sessions</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="dmz-threats">{{ ngfw_data.dmz_threats or '89' }}</div>
                    <div class="metric-label">Threats Blocked</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="dmz-cpu">{{ ngfw_data.dmz_cpu or '67%' }}</div>
                    <div class="metric-label">CPU Usage</div>
                </div>
            </div>
        </div>
        
        <div class="firewall-nvc-card firewall-maintenance" data-action="custom-action">
            <div class="firewall-header">
                <div class="firewall-name">Backup Firewall</div>
                <div class="firewall-status status-maintenance">STANDBY</div>
            </div>
            <div class="firewall-metrics">
                <div class="metric-item">
                    <div class="metric-value" id="backup-status">READY</div>
                    <div class="metric-label">Status</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="backup-sync">99.8%</div>
                    <div class="metric-label">Config Sync</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="backup-last">2 min</div>
                    <div class="metric-label">Last Check</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="backup-failover">< 30s</div>
                    <div class="metric-label">Failover Time</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Topology -->
    <div class="network-topology">
        <h3><i class="fas fa-project-diagram"></i> Network Security Topology</h3>
        <div class="topology-container">
            <div class="network-segment segment-external">
                <div class="segment-icon"><i class="fas fa-globe" style="color: #45b7d1;"></i></div>
                <div class="segment-name">Internet</div>
                <div class="segment-info">External Networks<br>Untrusted Zone</div>
            </div>
            
            <div class="network-segment segment-dmz">
                <div class="segment-icon"><i class="fas fa-server" style="color: #ff6b6b;"></i></div>
                <div class="segment-name">DMZ</div>
                <div class="segment-info">Public Services<br>Web Servers, Email</div>
            </div>
            
            <div class="network-segment segment-internal">
                <div class="segment-icon"><i class="fas fa-building" style="color: #4ecdc4;"></i></div>
                <div class="segment-name">Internal Network</div>
                <div class="segment-info">Corporate LAN<br>User Workstations</div>
            </div>
            
            <div class="network-segment segment-management">
                <div class="segment-icon"><i class="fas fa-cogs" style="color: #96ceb4;"></i></div>
                <div class="segment-name">Management</div>
                <div class="segment-info">Admin Network<br>Infrastructure</div>
            </div>
        </div>
    </div>

    <!-- Traffic Monitoring -->
    <div class="traffic-monitoring">
        <div class="chart-container">
            <h3><i class="fas fa-chart-line"></i> Network Traffic Analysis</h3>
            <canvas id="trafficAnalysisChart" width="400" height="300"></canvas>
        </div>
        
        <div class="chart-container">
            <h3><i class="fas fa-chart-pie"></i> Protocol Distribution</h3>
            <canvas id="protocolDistributionChart" width="400" height="300"></canvas>
        </div>
    </div>

    <!-- Threat Analytics -->
    <div class="threat-analytics">
        <h3><i class="fas fa-crosshairs"></i> Real-time Threat Analytics</h3>
        <div id="threat-analytics-container">
            {% set threat_data = [
                {
                    'title': 'Malware C&C Communication Blocked',
                    'severity': 'critical',
                    'source': '185.220.101.47',
                    'destination': 'Internal Server (10.1.1.45)',
                    'protocol': 'HTTPS',
                    'action': 'Blocked and logged',
                    'time': '1 min ago'
                },
                {
                    'title': 'Port Scan Detection',
                    'severity': 'high',
                    'source': '103.85.24.156',
                    'destination': 'DMZ Subnet (172.16.1.0/24)',
                    'protocol': 'TCP',
                    'action': 'Automatically blocked source',
                    'time': '3 min ago'
                },
                {
                    'title': 'Suspicious DNS Query Pattern',
                    'severity': 'medium',
                    'source': 'Internal Workstation (10.1.2.87)',
                    'destination': 'Suspicious Domain',
                    'protocol': 'DNS',
                    'action': 'Query blocked, user notified',
                    'time': '7 min ago'
                },
                {
                    'title': 'Geo-blocked Connection Attempt',
                    'severity': 'low',
                    'source': '91.203.67.123 (Romania)',
                    'destination': 'Web Server (172.16.1.10)',
                    'protocol': 'HTTPS',
                    'action': 'Blocked by geo-policy',
                    'time': '12 min ago'
                }
            ] %}
            
            {% for threat in threat_data %}
            <div class="threat-item threat-{{ threat.severity }}">
                <div class="threat-info">
                    <div class="threat-title">{{ threat.title }}</div>
                    <div class="threat-details">
                        <strong>Source:</strong> {{ threat.source }} → <strong>Destination:</strong> {{ threat.destination }}
                    </div>
                    <div class="threat-meta">
                        <strong>Protocol:</strong> {{ threat.protocol }} • <strong>Action:</strong> {{ threat.action }} • {{ threat.time }}
                    </div>
                </div>
                <div class="threat-actions">
                    <button type="button" class="action-btn" data-action="custom-action" title="Investigate">
                        <i class="fas fa-search"></i>
                    </button>
                    <button type="button" class="action-btn danger" data-action="custom-action" title="Block Source">
                        <i class="fas fa-ban"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Firewall Rules Management -->
    <div class="rules-management">
        <div class="filters-section">
            <input type="text" class="filter-input" id="rule-search" placeholder="Search firewall rules...">
            <select class="filter-select" id="rule-action-filter">
                <option value="">All Actions</option>
                <option value="allow">Allow</option>
                <option value="deny">Deny</option>
                <option value="drop">Drop</option>
                <option value="log">Log</option>
                <option value="inspect">Inspect</option>
            </select>
            <select class="filter-select" id="rule-zone-filter">
                <option value="">All Zones</option>
                <option value="external">External</option>
                <option value="dmz">DMZ</option>
                <option value="internal">Internal</option>
                <option value="management">Management</option>
            </select>
            <select class="filter-select" id="rule-protocol-filter">
                <option value="">All Protocols</option>
                <option value="tcp">TCP</option>
                <option value="udp">UDP</option>
                <option value="icmp">ICMP</option>
                <option value="http">HTTP</option>
                <option value="https">HTTPS</option>
            </select>
        </div>
        
        <div class="rule-categories">
            <div class="rule-category" data-action="custom-action">
                <div class="category-icon"><i class="fas fa-shield-alt"></i></div>
                <div class="category-name">Security Rules</div>
                <div class="category-count">{{ ngfw_data.security_rules or 89 }} rules</div>
            </div>
            
            <div class="rule-category" data-action="custom-action">
                <div class="category-icon"><i class="fas fa-key"></i></div>
                <div class="category-name">Access Control</div>
                <div class="category-count">{{ ngfw_data.access_rules or 156 }} rules</div>
            </div>
            
            <div class="rule-category" data-action="custom-action">
                <div class="category-icon"><i class="fas fa-exchange-alt"></i></div>
                <div class="category-name">NAT Rules</div>
                <div class="category-count">{{ ngfw_data.nat_rules or 34 }} rules</div>
            </div>
            
            <div class="rule-category" data-action="custom-action">
                <div class="category-icon"><i class="fas fa-tachometer-alt"></i></div>
                <div class="category-name">QoS Policies</div>
                <div class="category-count">{{ ngfw_data.qos_rules or 23 }} rules</div>
            </div>
            
            <div class="rule-category" data-action="custom-action">
                <div class="category-icon"><i class="fas fa-apps"></i></div>
                <div class="category-name">App Control</div>
                <div class="category-count">{{ ngfw_data.app_rules or 67 }} rules</div>
            </div>
        </div>
        
        <div style="gap: var(--nvc-space-md)">
            <button type="button" class="action-btn success" data-action="custom-action">
                <i class="fas fa-plus"></i> Create Rule
            </button>
            <button type="button" class="action-btn" data-action="custom-action">
                <i class="fas fa-upload"></i> Import Rules
            </button>
            <button type="button" class="action-btn" data-action="custom-action">
                <i class="fas fa-download"></i> Export Rules
            </button>
            <button type="button" class="action-btn warning" data-action="custom-action">
                <i class="fas fa-magic"></i> Optimize Rules
            </button>
            <button type="button" class="action-btn" data-action="custom-action">
                <i class="fas fa-save"></i> Backup Config
            </button>
            <button type="button" class="action-btn danger" data-action="custom-action">
                <i class="fas fa-exclamation-triangle"></i> Emergency Block
            </button>
        </div>

        <h3><i class="fas fa-list"></i> Firewall Rules Configuration</h3>
        <table class="rules-table">
            <thead>
                <tr>
                    <th>Rule ID</th>
                    <th>Name</th>
                    <th>Source</th>
                    <th>Destination</th>
                    <th>Service</th>
                    <th>Action</th>
                    <th>Hits (24h)</th>
                    <th>Enabled</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="rules-table-body">
                {% if ngfw_data.rules %}
                    {% for rule in ngfw_data.rules %}
                    <tr class="rule-row" data-rule-id="{{ rule.id }}" data-action="custom-action">
                        <td><code>{{ rule.rule_id }}</code></td>
                        <td>{{ rule.name }}</td>
                        <td>{{ rule.source }}</td>
                        <td>{{ rule.destination }}</td>
                        <td><span class="protocol-badge">{{ rule.service }}</span></td>
                        <td><span class="rule-action-badge action-{{ rule.action.lower() }}">{{ rule.action }}</span></td>
                        <td>{{ rule.hits }}</td>
                        <td>
                            <i class="fas fa-{{ 'check text-success' if rule.enabled else 'times text-danger' }}"></i>
                        </td>
                        <td data-action="custom-action">
                            <div class="nvc-flex-9d6126">
                                <button type="button" class="action-btn" data-action="custom-action" title="Edit Rule">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="action-btn warning" data-action="custom-action" title="Test Rule">
                                    <i class="fas fa-vial"></i>
                                </button>
                                <button type="button" class="action-btn" data-action="custom-action" title="Toggle Status">
                                    <i class="fas fa-power-off"></i>
                                </button>
                                <button type="button" class="action-btn danger" data-action="custom-action" title="Delete Rule">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="9" class="nvc-center-spaced-854720">
                            No firewall rules configured
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Firewall Rule Modal -->
<div id="firewallRuleModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modal-title"><i class="fas fa-plus"></i> Create Firewall Rule</h2>
        <form id="firewall-rule-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="fw-rule-name">Rule Name</label>
                    <input type="text" id="fw-rule-name" class="nvc-form-input" placeholder="Enter descriptive rule name" required>
                </div>
                
                <div class="form-group">
                    <label for="fw-rule-action">Action</label>
                    <select id="fw-rule-action" class="nvc-form-input" required>
                        <option value="">Select action</option>
                        <option value="allow">Allow</option>
                        <option value="deny">Deny</option>
                        <option value="drop">Drop (Silent)</option>
                        <option value="log">Log Only</option>
                        <option value="inspect">Deep Inspection</option>
                    </select>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="fw-source-zone">Source Zone</label>
                    <select id="fw-source-zone" class="nvc-form-input" required>
                        <option value="">Select source zone</option>
                        <option value="external">External</option>
                        <option value="dmz">DMZ</option>
                        <option value="internal">Internal</option>
                        <option value="management">Management</option>
                        <option value="any">Any</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="fw-dest-zone">Destination Zone</label>
                    <select id="fw-dest-zone" class="nvc-form-input" required>
                        <option value="">Select destination zone</option>
                        <option value="external">External</option>
                        <option value="dmz">DMZ</option>
                        <option value="internal">Internal</option>
                        <option value="management">Management</option>
                        <option value="any">Any</option>
                    </select>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="fw-source-address">Source Address</label>
                    <input type="text" id="fw-source-address" class="nvc-form-input" placeholder="IP, CIDR, or 'any'" required>
                </div>
                
                <div class="form-group">
                    <label for="fw-dest-address">Destination Address</label>
                    <input type="text" id="fw-dest-address" class="nvc-form-input" placeholder="IP, CIDR, or 'any'" required>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="fw-protocol">Protocol</label>
                    <select id="fw-protocol" class="nvc-form-input" required>
                        <option value="">Select protocol</option>
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                        <option value="icmp">ICMP</option>
                        <option value="any">Any</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="fw-ports">Destination Ports</label>
                    <input type="text" id="fw-ports" class="nvc-form-input" placeholder="80, 443, 8080-8090, or 'any'">
                </div>
            </div>
            
            <div class="form-group">
                <label for="fw-rule-description">Description</label>
                <textarea id="fw-rule-description" class="nvc-form-input" rows="3" placeholder="Describe the purpose of this rule"></textarea>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="fw-rule-enabled" checked> Enable rule immediately
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="fw-rule-logging"> Enable logging for this rule
                    </label>
                </div>
            </div>
            
            <div class="nvc-flex-spaced-813fba">
                <button type="button" class="action-btn" data-action="custom-action">Cancel</button>
                <button type="button" class="action-btn warning" data-action="custom-action">Test Rule</button>
                <button type="submit" class="action-btn success">Save Rule</button>
            </div>
        </form>
    </div>
</div>

<script>
// Socket.IO connection for real-time NGFW data
const socket = io('/security-center');

// Chart instances
let trafficAnalysisChart, protocolDistributionChart;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setupEventListeners();
    
    // Connect to socket for real-time updates
    if (socket.connected) {
        socket.emit('request_ngfw_data');
    }
});

// Socket event handlers
socket.on('connect', function() {
    console.log('Connected to security center socket for NGFW management');
    socket.emit('request_ngfw_data');
});

socket.on('ngfw_threat_detected', function(threat) {
    addThreatToAnalytics(threat);
    updateFirewallMetrics();
});

socket.on('ngfw_traffic_update', function(data) {
    updateTrafficAnalysisChart(data);
});

socket.on('ngfw_metrics_update', function(metrics) {
    updateFirewallDashboard(metrics);
});

// Initialize charts
function initializeCharts() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: { color: '#ffffff' }
            }
        },
        scales: {
            x: {
                ticks: { color: '#ffffff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
                ticks: { color: '#ffffff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    };

    // Traffic Analysis Chart
    const trafficCtx = document.getElementById('trafficAnalysisChart').getContext('2d');
    trafficAnalysisChart = new Chart(trafficCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Inbound Traffic (Mbps)',
                    data: [],
                    borderColor: '#66ccff',
                    backgroundColor: 'rgba(102, 204, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Outbound Traffic (Mbps)',
                    data: [],
                    borderColor: '#00ff88',
                    backgroundColor: 'rgba(0, 255, 136, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Blocked Traffic (Mbps)',
                    data: [],
                    borderColor: '#ff4444',
                    backgroundColor: 'rgba(255, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: chartOptions
    });

    // Protocol Distribution Chart
    const protocolCtx = document.getElementById('protocolDistributionChart').getContext('2d');
    protocolDistributionChart = new Chart(protocolCtx, {
        type: 'doughnut',
        data: {
            labels: ['HTTP/HTTPS', 'Email (SMTP/POP3)', 'FTP/SFTP', 'DNS', 'SSH/RDP', 'Other'],
            datasets: [{
                data: [45, 20, 12, 8, 10, 5],
                backgroundColor: [
                    '#66ccff',
                    '#00ff88',
                    '#ffaa00',
                    '#ff6666',
                    '#9966ff',
                    '#ff9966'
                ],
                borderWidth: 2,
                borderColor: '#0a2447'
            }]
        },
        options: {
            ...chartOptions,
            scales: {} // Remove scales for doughnut chart
        }
    });
}

// Setup event listeners
function setupEventListeners() {
    // Search and filter inputs
    document.getElementById('rule-search').addEventListener('input', filterFirewallRules);
    document.getElementById('rule-action-filter').addEventListener('change', filterFirewallRules);
    document.getElementById('rule-zone-filter').addEventListener('change', filterFirewallRules);
    document.getElementById('rule-protocol-filter').addEventListener('change', filterFirewallRules);
    
    // Modal close events
    document.querySelector('.close').addEventListener('click', closeFirewallModal);
    window.addEventListener('click', function(e) {
        const modal = document.getElementById('firewallRuleModal');
        if (e.target === modal) {
            closeFirewallModal();
        }
    });
    
    // Form submission
    document.getElementById('firewall-rule-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveFirewallRule();
    });
}

// Update functions
function updateTrafficAnalysisChart(data) {
    if (trafficAnalysisChart && data.labels) {
        trafficAnalysisChart.data.labels = data.labels;
        trafficAnalysisChart.data.datasets[0].data = data.inbound || [];
        trafficAnalysisChart.data.datasets[1].data = data.outbound || [];
        trafficAnalysisChart.data.datasets[2].data = data.blocked || [];
        trafficAnalysisChart.update('none');
    }
}

function updateFirewallDashboard(metrics) {
    // Update perimeter firewall metrics
    if (metrics.perimeter) {
        document.getElementById('perimeter-throughput').textContent = metrics.perimeter.throughput;
        document.getElementById('perimeter-sessions').textContent = metrics.perimeter.sessions;
        document.getElementById('perimeter-threats').textContent = metrics.perimeter.threats;
        document.getElementById('perimeter-cpu').textContent = metrics.perimeter.cpu;
    }
    
    // Update internal firewall metrics
    if (metrics.internal) {
        document.getElementById('internal-throughput').textContent = metrics.internal.throughput;
        document.getElementById('internal-sessions').textContent = metrics.internal.sessions;
        document.getElementById('internal-threats').textContent = metrics.internal.threats;
        document.getElementById('internal-cpu').textContent = metrics.internal.cpu;
    }
    
    // Update DMZ firewall metrics
    if (metrics.dmz) {
        document.getElementById('dmz-throughput').textContent = metrics.dmz.throughput;
        document.getElementById('dmz-sessions').textContent = metrics.dmz.sessions;
        document.getElementById('dmz-threats').textContent = metrics.dmz.threats;
        document.getElementById('dmz-cpu').textContent = metrics.dmz.cpu;
    }
}

function addThreatToAnalytics(threat) {
    const container = document.getElementById('threat-analytics-container');
    const item = document.createElement('div');
    item.className = `threat-item threat-${threat.severity}`;
    item.innerHTML = `
        <div class="threat-info">
            <div class="threat-title">${threat.title}</div>
            <div class="threat-details">
                <strong>Source:</strong> ${threat.source} → <strong>Destination:</strong> ${threat.destination}
            </div>
            <div class="threat-meta">
                <strong>Protocol:</strong> ${threat.protocol} • <strong>Action:</strong> ${threat.action} • ${threat.time}
            </div>
        </div>
        <div class="threat-actions">
            <button type="button" class="action-btn" data-action="custom-action" title="Investigate">
                <i class="fas fa-search"></i>
            </button>
            <button type="button" class="action-btn danger" data-action="custom-action" title="Block Source">
                <i class="fas fa-ban"></i>
            </button>
        </div>
    `;
    
    container.insertBefore(item, container.firstChild);
    
    // Keep only latest 10 threats
    while (container.children.length > 10) {
        container.removeChild(container.lastChild);
    }
}

// Firewall management functions
function manageFirewall(firewallType) {
    window.location.href = `/security/ngfw/${firewallType}/dashboard`;
}

function createRule() {
    document.getElementById('modal-title').innerHTML = '<i class="fas fa-plus"></i> Create Firewall Rule';
    document.getElementById('firewall-rule-form').reset();
    document.getElementById('firewallRuleModal').style.display = 'block';
}

function editFirewallRule(ruleId) {
    document.getElementById('modal-title').innerHTML = '<i class="fas fa-edit"></i> Edit Firewall Rule';
    
    // Fetch rule data and populate form
    fetch(`/security/api/ngfw/rules/${ruleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const rule = data.rule;
                document.getElementById('fw-rule-name').value = rule.name;
                document.getElementById('fw-rule-action').value = rule.action;
                document.getElementById('fw-source-zone').value = rule.source_zone;
                document.getElementById('fw-dest-zone').value = rule.dest_zone;
                document.getElementById('fw-source-address').value = rule.source_address;
                document.getElementById('fw-dest-address').value = rule.dest_address;
                document.getElementById('fw-protocol').value = rule.protocol;
                document.getElementById('fw-ports').value = rule.ports;
                document.getElementById('fw-rule-description').value = rule.description;
                document.getElementById('fw-rule-enabled').checked = rule.enabled;
                document.getElementById('fw-rule-logging').checked = rule.logging;
                
                document.getElementById('firewallRuleModal').style.display = 'block';
            } else {
                alert('Error loading rule: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading rule');
        });
}

function saveFirewallRule() {
    const formData = {
        name: document.getElementById('fw-rule-name').value,
        action: document.getElementById('fw-rule-action').value,
        source_zone: document.getElementById('fw-source-zone').value,
        dest_zone: document.getElementById('fw-dest-zone').value,
        source_address: document.getElementById('fw-source-address').value,
        dest_address: document.getElementById('fw-dest-address').value,
        protocol: document.getElementById('fw-protocol').value,
        ports: document.getElementById('fw-ports').value,
        description: document.getElementById('fw-rule-description').value,
        enabled: document.getElementById('fw-rule-enabled').checked,
        logging: document.getElementById('fw-rule-logging').checked
    };
    
    fetch('/security/api/ngfw/rules', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Firewall rule saved successfully');
            closeFirewallModal();
            refreshFirewallRules();
        } else {
            alert('Error saving rule: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving rule');
    });
}

function testFirewallRule(ruleId) {
    if (confirm('Are you sure you want to test this firewall rule?')) {
        fetch(`/security/api/ngfw/rules/${ruleId}/test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Test completed: ${data.result}`);
            } else {
                alert('Error testing rule: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error testing rule');
        });
    }
}

function toggleFirewallRule(ruleId) {
    fetch(`/security/api/ngfw/rules/${ruleId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Rule ${data.enabled ? 'enabled' : 'disabled'} successfully`);
            refreshFirewallRules();
        } else {
            alert('Error toggling rule: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error toggling rule');
    });
}

function deleteFirewallRule(ruleId) {
    if (confirm('Are you sure you want to delete this firewall rule? This action cannot be undone.')) {
        fetch(`/security/api/ngfw/rules/${ruleId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Rule deleted successfully');
                refreshFirewallRules();
            } else {
                alert('Error deleting rule: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting rule');
        });
    }
}

function optimizeRules() {
    if (confirm('Optimize firewall rules? This will reorganize rules for better performance.')) {
        fetch('/security/api/ngfw/rules/optimize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Rules optimized. ${data.optimizations} optimizations made.`);
                refreshFirewallRules();
            } else {
                alert('Error optimizing rules: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error optimizing rules');
        });
    }
}

function emergencyBlock() {
    const target = prompt('Enter IP address or CIDR to emergency block:');
    if (target && confirm(`Emergency block ${target}? This will immediately block all traffic.`)) {
        fetch('/security/api/ngfw/emergency-block', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ target: target })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Emergency block activated for ${target}`);
            } else {
                alert('Error activating emergency block: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error activating emergency block');
        });
    }
}

function testFirewallRulePreview() {
    const sourceAddr = document.getElementById('fw-source-address').value;
    const destAddr = document.getElementById('fw-dest-address').value;
    const protocol = document.getElementById('fw-protocol').value;
    const ports = document.getElementById('fw-ports').value;
    
    if (!sourceAddr || !destAddr || !protocol) {
        alert('Please fill in source address, destination address, and protocol to test');
        return;
    }
    
    fetch('/security/api/ngfw/rules/test-preview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            source_address: sourceAddr,
            dest_address: destAddr,
            protocol: protocol,
            ports: ports
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Test result: ${data.match ? 'RULE WOULD MATCH' : 'RULE WOULD NOT MATCH'}\nDetails: ${data.details}`);
        } else {
            alert('Error testing rule: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error testing rule');
    });
}

// Threat response functions
function investigateThreat(threatTitle) {
    window.location.href = `/security/threats/investigate?q=${encodeURIComponent(threatTitle)}`;
}

function blockPermanently(sourceIP) {
    if (confirm(`Permanently block ${sourceIP}? This will add a deny rule to the firewall.`)) {
        fetch('/security/api/ngfw/block-ip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ip_address: sourceIP })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`IP address ${sourceIP} has been permanently blocked`);
            } else {
                alert('Error blocking IP: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error blocking IP address');
        });
    }
}

// Utility functions
function filterByCategory(category) {
    // Set category filter and refresh display
    window.location.href = `/security/ngfw/rules?category=${category}`;
}

function filterFirewallRules() {
    const search = document.getElementById('rule-search').value.toLowerCase();
    const actionFilter = document.getElementById('rule-action-filter').value;
    const zoneFilter = document.getElementById('rule-zone-filter').value;
    const protocolFilter = document.getElementById('rule-protocol-filter').value;
    
    const rows = document.querySelectorAll('#rules-table-body tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const action = row.querySelector('.rule-action-badge')?.textContent.toLowerCase();
        const protocol = row.querySelector('.protocol-badge')?.textContent.toLowerCase();
        
        const matchesSearch = !search || text.includes(search);
        const matchesAction = !actionFilter || action === actionFilter;
        const matchesProtocol = !protocolFilter || protocol?.includes(protocolFilter);
        
        row.style.display = matchesSearch && matchesAction && matchesProtocol ? '' : 'none';
    });
}

function closeFirewallModal() {
    document.getElementById('firewallRuleModal').style.display = 'none';
}

function refreshFirewallRules() {
    socket.emit('request_ngfw_data');
}

function importRules() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,.xml,.conf';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('rules_file', file);
            
            fetch('/security/api/ngfw/rules/import', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Successfully imported ${data.count} firewall rules`);
                    refreshFirewallRules();
                } else {
                    alert('Error importing rules: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error importing rules');
            });
        }
    };
    input.click();
}

function exportRules() {
    window.location.href = '/security/ngfw/rules/export';
}

function backupConfig() {
    fetch('/security/api/ngfw/backup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Configuration backup created: ${data.backup_id}`);
        } else {
            alert('Error creating backup: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating backup');
    });
}

function updateFirewallMetrics() {
    socket.emit('request_ngfw_metrics');
}
</script>
</div>
{% endblock %}