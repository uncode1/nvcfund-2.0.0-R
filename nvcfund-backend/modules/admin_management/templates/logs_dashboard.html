{% extends "unified_base.html" %}

{% block title %}Logs Dashboard - NVC Banking Platform{% endblock %}

{% block page_title %}System Logs Dashboard{% endblock %}
{% block page_description %}Real-time system logs monitoring and analysis{% endblock %}

{% block breadcrumb_items %}
<li class="nvc-breadcrumb-item">
    <a href="{{ url_for('admin_management.admin_dashboard') }}">Administration</a>
</li>
<li class="nvc-breadcrumb-item active">Logs Dashboard</li>
{% endblock %}

{% block content %}
<div class="nvc-content-sections">
    <style>
        .dashboard-stat-card { background: #1e293b !important; border: 1px solid #334155 !important; border-radius: 8px !important; padding: 1.5rem; margin-bottom: 1rem; }
        .card { background: #1e293b !important; border: 1px solid #334155 !important; color: #e2e8f0 !important; }
        .btn-primary { background: #3b82f6 !important; border-color: #3b82f6 !important; }
        .table-dark { background: #1e293b !important; }
        .table-dark td, .table-dark th { border-color: #334155 !important; color: #e2e8f0 !important; }
    </style>
</head>
<body>


<style>
.logs-dashboard {
    background: #0a2447;
    color: #ffffff;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.log-filters {
    background: #1e3a5f;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #66ccff;
}

.log-entry {
    background: #1e3a5f;
    border: 1px solid #66ccff;
    border-radius: 5px;
    padding: 12px;
    margin-bottom: 8px;
    transition: all 0.3s ease;
}

.log-entry:hover {
    background: #2a4470;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 204, 255, 0.1);
}

.log-level {
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.8em;
    text-transform: uppercase;
}

.log-level.error {
    background: #dc3545;
    color: white;
}

.log-level.warning {
    background: #ffc107;
    color: black;
}

.log-level.info {
    background: #17a2b8;
    color: white;
}

.log-level.debug {
    background: #6c757d;
    color: white;
}

.log-timestamp {
    color: #66ccff;
    font-family: monospace;
    font-size: 0.9em;
}

.log-category {
    background: #66ccff;
    color: #0a2447;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8em;
    font-weight: bold;
}

.log-message {
    margin-top: 8px;
    font-family: monospace;
    font-size: 0.9em;
    line-height: 1.4;
    word-break: break-all;
}

.search-highlight {
    background: #ffc107;
    color: #000;
    font-weight: bold;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: linear-gradient(135deg, #1e3a5f, #2a4470);
    border: 1px solid #66ccff;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #66ccff;
}

.stat-label {
    color: #ffffff;
    margin-top: 5px;
}

.filter-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    align-items: end;
}

.form-group label {
    color: #66ccff;
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
}

.form-control {
    background: #0a2447;
    border: 1px solid #66ccff;
    color: #ffffff;
    border-radius: 5px;
    padding: 8px 12px;
}

.form-control:focus {
    background: #0a2447;
    border-color: #ffcc00;
    color: #ffffff;
    box-shadow: 0 0 0 0.2rem rgba(255, 204, 0, 0.25);
}

.btn-filter {
    background: #66ccff;
    color: #0a2447;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-filter:hover {
    background: #ffcc00;
    transform: translateY(-1px);
}

.btn-clear {
    background: #6c757d;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-clear:hover {
    background: #5a6268;
}

.btn-export {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-export:hover {
    background: #218838;
}

.real-time-toggle {
    background: #17a2b8;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.real-time-toggle.active {
    background: #28a745;
}

.real-time-toggle:hover {
    opacity: 0.8;
}

.trace-modal .modal-content {
    background: #0a2447;
    color: #ffffff;
    border: 1px solid #66ccff;
}

.trace-modal .modal-header {
    border-bottom: 1px solid #66ccff;
}

.trace-modal .modal-footer {
    border-top: 1px solid #66ccff;
}

.no-logs {
    text-align: center;
    padding: 40px;
    color: #6c757d;
    font-style: italic;
}

@media (max-width: 768px) {
    .filter-form {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>

<div class="container-fluid">
    <div class="logs-dashboard">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-file-alt"></i> Enterprise Logs Dashboard</h2>
                <p class="mb-0">Real-time log monitoring and analysis with robust filtering</p>
            </div>
            <div>
                <button type="button" id="realTimeToggle" class="real-time-toggle">
                    <i class="fas fa-play"></i> Enable Real-time
                </button>
                <span id="lastUpdate" class="ms-2 text-light small">Last updated: Never</span>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-nvc-card">
                <div class="stat-number">{{ logs_data.total_logs }}</div>
                <div class="stat-label">Total Log Files</div>
            </div>
            <div class="stat-nvc-card">
                <div class="stat-number">{{ logs_data.error_count }}</div>
                <div class="stat-label">Error Entries</div>
            </div>
            <div class="stat-nvc-card">
                <div class="stat-number">{{ logs_data.warning_count }}</div>
                <div class="stat-label">Warning Entries</div>
            </div>
            <div class="stat-nvc-card">
                <div class="stat-number">{{ logs_data.info_count }}</div>
                <div class="stat-label">Info Entries</div>
            </div>
            <div class="stat-nvc-card">
                <div class="stat-number">{{ logs_data.total_size_mb }}</div>
                <div class="stat-label">Total Size (MB)</div>
            </div>
            <div class="stat-nvc-card">
                <div class="stat-number">{{ logs_data.categories|length }}</div>
                <div class="stat-label">Categories</div>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="log-filters">
            <h4><i class="fas fa-filter"></i> Log Filters</h4>
            <form id="filterForm" class="filter-form">
                <div class="form-group">
                    <label for="categoryFilter">Category</label>
                    <select id="categoryFilter" name="category" class="nvc-form-input">
                        <option value="all" {% if logs_data.filters.category == 'all' %}selected{% endif %}>All Categories</option>
                        {% for category in logs_data.categories %}
                        <option value="{{ category.name }}" {% if logs_data.filters.category == category.name %}selected{% endif %}>
                            {{ category.name|title }} ({{ category.file_count }} files)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="levelFilter">Log Level</label>
                    <select id="levelFilter" name="level" class="nvc-form-input">
                        <option value="all" {% if logs_data.filters.level == 'all' %}selected{% endif %}>All Levels</option>
                        <option value="error" {% if logs_data.filters.level == 'error' %}selected{% endif %}>Error</option>
                        <option value="warning" {% if logs_data.filters.level == 'warning' %}selected{% endif %}>Warning</option>
                        <option value="info" {% if logs_data.filters.level == 'info' %}selected{% endif %}>Info</option>
                        <option value="debug" {% if logs_data.filters.level == 'debug' %}selected{% endif %}>Debug</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="searchFilter">Search Text</label>
                    <input type="text" id="searchFilter" name="search" class="nvc-form-input" 
                           placeholder="Search in log messages..." value="{{ logs_data.filters.search }}">
                </div>
                
                <div class="form-group">
                    <label for="traceIdFilter">Trace ID</label>
                    <input type="text" id="traceIdFilter" name="trace_id" class="nvc-form-input" 
                           placeholder="Enter trace ID for correlation...">
                </div>
                
                <div class="form-group">
                    <label>&nbsp;</label>
                    <div>
                        <button type="submit" class="btn-filter me-2">
                            <i class="fas fa-search"></i> Apply Filters
                        </button>
                        <button type="button" id="clearFilters" class="btn-clear me-2">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button type="button" id="exportLogs" class="btn-export">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Log Entries -->
        <div class="nvc-card">
            <div class="nvc-nvc-card-header" style="background: #1e3a5f; border-color: #66ccff;">
                <h5 class="mb-0 text-white">
                    <i class="fas fa-list"></i> Recent Log Entries 
                    <span id="entryCount" class="badge bg-primary ms-2">{{ logs_data.recent_entries|length }}</span>
                </h5>
            </div>
            <div class="nvc-nvc-card-body" class="nvc-overflow-y-auto">
                <div id="logEntries">
                    {% if logs_data.recent_entries %}
                        {% for entry in logs_data.recent_entries %}
                        <div class="log-entry" data-category="{{ entry.category }}" data-level="{{ entry.level.lower() }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="log-timestamp me-3">{{ entry.timestamp }}</span>
                                        <span class="log-category me-2">{{ entry.category }}</span>
                                        <span class="log-level {{ entry.level.lower() }}">{{ entry.level }}</span>
                                    </div>
                                    <div class="log-message">{{ entry.message }}</div>
                                    <div class="mt-2">
                                        <small class="text-light">
                                            Logger: {{ entry.logger }} | File: {{ entry.file }}
                                        </small>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <button type="button" class="btn btn-sm nvc-btn nvc-btn-outline-info trace-btn" 
                                            data-message="{{ entry.message }}" 
                                            title="Trace related logs">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-logs">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <h5>No log entries found</h5>
                            <p>Try adjusting your filters or check if logs are being generated.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trace Modal -->
<div class="modal fade trace-modal" id="traceModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Trace Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="traceResults"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn nvc-btn nvc-btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
<script>
$(document).ready(function() {
    let realTimeEnabled = false;
    let realTimeInterval;
    
    // Filter form submission
    $('#filterForm').on('submit', function(e) {
        e.preventDefault();
        applyFilters();
    });
    
    // Clear filters
    $('#clearFilters').on('click', function() {
        $('#categoryFilter').val('all');
        $('#levelFilter').val('all');
        $('#searchFilter').val('');
        $('#traceIdFilter').val('');
        window.location.href = window.location.pathname;
    });
    
    // Export logs
    $('#exportLogs').on('click', function() {
        const params = new URLSearchParams();
        params.append('category', $('#categoryFilter').val());
        params.append('level', $('#levelFilter').val());
        params.append('search', $('#searchFilter').val());
        
        window.location.href = '/admin/logs/export?' + params.toString();
    });
    
    // Real-time toggle
    $('#realTimeToggle').on('click', function() {
        realTimeEnabled = !realTimeEnabled;
        
        if (realTimeEnabled) {
            $(this).addClass('active').html('<i class="fas fa-pause"></i> Disable Real-time');
            startRealTimeUpdates();
        } else {
            $(this).removeClass('active').html('<i class="fas fa-play"></i> Enable Real-time');
            stopRealTimeUpdates();
        }
    });
    
    // Trace button click
    $(document).on('click', '.trace-btn', function() {
        const message = $(this).data('message');
        const traceId = $('#traceIdFilter').val() || extractTraceId(message);
        
        if (traceId) {
            performTrace(traceId);
        } else {
            alert('No trace ID found. Please enter a trace ID in the filter or ensure logs contain trace information.');
        }
    });
    
    // Search highlighting
    function highlightSearch(text, search) {
        if (!search) return text;
        const regex = new RegExp(`(${search})`, 'gi');
        return text.replace(regex, '<span class="search-highlight">$1</span>');
    }
    
    // Apply filters
    function applyFilters() {
        const formData = new FormData($('#filterForm')[0]);
        const params = new URLSearchParams(formData);
        
        $.get('/admin/logs/api/filter?' + params.toString())
            .done(function(response) {
                if (response.status === 'success') {
                    updateLogEntries(response.entries);
                    $('#entryCount').text(response.entries.length);
                    updateLastUpdate();
                } else {
                    console.error('Filter error:', response.message);
                }
            })
            .fail(function() {
                console.error('Failed to apply filters');
            });
    }
    
    // Update log entries
    function updateLogEntries(entries) {
        const container = $('#logEntries');
        const searchTerm = $('#searchFilter').val();
        
        if (entries.length === 0) {
            container.html(`
                <div class="no-logs">
                    <i class="fas fa-search fa-3x mb-3"></i>
                    <h5>No log entries found</h5>
                    <p>Try adjusting your filters or check if logs are being generated.</p>
                </div>
            `);
            return;
        }
        
        let html = '';
        entries.forEach(function(entry) {
            const highlightedMessage = highlightSearch(entry.message, searchTerm);
            
            html += `
                <div class="log-entry" data-category="${entry.category}" data-level="${entry.level.toLowerCase()}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <span class="log-timestamp me-3">${entry.timestamp}</span>
                                <span class="log-category me-2">${entry.category}</span>
                                <span class="log-level ${entry.level.toLowerCase()}">${entry.level}</span>
                            </div>
                            <div class="log-message">${highlightedMessage}</div>
                            <div class="mt-2">
                                <small class="text-light">
                                    Logger: ${entry.logger} | File: ${entry.file}
                                </small>
                            </div>
                        </div>
                        <div class="ms-3">
                            <button type="button" class="btn btn-sm nvc-btn nvc-btn-outline-info trace-btn" 
                                    data-message="${entry.message}" 
                                    title="Trace related logs">
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.html(html);
    }
    
    // Real-time updates
    function startRealTimeUpdates() {
        realTimeInterval = setInterval(function() {
            applyFilters();
        }, 5000); // Update every 5 seconds
    }
    
    function stopRealTimeUpdates() {
        if (realTimeInterval) {
            clearInterval(realTimeInterval);
            realTimeInterval = null;
        }
    }
    
    // Perform trace
    function performTrace(traceId) {
        $.get(`/admin/logs/api/trace/${encodeURIComponent(traceId)}`)
            .done(function(response) {
                if (response.status === 'success') {
                    displayTraceResults(response);
                } else {
                    alert('Trace error: ' + response.message);
                }
            })
            .fail(function() {
                alert('Failed to perform trace');
            });
    }
    
    // Display trace results
    function displayTraceResults(response) {
        let html = `<h6>Trace ID: ${response.trace_id}</h6>`;
        html += `<p class="text-light">Found ${response.total} related entries</p>`;
        
        if (response.entries.length === 0) {
            html += '<p>No related log entries found for this trace ID.</p>';
        } else {
            html += '<div class="nvc-style-f4d939">';
            response.entries.forEach(function(entry) {
                html += `
                    <div class="log-entry mb-2">
                        <div class="d-flex align-items-center mb-1">
                            <span class="log-timestamp me-3">${entry.timestamp}</span>
                            <span class="log-category me-2">${entry.category}</span>
                            <span class="log-level ${entry.level.toLowerCase()}">${entry.level}</span>
                        </div>
                        <div class="log-message">${entry.message}</div>
                        <small class="text-light">
                            ${entry.file}:${entry.line_number} | Logger: ${entry.logger}
                        </small>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        $('#traceResults').html(html);
        $('#traceModal').modal('show');
    }
    
    // Extract trace ID from message
    function extractTraceId(message) {
        // Look for common trace ID patterns
        const patterns = [
            /trace[_-]?id[:\s]*([a-f0-9\-]{8,})/i,
            /request[_-]?id[:\s]*([a-f0-9\-]{8,})/i,
            /id[:\s]*([a-f0-9\-]{32,})/i
        ];
        
        for (let pattern of patterns) {
            const match = message.match(pattern);
            if (match) return match[1];
        }
        
        return null;
    }
    
    // Update last update timestamp
    function updateLastUpdate() {
        const now = new Date();
        $('#lastUpdate').text('Last updated: ' + now.toLocaleTimeString());
    }
    
    // Initial update
    updateLastUpdate();
});
</script>
</div>
{% endblock %}