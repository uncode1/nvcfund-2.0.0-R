{% extends "unified_base.html" %}
{% from "components/nvc_components.html" import metric_card, action_card, account_card, transaction_row, form_input, form_select, notification_banner, progress_bar, stats_grid, loading_spinner, empty_state %}


{% block title %}IP Management - NVC Banking Platform{% endblock %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<style>
    .ip-management {
        background: linear-gradient(135deg, #0a2447 0%, #1a365d 100%);
        min-height: 100vh;
        color: #ffffff;
        padding: 20px;
    }
    
    .ip-header {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .ip-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .overview-card {
        background: rgba(255,255,255,0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .overview-card:hover {
        background: rgba(255,255,255,0.15);
        transform: translateY(-3px);
    }
    
    .card-whitelist { border-left: 4px solid #00ff88; }
    .card-blocklist { border-left: 4px solid #ff4444; }
    .card-temporary { border-left: 4px solid #ffaa00; }
    .card-monitoring { border-left: 4px solid #66ccff; }
    .card-countries { border-left: 4px solid #9966ff; }
    
    .card-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .value-success { color: #00ff88; }
    .value-danger { color: #ff4444; }
    .value-warning { color: #ffaa00; }
    .value-info { color: #66ccff; }
    .value-purple { color: #9966ff; }
    
    .card-label {
        font-size: 1rem;
        opacity: 0.8;
    }
    
    .management-sections {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }
    
    .section-container {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .whitelist-section {
        border-top: 3px solid #00ff88;
    }
    
    .blocklist-section {
        border-top: 3px solid #ff4444;
    }
    
    .ip-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .ip-input {
        flex: 1;
        min-width: 200px;
        padding: 10px;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        background: rgba(255,255,255,0.1);
        color: #fff;
        font-family: monospace;
    }
    
    .ip-input:focus {
        outline: none;
        border-color: #66ccff;
        box-shadow: 0 0 5px rgba(102, 204, 255, 0.5);
    }
    
    .ip-list {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 20px;
    }
    
    .ip-item {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
    }
    
    .ip-item:hover {
        background: rgba(255,255,255,0.1);
    }
    
    .ip-info {
        flex: 1;
    }
    
    .ip-address {
        font-family: monospace;
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 5px;
    }
    
    .ip-details {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .ip-actions {
        display: flex;
        gap: 5px;
    }
    
    .geographical-blocking {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 30px;
    }
    
    .country-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .country-item {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .country-item:hover {
        background: rgba(255,255,255,0.1);
    }
    
    .country-blocked {
        border-left: 4px solid #ff4444;
    }
    
    .country-allowed {
        border-left: 4px solid #00ff88;
    }
    
    .country-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .country-flag {
        font-size: 1.5rem;
    }
    
    .country-name {
        font-weight: bold;
    }
    
    .country-stats {
        font-size: 0.8rem;
        opacity: 0.8;
    }
    
    .country-toggle {
        background: none;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 20px;
        padding: 5px 15px;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .toggle-blocked {
        border-color: #ff4444;
        color: #ff4444;
    }
    
    .toggle-allowed {
        border-color: #00ff88;
        color: #00ff88;
    }
    
    .ip-intelligence {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 30px;
    }
    
    .intelligence-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-top: 20px;
    }
    
    .recent-activity {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 30px;
    }
    
    .activity-timeline {
        max-height: 500px;
        overflow-y: auto;
        margin-top: 20px;
    }
    
    .activity-item {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        border-left: 4px solid;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .activity-blocked { border-left-color: #ff4444; }
    .activity-allowed { border-left-color: #00ff88; }
    .activity-flagged { border-left-color: #ffaa00; }
    
    .activity-content {
        flex: 1;
    }
    
    .activity-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .activity-details {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .activity-timestamp {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-left: 15px;
    }
    
    .action-btn {
        background: #66ccff;
        color: #0a2447;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: bold;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 3px;
    }
    
    .action-btn:hover {
        background: #4db8ff;
        transform: scale(1.05);
    }
    
    .action-btn.danger {
        background: #ff4444;
        color: #fff;
    }
    
    .action-btn.success {
        background: #4caf50;
        color: #fff;
    }
    
    .action-btn.warning {
        background: #ffaa00;
        color: #000;
    }
    
    .filters-section {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-input,
    .filter-select {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        padding: 8px;
        color: #fff;
        min-width: 150px;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
    }
    
    .modal-content {
        background: linear-gradient(135deg, #0a2447 0%, #1a365d 100%);
        margin: 5% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 600px;
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: #fff;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #66ccff;
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        background: rgba(255,255,255,0.1);
        color: #fff;
        font-size: 14px;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #66ccff;
        box-shadow: 0 0 5px rgba(102, 204, 255, 0.5);
    }
    
    .realtime-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }
    
    .realtime-dot {
        width: 8px;
        height: 8px;
        background: #00ff88;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="nvc-page-content">
    <div class="ip-management">
    <!-- IP Management Header -->
    <div class="ip-header">
        <div>
            <h1><i class="fas fa-globe"></i> IP Address Management & Geo-blocking</h1>
            <p>Comprehensive IP whitelisting, blacklisting, and geographical access control</p>
        </div>
        <div class="realtime-indicator">
            <span class="realtime-dot"></span>
            <span>Live IP Monitoring</span>
        </div>
    </div>

    <!-- IP Overview -->
    <div class="ip-overview">
        <div class="overview-card nvc-card-whitelist" data-action="custom-action">
            <div class="nvc-card-value value-success" id="whitelist-count">{{ ip_data.whitelist_count or 247 }}</div>
            <div class="nvc-card-label">Whitelisted IPs</div>
        </div>
        
        <div class="overview-card nvc-card-blocklist" data-action="custom-action">
            <div class="nvc-card-value value-danger" id="blocklist-count">{{ ip_data.blocklist_count or 1456 }}</div>
            <div class="nvc-card-label">Blocked IPs</div>
        </div>
        
        <div class="overview-card nvc-card-temporary" data-action="custom-action">
            <div class="nvc-card-value value-warning" id="temp-blocks-count">{{ ip_data.temp_blocks_count or 89 }}</div>
            <div class="nvc-card-label">Temporary Blocks</div>
        </div>
        
        <div class="overview-card nvc-card-monitoring" data-action="custom-action">
            <div class="nvc-card-value value-info" id="monitoring-count">{{ ip_data.monitoring_count or 156 }}</div>
            <div class="nvc-card-label">Under Monitoring</div>
        </div>
        
        <div class="overview-card nvc-card-countries" data-action="custom-action">
            <div class="nvc-card-value value-purple" id="country-blocks-count">{{ ip_data.country_blocks_count or 23 }}</div>
            <div class="nvc-card-label">Blocked Countries</div>
        </div>
    </div>

    <!-- IP Management Sections -->
    <div class="management-sections">
        <!-- Whitelist Management -->
        <div class="section-container whitelist-section">
            <h3><i class="fas fa-shield-check"></i> IP Whitelist Management</h3>
            
            <div class="ip-controls">
                <input type="text" class="ip-input" id="whitelist-ip" placeholder="Enter IP address or CIDR (e.g., 192.168.1.0/24)">
                <button type="button" class="action-btn success" data-action="custom-action">
                    <i class="fas fa-plus"></i> Add to Whitelist
                </button>
                <button type="button" class="action-btn" data-action="custom-action">
                    <i class="fas fa-upload"></i> Import List
                </button>
                <button type="button" class="action-btn" data-action="custom-action">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
            
            <div class="filters-section">
                <input type="text" class="filter-input" id="whitelist-search" placeholder="Search whitelist...">
                <select class="filter-select" id="whitelist-type-filter">
                    <option value="">All Types</option>
                    <option value="single">Single IP</option>
                    <option value="range">IP Range</option>
                    <option value="subnet">Subnet</option>
                    <option value="trusted">Trusted Source</option>
                </select>
            </div>
            
            <div class="ip-list" id="whitelist-container">
                {% set whitelist_ips = [
                    {
                        'ip': '203.0.113.5',
                        'type': 'Trusted Source',
                        'description': 'Corporate Office - Main Branch',
                        'added': '2024-12-15',
                        'added_by': 'admin',
                        'last_seen': '2 hours ago'
                    },
                    {
                        'ip': '198.51.100.0/24',
                        'type': 'Subnet',
                        'description': 'Data Center Network - Primary',
                        'added': '2024-11-20',
                        'added_by': 'security_team',
                        'last_seen': '15 min ago'
                    },
                    {
                        'ip': '192.0.2.10-192.0.2.20',
                        'type': 'IP Range',
                        'description': 'Partner API Access Range',
                        'added': '2024-10-05',
                        'added_by': 'api_admin',
                        'last_seen': '1 hour ago'
                    }
                ] %}
                
                {% for ip in whitelist_ips %}
                <div class="ip-item">
                    <div class="ip-info">
                        <div class="ip-address">{{ ip.ip }}</div>
                        <div class="ip-details">
                            <strong>{{ ip.type }}</strong> â€¢ {{ ip.description }}<br>
                            Added by {{ ip.added_by }} on {{ ip.added }} â€¢ Last seen: {{ ip.last_seen }}
                        </div>
                    </div>
                    <div class="ip-actions">
                        <button type="button" class="action-btn" data-action="custom-action" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="action-btn warning" data-action="custom-action" title="Details">
                            <i class="fas fa-info"></i>
                        </button>
                        <button type="button" class="action-btn danger" data-action="custom-action" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Blocklist Management -->
        <div class="section-container blocklist-section">
            <h3><i class="fas fa-ban"></i> IP Blocklist Management</h3>
            
            <div class="ip-controls">
                <input type="text" class="ip-input" id="blocklist-ip" placeholder="Enter IP address or CIDR to block">
                <button type="button" class="action-btn danger" data-action="custom-action">
                    <i class="fas fa-ban"></i> Block IP
                </button>
                <button type="button" class="action-btn warning" data-action="custom-action">
                    <i class="fas fa-clock"></i> Temp Block
                </button>
                <button type="button" class="action-btn" data-action="custom-action">
                    <i class="fas fa-upload"></i> Import List
                </button>
            </div>
            
            <div class="filters-section">
                <input type="text" class="filter-input" id="blocklist-search" placeholder="Search blocklist...">
                <select class="filter-select" id="blocklist-reason-filter">
                    <option value="">All Reasons</option>
                    <option value="malicious">Malicious Activity</option>
                    <option value="spam">Spam/Abuse</option>
                    <option value="fraud">Fraud Attempt</option>
                    <option value="policy">Policy Violation</option>
                    <option value="geographic">Geographic Block</option>
                </select>
                <select class="filter-select" id="blocklist-duration-filter">
                    <option value="">All Durations</option>
                    <option value="permanent">Permanent</option>
                    <option value="temporary">Temporary</option>
                    <option value="expired">Expired</option>
                </select>
            </div>
            
            <div class="ip-list" id="blocklist-container">
                {% set blocklist_ips = [
                    {
                        'ip': '185.220.101.47',
                        'reason': 'Malicious Activity',
                        'description': 'Multiple SQL injection attempts',
                        'blocked': '2025-01-10',
                        'blocked_by': 'auto_system',
                        'duration': 'Permanent',
                        'threat_score': 95
                    },
                    {
                        'ip': '103.85.24.156',
                        'reason': 'Fraud Attempt',
                        'description': 'Credential stuffing attack',
                        'blocked': '2025-01-08',
                        'blocked_by': 'security_analyst',
                        'duration': 'Permanent',
                        'threat_score': 88
                    },
                    {
                        'ip': '45.142.214.98',
                        'reason': 'Spam/Abuse',
                        'description': 'Automated scanning attempts',
                        'blocked': '2025-01-05',
                        'blocked_by': 'auto_system',
                        'duration': '7 days (expires in 2 days)',
                        'threat_score': 72
                    }
                ] %}
                
                {% for ip in blocklist_ips %}
                <div class="ip-item">
                    <div class="ip-info">
                        <div class="ip-address">{{ ip.ip }}</div>
                        <div class="ip-details">
                            <strong>{{ ip.reason }}</strong> â€¢ {{ ip.description }}<br>
                            Blocked by {{ ip.blocked_by }} on {{ ip.blocked }} â€¢ Duration: {{ ip.duration }}<br>
                            <strong>Threat Score:</strong> {{ ip.threat_score }%}
                        </div>
                    </div>
                    <div class="ip-actions">
                        <button type="button" class="action-btn" data-action="custom-action" title="Details">
                            <i class="fas fa-info"></i>
                        </button>
                        <button type="button" class="action-btn warning" data-action="custom-action" title="Extend Block">
                            <i class="fas fa-clock"></i>
                        </button>
                        <button type="button" class="action-btn success" data-action="custom-action" title="Unblock">
                            <i class="fas fa-unlock"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Geographical Blocking -->
    <div class="geographical-blocking">
        <h3><i class="fas fa-map-marked-alt"></i> Geographical Access Control</h3>
        
        <div class="filters-section">
            <input type="text" class="filter-input" id="country-search" placeholder="Search countries...">
            <select class="filter-select" id="region-filter">
                <option value="">All Regions</option>
                <option value="africa">Africa</option>
                <option value="asia">Asia</option>
                <option value="europe">Europe</option>
                <option value="north-america">North America</option>
                <option value="south-america">South America</option>
                <option value="oceania">Oceania</option>
            </select>
            <select class="filter-select" id="status-filter">
                <option value="">All Status</option>
                <option value="blocked">Blocked</option>
                <option value="allowed">Allowed</option>
                <option value="monitored">Monitored</option>
            </select>
            <button type="button" class="action-btn" data-action="custom-action">
                <i class="fas fa-tasks"></i> Bulk Actions
            </button>
        </div>
        
        <div class="country-grid" id="countries-container">
            {% set countries = [
                {'code': 'US', 'name': 'United States', 'flag': 'ðŸ‡ºðŸ‡¸', 'status': 'allowed', 'connections': '45,231', 'threat_level': 'Low'},
                {'code': 'GB', 'name': 'United Kingdom', 'flag': 'ðŸ‡¬ðŸ‡§', 'status': 'allowed', 'connections': '12,456', 'threat_level': 'Low'},
                {'code': 'CA', 'name': 'Canada', 'flag': 'ðŸ‡¨ðŸ‡¦', 'status': 'allowed', 'connections': '8,921', 'threat_level': 'Low'},
                {'code': 'RU', 'name': 'Russia', 'flag': 'ðŸ‡·ðŸ‡º', 'status': 'blocked', 'connections': '0', 'threat_level': 'High'},
                {'code': 'CN', 'name': 'China', 'flag': 'ðŸ‡¨ðŸ‡³', 'status': 'blocked', 'connections': '0', 'threat_level': 'High'},
                {'code': 'IR', 'name': 'Iran', 'flag': 'ðŸ‡®ðŸ‡·', 'status': 'blocked', 'connections': '0', 'threat_level': 'Critical'},
                {'code': 'KP', 'name': 'North Korea', 'flag': 'ðŸ‡°ðŸ‡µ', 'status': 'blocked', 'connections': '0', 'threat_level': 'Critical'},
                {'code': 'DE', 'name': 'Germany', 'flag': 'ðŸ‡©ðŸ‡ª', 'status': 'allowed', 'connections': '6,789', 'threat_level': 'Low'},
                {'code': 'FR', 'name': 'France', 'flag': 'ðŸ‡«ðŸ‡·', 'status': 'allowed', 'connections': '5,432', 'threat_level': 'Low'},
                {'code': 'AU', 'name': 'Australia', 'flag': 'ðŸ‡¦ðŸ‡º', 'status': 'allowed', 'connections': '3,210', 'threat_level': 'Low'}
            ] %}
            
            {% for country in countries %}
            <div class="country-item country-{{ country.status }}" data-action="custom-action">
                <div class="country-info">
                    <div class="country-flag">{{ country.flag }}</div>
                    <div>
                        <div class="country-name">{{ country.name }}</div>
                        <div class="country-stats">{{ country.connections }} connections â€¢ {{ country.threat_level }} threat</div>
                    </div>
                </div>
                <button type="button" class="country-toggle toggle-{{ country.status }}" data-action="custom-action">
                    {{ 'BLOCKED' if country.status == 'blocked' else 'ALLOWED' }}
                </button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- IP Intelligence & Analytics -->
    <div class="ip-intelligence">
        <h3><i class="fas fa-brain"></i> IP Intelligence & Analytics</h3>
        
        <div class="intelligence-grid">
            <div>
                <h4>Threat Intelligence Feed</h4>
                <canvas id="threatIntelChart" width="400" height="300"></canvas>
            </div>
            
            <div>
                <h4>Geographic Distribution</h4>
                <canvas id="geoDistributionChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="recent-activity">
        <h3><i class="fas fa-history"></i> Recent IP Activity</h3>
        
        <div class="filters-section">
            <select class="filter-select" id="activity-type-filter">
                <option value="">All Activities</option>
                <option value="blocked">IP Blocked</option>
                <option value="allowed">IP Allowed</option>
                <option value="flagged">IP Flagged</option>
                <option value="whitelist">Added to Whitelist</option>
                <option value="removed">Removed from Lists</option>
            </select>
            <select class="filter-select" id="time-filter">
                <option value="1h">Last Hour</option>
                <option value="24h" selected>Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
            </select>
            <button type="button" class="action-btn" data-action="custom-action">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
        
        <div class="activity-timeline" id="activity-container">
            {% set activities = [
                {
                    'type': 'blocked',
                    'title': 'IP Address Automatically Blocked',
                    'ip': '185.220.101.47',
                    'details': 'Detected multiple SQL injection attempts from Russia',
                    'time': '5 minutes ago'
                },
                {
                    'type': 'flagged',
                    'title': 'Suspicious IP Activity',
                    'ip': '103.85.24.156',
                    'details': 'Unusual traffic pattern detected - flagged for review',
                    'time': '12 minutes ago'
                },
                {
                    'type': 'allowed',
                    'title': 'IP Added to Whitelist',
                    'ip': '203.0.113.15',
                    'details': 'Trusted partner IP address added by security team',
                    'time': '25 minutes ago'
                },
                {
                    'type': 'blocked',
                    'title': 'Geographic Block Applied',
                    'ip': '91.203.67.123',
                    'details': 'Connection blocked due to country-level restrictions',
                    'time': '45 minutes ago'
                },
                {
                    'type': 'flagged',
                    'title': 'Rate Limit Exceeded',
                    'ip': '198.23.145.78',
                    'details': 'IP flagged for exceeding API rate limits',
                    'time': '1 hour ago'
                }
            ] %}
            
            {% for activity in activities %}
            <div class="activity-item activity-{{ activity.type }}">
                <div class="activity-content">
                    <div class="activity-title">{{ activity.title }}</div>
                    <div class="activity-details">
                        <strong>IP:</strong> {{ activity.ip }} â€¢ {{ activity.details }}
                    </div>
                </div>
                <div class="activity-timestamp">{{ activity.time }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- IP Details Modal -->
<div id="ipDetailsModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modal-title"><i class="fas fa-info-circle"></i> IP Address Details</h2>
        <div id="ip-details-content">
            <!-- Dynamic content will be loaded here -->
        </div>
    </div>
</div>

<!-- Add IP Modal -->
<div id="addIPModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="add-modal-title"><i class="fas fa-plus"></i> Add IP Address</h2>
        <form id="add-ip-form">
            <div class="form-group">
                <label for="ip-address">IP Address/CIDR</label>
                <input type="text" id="ip-address" class="nvc-form-input" placeholder="192.168.1.1 or 192.168.1.0/24" required>
            </div>
            
            <div class="form-group">
                <label for="ip-type">Type</label>
                <select id="ip-type" class="nvc-form-input" required>
                    <option value="">Select type</option>
                    <option value="single">Single IP</option>
                    <option value="range">IP Range</option>
                    <option value="subnet">Subnet/CIDR</option>
                    <option value="trusted">Trusted Source</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="ip-description">Description</label>
                <textarea id="ip-description" class="nvc-form-input" rows="3" placeholder="Enter description or reason"></textarea>
            </div>
            
            <div class="form-group" id="duration-group" class="d-none">
                <label for="block-duration">Block Duration</label>
                <select id="block-duration" class="nvc-form-input">
                    <option value="permanent">Permanent</option>
                    <option value="1h">1 Hour</option>
                    <option value="24h">24 Hours</option>
                    <option value="7d">7 Days</option>
                    <option value="30d">30 Days</option>
                </select>
            </div>
            
            <div style="gap: var(--nvc-space-md)">
                <button type="button" class="action-btn" data-action="custom-action">Cancel</button>
                <button type="submit" class="action-btn success">Add IP</button>
            </div>
        </form>
    </div>
</div>

<script>
// Socket.IO connection for real-time IP management data
const socket = io('/security-center');

// Chart instances
let threatIntelChart, geoDistributionChart;

// Current modal state
let currentAction = 'whitelist';

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setupEventListeners();
    
    // Connect to socket for real-time updates
    if (socket.connected) {
        socket.emit('request_ip_data');
    }
});

// Socket event handlers
socket.on('connect', function() {
    console.log('Connected to security center socket for IP management');
    socket.emit('request_ip_data');
});

socket.on('ip_blocked', function(data) {
    addActivityItem('blocked', `IP Address Blocked: ${data.ip}`, data.ip, data.reason, 'Just now');
    updateIPCounts();
});

socket.on('ip_whitelisted', function(data) {
    addActivityItem('allowed', `IP Address Whitelisted: ${data.ip}`, data.ip, data.reason, 'Just now');
    updateIPCounts();
});

socket.on('threat_intel_update', function(data) {
    updateThreatIntelChart(data);
});

socket.on('geo_stats_update', function(data) {
    updateGeoDistributionChart(data);
});

// Initialize charts
function initializeCharts() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: { color: '#ffffff' }
            }
        },
        scales: {
            x: {
                ticks: { color: '#ffffff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
                ticks: { color: '#ffffff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    };

    // Threat Intelligence Chart
    const threatCtx = document.getElementById('threatIntelChart').getContext('2d');
    threatIntelChart = new Chart(threatCtx, {
        type: 'line',
        data: {
            labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
            datasets: [
                {
                    label: 'Blocked IPs',
                    data: [23, 45, 67, 89, 123, 98, 67],
                    borderColor: '#ff4444',
                    backgroundColor: 'rgba(255, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Flagged IPs',
                    data: [12, 23, 34, 45, 56, 43, 32],
                    borderColor: '#ffaa00',
                    backgroundColor: 'rgba(255, 170, 0, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: chartOptions
    });

    // Geographic Distribution Chart
    const geoCtx = document.getElementById('geoDistributionChart').getContext('2d');
    geoDistributionChart = new Chart(geoCtx, {
        type: 'doughnut',
        data: {
            labels: ['North America', 'Europe', 'Asia', 'Blocked Regions', 'Other'],
            datasets: [{
                data: [45, 25, 15, 10, 5],
                backgroundColor: [
                    '#00ff88',
                    '#66ccff',
                    '#9966ff',
                    '#ff4444',
                    '#ffaa00'
                ],
                borderWidth: 2,
                borderColor: '#0a2447'
            }]
        },
        options: {
            ...chartOptions,
            scales: {} // Remove scales for doughnut chart
        }
    });
}

// Setup event listeners
function setupEventListeners() {
    // Search filters
    document.getElementById('whitelist-search').addEventListener('input', filterWhitelist);
    document.getElementById('blocklist-search').addEventListener('input', filterBlocklist);
    document.getElementById('country-search').addEventListener('input', filterCountries);
    
    // Filter dropdowns
    document.getElementById('whitelist-type-filter').addEventListener('change', filterWhitelist);
    document.getElementById('blocklist-reason-filter').addEventListener('change', filterBlocklist);
    document.getElementById('blocklist-duration-filter').addEventListener('change', filterBlocklist);
    document.getElementById('region-filter').addEventListener('change', filterCountries);
    document.getElementById('status-filter').addEventListener('change', filterCountries);
    document.getElementById('activity-type-filter').addEventListener('change', filterActivity);
    document.getElementById('time-filter').addEventListener('change', function() {
        const timeframe = this.value;
        socket.emit('request_ip_data', { timeframe: timeframe });
    });
    
    // Modal close events
    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
        });
    });
    
    window.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });
    
    // Form submission
    document.getElementById('add-ip-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitIPForm();
    });
}

// Update functions
function updateThreatIntelChart(data) {
    if (threatIntelChart && data.labels) {
        threatIntelChart.data.labels = data.labels;
        threatIntelChart.data.datasets[0].data = data.blocked || [];
        threatIntelChart.data.datasets[1].data = data.flagged || [];
        threatIntelChart.update('none');
    }
}

function updateGeoDistributionChart(data) {
    if (geoDistributionChart && data.labels) {
        geoDistributionChart.data.labels = data.labels;
        geoDistributionChart.data.datasets[0].data = data.values || [];
        geoDistributionChart.update('none');
    }
}

function updateIPCounts() {
    // Recalculate counts from displayed items
    const whitelistItems = document.querySelectorAll('#whitelist-container .ip-item').length;
    const blocklistItems = document.querySelectorAll('#blocklist-container .ip-item').length;
    
    document.getElementById('whitelist-count').textContent = whitelistItems;
    document.getElementById('blocklist-count').textContent = blocklistItems;
}

function addActivityItem(type, title, ip, details, time) {
    const container = document.getElementById('activity-container');
    const item = document.createElement('div');
    item.className = `activity-item activity-${type}`;
    item.innerHTML = `
        <div class="activity-content">
            <div class="activity-title">${title}</div>
            <div class="activity-details">
                <strong>IP:</strong> ${ip} â€¢ ${details}
            </div>
        </div>
        <div class="activity-timestamp">${time}</div>
    `;
    
    container.insertBefore(item, container.firstChild);
    
    // Keep only latest 20 activities
    while (container.children.length > 20) {
        container.removeChild(container.lastChild);
    }
}

// Navigation functions
function viewWhitelist() {
    document.getElementById('whitelist-container').scrollIntoView({ behavior: 'smooth' });
}

function viewBlocklist() {
    document.getElementById('blocklist-container').scrollIntoView({ behavior: 'smooth' });
}

function viewTemporaryBlocks() {
    window.location.href = '/security/ip/temporary-blocks';
}

function viewMonitoredIPs() {
    window.location.href = '/security/ip/monitoring';
}

function viewCountryBlocks() {
    document.getElementById('countries-container').scrollIntoView({ behavior: 'smooth' });
}

// IP Management functions
function addToWhitelist() {
    currentAction = 'whitelist';
    document.getElementById('add-modal-title').innerHTML = '<i class="fas fa-shield-check"></i> Add to Whitelist';
    document.getElementById('duration-group').style.display = 'none';
    document.getElementById('addIPModal').style.display = 'block';
}

function addToBlocklist() {
    currentAction = 'blocklist';
    document.getElementById('add-modal-title').innerHTML = '<i class="fas fa-ban"></i> Add to Blocklist';
    document.getElementById('duration-group').style.display = 'none';
    document.getElementById('addIPModal').style.display = 'block';
}

function addTemporaryBlock() {
    currentAction = 'temporary';
    document.getElementById('add-modal-title').innerHTML = '<i class="fas fa-clock"></i> Add Temporary Block';
    document.getElementById('duration-group').style.display = 'block';
    document.getElementById('addIPModal').style.display = 'block';
}

function submitIPForm() {
    const ipAddress = document.getElementById('ip-address').value;
    const ipType = document.getElementById('ip-type').value;
    const description = document.getElementById('ip-description').value;
    const duration = document.getElementById('block-duration').value;
    
    if (!ipAddress || !ipType) {
        alert('Please fill in all required fields');
        return;
    }
    
    const data = {
        ip_address: ipAddress,
        type: ipType,
        description: description,
        action: currentAction,
        duration: currentAction === 'temporary' ? duration : null
    };
    
    const endpoint = currentAction === 'whitelist' ? 'whitelist' : 'blocklist';
    
    fetch(`/security/api/ip/${endpoint}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`IP address ${currentAction === 'whitelist' ? 'whitelisted' : 'blocked'} successfully`);
            closeModal('addIPModal');
            refreshIPLists();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error processing request');
    });
}

function removeFromWhitelist(ip) {
    if (confirm(`Remove ${ip} from whitelist?`)) {
        fetch(`/security/api/ip/whitelist/${encodeURIComponent(ip)}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('IP removed from whitelist successfully');
                refreshIPLists();
            } else {
                alert('Error removing IP: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error removing IP');
        });
    }
}

function unblockIP(ip) {
    if (confirm(`Unblock ${ip}?`)) {
        fetch(`/security/api/ip/blocklist/${encodeURIComponent(ip)}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('IP unblocked successfully');
                refreshIPLists();
            } else {
                alert('Error unblocking IP: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error unblocking IP');
        });
    }
}

function viewIPDetails(ip) {
    fetch(`/security/api/ip/details/${encodeURIComponent(ip)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayIPDetails(data.details);
            } else {
                alert('Error loading IP details: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading IP details');
        });
}

function displayIPDetails(details) {
    const content = document.getElementById('ip-details-content');
    content.innerHTML = `
        <div class="nvc-style-a52492">
            <div>
                <h4>Basic Information</h4>
                <p><strong>IP Address:</strong> ${details.ip}</p>
                <p><strong>Country:</strong> ${details.country || 'Unknown'}</p>
                <p><strong>ISP:</strong> ${details.isp || 'Unknown'}</p>
                <p><strong>Organization:</strong> ${details.org || 'Unknown'}</p>
            </div>
            <div>
                <h4>Security Information</h4>
                <p><strong>Threat Score:</strong> ${details.threat_score || 'N/A'%}</p>
                <p><strong>Reputation:</strong> ${details.reputation || 'Unknown'}</p>
                <p><strong>VPN/Proxy:</strong> ${details.is_vpn ? 'Yes' : 'No'}</p>
                <p><strong>Last Seen:</strong> ${details.last_seen || 'Never'}</p>
            </div>
        </div>
        <div class="mt-4">
            <h4>Recent Activity</h4>
            <div class="nvc-overflow-y-auto">
                ${details.recent_activity ? details.recent_activity.map(activity => `
                    <div class="p-2">
                        <strong>${activity.action}</strong> - ${activity.timestamp}<br>
                        ${activity.description}
                    </div>
                `).join('') : '<p>No recent activity</p>'}
            </div>
        </div>
    `;
    
    document.getElementById('ipDetailsModal').style.display = 'block';
}

function toggleCountryAccess(countryCode) {
    const countryItem = document.querySelector(`[onclick*="${countryCode}"]`);
    const currentStatus = countryItem.classList.contains('country-blocked') ? 'blocked' : 'allowed';
    const newStatus = currentStatus === 'blocked' ? 'allowed' : 'blocked';
    
    if (confirm(`${newStatus === 'blocked' ? 'Block' : 'Allow'} access from ${countryCode}?`)) {
        fetch('/security/api/ip/country-access', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                country_code: countryCode,
                action: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI
                countryItem.className = `country-item country-${newStatus}`;
                const toggle = countryItem.querySelector('.country-toggle');
                toggle.className = `country-toggle toggle-${newStatus}`;
                toggle.textContent = newStatus.toUpperCase();
                
                alert(`Country access ${newStatus} successfully`);
            } else {
                alert('Error updating country access: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating country access');
        });
    }
}

// Import/Export functions
function importWhitelist() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.txt,.csv,.json';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('ip_list', file);
            
            fetch('/security/api/ip/import/whitelist', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Successfully imported ${data.count} IP addresses to whitelist`);
                    refreshIPLists();
                } else {
                    alert('Error importing whitelist: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error importing whitelist');
            });
        }
    };
    input.click();
}

function exportWhitelist() {
    window.location.href = '/security/ip/export/whitelist';
}

function importBlocklist() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.txt,.csv,.json';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('ip_list', file);
            
            fetch('/security/api/ip/import/blocklist', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Successfully imported ${data.count} IP addresses to blocklist`);
                    refreshIPLists();
                } else {
                    alert('Error importing blocklist: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error importing blocklist');
            });
        }
    };
    input.click();
}

function bulkCountryActions() {
    const action = prompt('Bulk action:\n1. Block all high-risk countries\n2. Allow all low-risk countries\n3. Reset all to default\n\nEnter number:');
    if (action && action >= 1 && action <= 3) {
        const actions = ['block-high-risk', 'allow-low-risk', 'reset-default'];
        
        if (confirm(`Execute bulk action: ${actions[action - 1]}?`)) {
            fetch('/security/api/ip/bulk-country-action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: actions[action - 1] })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Bulk action completed. ${data.affected_countries} countries updated.`);
                    location.reload();
                } else {
                    alert('Error executing bulk action: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error executing bulk action');
            });
        }
    }
}

// Filter functions
function filterWhitelist() {
    const search = document.getElementById('whitelist-search').value.toLowerCase();
    const typeFilter = document.getElementById('whitelist-type-filter').value;
    
    const items = document.querySelectorAll('#whitelist-container .ip-item');
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        const type = item.querySelector('.ip-details').textContent.toLowerCase();
        
        const matchesSearch = !search || text.includes(search);
        const matchesType = !typeFilter || type.includes(typeFilter.toLowerCase());
        
        item.style.display = matchesSearch && matchesType ? '' : 'none';
    });
}

function filterBlocklist() {
    const search = document.getElementById('blocklist-search').value.toLowerCase();
    const reasonFilter = document.getElementById('blocklist-reason-filter').value;
    const durationFilter = document.getElementById('blocklist-duration-filter').value;
    
    const items = document.querySelectorAll('#blocklist-container .ip-item');
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        
        const matchesSearch = !search || text.includes(search);
        const matchesReason = !reasonFilter || text.includes(reasonFilter.toLowerCase());
        const matchesDuration = !durationFilter || text.includes(durationFilter.toLowerCase());
        
        item.style.display = matchesSearch && matchesReason && matchesDuration ? '' : 'none';
    });
}

function filterCountries() {
    const search = document.getElementById('country-search').value.toLowerCase();
    const regionFilter = document.getElementById('region-filter').value;
    const statusFilter = document.getElementById('status-filter').value;
    
    const items = document.querySelectorAll('#countries-container .country-item');
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        const status = item.classList.contains('country-blocked') ? 'blocked' : 'allowed';
        
        const matchesSearch = !search || text.includes(search);
        const matchesStatus = !statusFilter || status === statusFilter;
        
        item.style.display = matchesSearch && matchesStatus ? '' : 'none';
    });
}

function filterActivity() {
    const typeFilter = document.getElementById('activity-type-filter').value;
    
    const items = document.querySelectorAll('#activity-container .activity-item');
    items.forEach(item => {
        const classes = item.className;
        const matchesType = !typeFilter || classes.includes(`activity-${typeFilter}`);
        
        item.style.display = matchesType ? '' : 'none';
    });
}

// Utility functions
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function refreshIPLists() {
    socket.emit('request_ip_data');
}

function refreshActivity() {
    const timeframe = document.getElementById('time-filter').value;
    socket.emit('request_ip_data', { timeframe: timeframe });
}

function editWhitelistIP(ip) {
    // Implementation for editing whitelist entries
    console.log(`Edit functionality for ${ip} - Implementation in progress`);
}

function extendBlock(ip) {
    const duration = prompt('Extend block duration:\n1. 1 Hour\n2. 24 Hours\n3. 7 Days\n4. 30 Days\n5. Permanent\n\nEnter number:');
    if (duration && duration >= 1 && duration <= 5) {
        const durations = ['1h', '24h', '7d', '30d', 'permanent'];
        
        fetch(`/security/api/ip/extend-block/${encodeURIComponent(ip)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ duration: durations[duration - 1] })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Block duration extended successfully');
                refreshIPLists();
            } else {
                alert('Error extending block: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error extending block');
        });
    }
}
</script>
</div>
{% endblock %}