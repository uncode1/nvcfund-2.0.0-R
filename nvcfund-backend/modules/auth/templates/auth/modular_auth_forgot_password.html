{% extends "public/public_base.html" %}
{% from "components/nvc_components.html" import metric_card, action_card, account_card, transaction_row, form_input, form_select, notification_banner, progress_bar, stats_grid, loading_spinner, empty_state %}

{% block title %}Password Recovery - NVC Banking Platform{% endblock %}

{% block content %}
<!-- Modern NVC Password Recovery Hero Section -->
<section class="nvc-auth-hero">
    <div class="nvc-auth-container">
        <div class="nvc-auth-layout">
            <div class="nvc-auth-content">
                <div class="nvc-auth-grid">
                    <!-- Security Information Section -->
                    <div class="nvc-auth-welcome">
                        <div class="nvc-welcome-content">
                            <div class="nvc-welcome-header">
                                <div class="nvc-brand-icon">
                                    <i class="fas fa-key" aria-hidden="true"></i>
                                </div>
                                <h1 class="nvc-welcome-title nvc-wcag-high-contrast">Password Recovery</h1>
                                <p class="nvc-welcome-subtitle nvc-wcag-medium-contrast">
                                    Secure password reset for your NVC Banking account with enterprise-grade security and audit logging.
                                </p>
                            </div>

                            <!-- Security Features Grid -->
                            <div class="nvc-trust-features">
                                <div class="nvc-features-grid">
                                    <div class="nvc-feature-item">
                                        <div class="nvc-feature-icon nvc-feature-security">
                                            <i class="fas fa-shield-check" aria-hidden="true"></i>
                                        </div>
                                        <div class="nvc-feature-content">
                                            <h3 class="nvc-feature-title nvc-wcag-high-contrast">100% Secure Process</h3>
                                            <p class="nvc-feature-description nvc-wcag-medium-contrast">End-to-end encrypted recovery</p>
                                        </div>
                                    </div>

                                    <div class="nvc-feature-item">
                                        <div class="nvc-feature-icon nvc-feature-time">
                                            <i class="fas fa-clock" aria-hidden="true"></i>
                                        </div>
                                        <div class="nvc-feature-content">
                                            <h3 class="nvc-feature-title nvc-wcag-high-contrast">Quick Recovery</h3>
                                            <p class="nvc-feature-description nvc-wcag-medium-contrast">Reset link delivered in under 5 minutes</p>
                                        </div>
                                    </div>

                                    <div class="nvc-feature-item">
                                        <div class="nvc-feature-icon nvc-feature-audit">
                                            <i class="fas fa-file-shield" aria-hidden="true"></i>
                                        </div>
                                        <div class="nvc-feature-content">
                                            <h3 class="nvc-feature-title nvc-wcag-high-contrast">FINRA Compliant</h3>
                                            <p class="nvc-feature-description nvc-wcag-medium-contrast">Full audit trail and compliance logging</p>
                                        </div>
                                    </div>

                                    <div class="nvc-feature-item">
                                        <div class="nvc-feature-icon nvc-feature-support">
                                            <i class="fas fa-headset" aria-hidden="true"></i>
                                        </div>
                                        <div class="nvc-feature-content">
                                            <h3 class="nvc-feature-title nvc-wcag-high-contrast">24/7 Support</h3>
                                            <p class="nvc-feature-description nvc-wcag-medium-contrast">Expert assistance available anytime</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modern Password Recovery Form -->
                    <div class="nvc-auth-form">
                        <div class="nvc-recovery-card">
                            <!-- Form Header -->
                            <div class="nvc-form-header">
                                <div class="nvc-form-icon">
                                    <i class="fas fa-key" aria-hidden="true"></i>
                                </div>
                                <h2 class="nvc-form-title nvc-wcag-high-contrast">Password Recovery</h2>
                                <p class="nvc-form-subtitle nvc-wcag-medium-contrast">Enter your email address and we'll send you a secure reset link</p>
                            </div>

                            <!-- Flash Messages -->
                            {% with messages = get_flashed_messages(with_categories=true) %}
                                {% if messages %}
                                    <div class="nvc-flash-messages">
                                        {% for category, message in messages %}
                                            <div class="nvc-alert nvc-alert-{{ 'danger' if category == 'error' else 'info' if category == 'info' else 'success' }}" role="alert">
                                                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' if category == 'info' else 'check-circle' }}" aria-hidden="true"></i>
                                                <span>{{ message }}</span>
                                                <button type="button" class="nvc-alert-close nvc-wcag-focus" aria-label="Dismiss alert">
                                                    <i class="fas fa-times" aria-hidden="true"></i>
                                                </button>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endwith %}

                            <!-- Password Recovery Form -->
                            <form method="POST" action="{{ url_for('auth.forgot_password') if url_for else '#' }}" class="nvc-auth-form-container" novalidate>
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}"/>

                                <!-- Email Field -->
                                <div class="nvc-form-group">
                                    <label for="email" class="nvc-form-label nvc-wcag-high-contrast">
                                        <i class="fas fa-envelope" aria-hidden="true"></i>
                                        Email Address
                                    </label>
                                    <div class="nvc-input-container">
                                        <input type="email"
                                               class="nvc-form-control nvc-wcag-focus"
                                               id="email"
                                               name="email"
                                               required
                                               placeholder="Enter your registered email address"
                                               aria-describedby="email-help email-error"
                                               autocomplete="email">
                                        <div class="nvc-input-icon">
                                            <i class="fas fa-envelope" aria-hidden="true"></i>
                                        </div>
                                        <div class="nvc-verification-indicator" id="email-verification"></div>
                                    </div>
                                    <div id="email-help" class="nvc-form-help nvc-wcag-medium-contrast">
                                        <i class="fas fa-info-circle" aria-hidden="true"></i>
                                        We'll send recovery instructions to this email address
                                    </div>
                                    <div id="email-error" class="nvc-form-error" role="alert" aria-live="polite"></div>
                                </div>

                                <!-- Security Information -->
                                <div class="nvc-security-info">
                                    <div class="nvc-security-items">
                                        <div class="nvc-security-item">
                                            <i class="fas fa-shield-check" aria-hidden="true"></i>
                                            <span class="nvc-wcag-medium-contrast">Secure encrypted process</span>
                                        </div>
                                        <div class="nvc-security-item">
                                            <i class="fas fa-clock" aria-hidden="true"></i>
                                            <span class="nvc-wcag-medium-contrast">Link expires in 15 minutes</span>
                                        </div>
                                        <div class="nvc-security-item">
                                            <i class="fas fa-file-shield" aria-hidden="true"></i>
                                            <span class="nvc-wcag-medium-contrast">FINRA compliant audit trail</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <button type="submit"
                                        class="nvc-btn nvc-btn-primary nvc-btn-lg nvc-btn-full nvc-wcag-focus"
                                        aria-describedby="recovery-status">
                                    <span class="nvc-btn-content">
                                        <i class="fas fa-paper-plane" aria-hidden="true"></i>
                                        Send Recovery Instructions
                                    </span>
                                    <span class="nvc-btn-loading" style="display: none;">
                                        <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
                                        Sending Instructions...
                                    </span>
                                </button>
                                <div id="recovery-status" class="nvc-form-status" role="status" aria-live="polite"></div>

                                <!-- Form Footer -->
                                <div class="nvc-form-footer">
                                    <div class="nvc-divider">
                                        <span class="nvc-divider-text nvc-wcag-medium-contrast">or</span>
                                    </div>

                                    <!-- Back to Login -->
                                    <div class="nvc-signin-section">
                                        <p class="nvc-signin-text nvc-wcag-medium-contrast">Remember your password?</p>
                                        <a href="{{ url_for('auth.login') if url_for else '#' }}"
                                           class="nvc-btn nvc-btn-outline nvc-btn-full nvc-wcag-focus"
                                           aria-label="Return to login page">
                                            <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                                            Back to Login
                                        </a>
                                    </div>

                                    <!-- Support Links -->
                                    <div class="nvc-support-section">
                                        <h3 class="nvc-support-title nvc-wcag-high-contrast">Need Additional Help?</h3>
                                        <div class="nvc-support-links">
                                            <a href="{{ url_for('public.contact') if url_for else '#' }}"
                                               class="nvc-support-link nvc-wcag-focus"
                                               aria-label="Contact customer support">
                                                <i class="fas fa-phone" aria-hidden="true"></i>
                                                Call Support
                                            </a>
                                            <a href="#"
                                               class="nvc-support-link nvc-wcag-focus"
                                               aria-label="Start live chat">
                                                <i class="fas fa-comments" aria-hidden="true"></i>
                                                Live Chat
                                            </a>
                                            <a href="#"
                                               class="nvc-support-link nvc-wcag-focus"
                                               aria-label="View help documentation">
                                                <i class="fas fa-book" aria-hidden="true"></i>
                                                Help Guide
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

<!-- Recovery Process Information -->
<section class="nvc-recovery-info">
    <div class="nvc-recovery-container">
        <div class="nvc-recovery-content">
            <div class="nvc-recovery-steps">
                <h2 class="nvc-steps-title nvc-wcag-high-contrast">Password Recovery Process</h2>
                <div class="nvc-steps-grid">
                    <div class="nvc-step-item">
                        <div class="nvc-step-icon">
                            <i class="fas fa-envelope" aria-hidden="true"></i>
                        </div>
                        <div class="nvc-step-content">
                            <h3 class="nvc-step-title nvc-wcag-high-contrast">1. Check Your Email</h3>
                            <p class="nvc-step-description nvc-wcag-medium-contrast">Recovery instructions will be sent instantly to your registered email address</p>
                        </div>
                    </div>

                    <div class="nvc-step-item">
                        <div class="nvc-step-icon">
                            <i class="fas fa-folder" aria-hidden="true"></i>
                        </div>
                        <div class="nvc-step-content">
                            <h3 class="nvc-step-title nvc-wcag-high-contrast">2. Check Spam Folder</h3>
                            <p class="nvc-step-description nvc-wcag-medium-contrast">Sometimes emails end up in spam or junk folders</p>
                        </div>
                    </div>

                    <div class="nvc-step-item">
                        <div class="nvc-step-icon">
                            <i class="fas fa-clock" aria-hidden="true"></i>
                        </div>
                        <div class="nvc-step-content">
                            <h3 class="nvc-step-title nvc-wcag-high-contrast">3. Act Quickly</h3>
                            <p class="nvc-step-description nvc-wcag-medium-contrast">Reset links expire in 15 minutes for security purposes</p>
                        </div>
                    </div>

                    <div class="nvc-step-item">
                        <div class="nvc-step-icon">
                            <i class="fas fa-shield-check" aria-hidden="true"></i>
                        </div>
                        <div class="nvc-step-content">
                            <h3 class="nvc-step-title nvc-wcag-high-contrast">4. Secure Process</h3>
                            <p class="nvc-step-description nvc-wcag-medium-contrast">All recovery attempts are logged for audit compliance</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Professional Password Recovery with Session Logging

    const form = document.querySelector('.nvc-auth-form-container');
    const submitBtn = form?.querySelector('button[type="submit"]');
    const emailInput = document.getElementById('email');
    const recoveryStatus = document.getElementById('recovery-status');

    // Email validation and verification indicator
    if (emailInput) {
        let emailTimeout;
        const verificationIndicator = document.getElementById('email-verification');

        emailInput.addEventListener('input', function() {
            clearTimeout(emailTimeout);
            const email = this.value.trim();

            if (email && isValidEmail(email)) {
                if (verificationIndicator) {
                    verificationIndicator.innerHTML = '<i class="fas fa-spinner fa-spin" style="color: #6b7280;"></i>';
                }

                emailTimeout = setTimeout(() => {
                    // Simulate email verification check
                    const isRegistered = !email.includes('notfound'); // Simple simulation

                    if (verificationIndicator) {
                        verificationIndicator.innerHTML = isRegistered
                            ? '<i class="fas fa-check-circle" style="color: #16a34a;"></i>'
                            : '<i class="fas fa-question-circle" style="color: #f59e0b;"></i>';
                    }
                }, 1000);
            } else if (verificationIndicator) {
                verificationIndicator.innerHTML = '';
            }
        });
    }

    // Email validation function
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // Real-time form validation
    function validateField(input, errorElementId) {
        const errorElement = document.getElementById(errorElementId);
        if (!errorElement) return true;

        let isValid = true;
        let errorMessage = '';

        const value = input.value.trim();

        if (!value) {
            isValid = false;
            errorMessage = 'Email address is required';
        } else if (!isValidEmail(value)) {
            isValid = false;
            errorMessage = 'Please enter a valid email address';
        }

        // Update UI
        if (isValid) {
            input.classList.remove('nvc-form-error');
            input.classList.add('nvc-form-success');
            errorElement.textContent = '';
            errorElement.style.display = 'none';
        } else {
            input.classList.remove('nvc-form-success');
            input.classList.add('nvc-form-error');
            errorElement.textContent = errorMessage;
            errorElement.style.display = 'block';
        }

        return isValid;
    }

    // Add validation listeners
    if (emailInput) {
        emailInput.addEventListener('blur', () => validateField(emailInput, 'email-error'));
        emailInput.addEventListener('input', () => {
            if (emailInput.classList.contains('nvc-form-error')) {
                validateField(emailInput, 'email-error');
            }
        });
    }

    // Enhanced form submission with session logging
    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // Validate email field
            const emailValid = emailInput ? validateField(emailInput, 'email-error') : false;

            if (!emailValid) {
                if (recoveryStatus) {
                    recoveryStatus.textContent = 'Please enter a valid email address';
                    recoveryStatus.className = 'nvc-form-status nvc-form-status-error';
                }
                return;
            }

            // Log password recovery attempt for audit compliance
            const recoveryAttempt = {
                timestamp: new Date().toISOString(),
                email: emailInput?.value,
                userAgent: navigator.userAgent,
                ipAddress: 'client-side-unknown', // Would be captured server-side
                sessionId: 'session_' + Date.now(),
                action: 'password_recovery_request',
                compliance: {
                    finra: true,
                    auditTrail: true,
                    encrypted: true
                }
            };

            console.log('Password recovery attempt logged:', recoveryAttempt);

            // Show loading state
            const btnContent = submitBtn.querySelector('.nvc-btn-content');
            const btnLoading = submitBtn.querySelector('.nvc-btn-loading');

            if (btnContent && btnLoading) {
                btnContent.style.display = 'none';
                btnLoading.style.display = 'inline-flex';
            }

            submitBtn.disabled = true;
            submitBtn.setAttribute('aria-busy', 'true');

            if (recoveryStatus) {
                recoveryStatus.textContent = 'Sending recovery instructions...';
                recoveryStatus.className = 'nvc-form-status nvc-form-status-info';
            }

            // Submit the form
            setTimeout(() => {
                form.submit();
            }, 500);

            // Fallback reset (in case submission fails)
            setTimeout(() => {
                if (btnContent && btnLoading) {
                    btnContent.style.display = 'inline-flex';
                    btnLoading.style.display = 'none';
                }
                submitBtn.disabled = false;
                submitBtn.removeAttribute('aria-busy');

                if (recoveryStatus) {
                    recoveryStatus.textContent = 'Request timed out. Please try again.';
                    recoveryStatus.className = 'nvc-form-status nvc-form-status-error';
                }
            }, 15000);
        });
    }

    // Alert dismissal
    const alertCloseButtons = document.querySelectorAll('.nvc-alert-close');
    alertCloseButtons.forEach(button => {
        button.addEventListener('click', function() {
            const alert = this.closest('.nvc-alert');
            if (alert) {
                alert.style.opacity = '0';
                alert.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    alert.remove();
                }, 300);
            }
        });
    });

    // Feature item hover effects
    const featureItems = document.querySelectorAll('.nvc-feature-item');
    featureItems.forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });

        item.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });

    // Step item hover effects
    const stepItems = document.querySelectorAll('.nvc-step-item');
    stepItems.forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.02)';
        });

        item.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });

    // Accessibility enhancements
    const focusableElements = document.querySelectorAll('button, a, input, select, textarea, [tabindex]:not([tabindex="-1"])');
    focusableElements.forEach(element => {
        element.addEventListener('focus', function() {
            this.style.outline = '2px solid #2563eb';
            this.style.outlineOffset = '2px';
        });

        element.addEventListener('blur', function() {
            this.style.outline = '';
            this.style.outlineOffset = '';
        });
    });

    // Auto-focus email field on page load
    if (emailInput && !emailInput.value) {
        setTimeout(() => {
            emailInput.focus();
        }, 100);
    }

    // Session logging for page view
    console.log('Password recovery page viewed:', {
        timestamp: new Date().toISOString(),
        page: 'forgot_password',
        userAgent: navigator.userAgent,
        sessionId: 'session_' + Date.now(),
        compliance: {
            finra: true,
            auditTrail: true
        }
    });
});
</script>
{% endblock %}