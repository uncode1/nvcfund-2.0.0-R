{# ===== Enhanced Unified Navigation Component ===== #}
{# NVC Banking Platform - RBAC & WCAG AA+ Compliant Navigation #}
{# Version: 3.0.0 - Role-Based Access Control & Accessibility First #}

{% macro render_main_navigation(current_page='') %}
<nav
  class="nvc-main-navigation"
  role="navigation"
  aria-label="Main navigation"
  data-user-role="{{ current_user.role if (current_user is defined and current_user and current_user.is_authenticated) else 'guest' }}"
>
    <div class="nvc-nav-container">
        <!-- Skip Navigation Link -->
        <a href="#main-content" class="nvc-wcag-skip-link">Skip to main content</a>

        <!-- Primary Navigation Links -->
        <ul class="nvc-nav-links" role="menubar">
            {% if current_user is defined and current_user and current_user.is_authenticated %}
                <!-- Authenticated User Navigation with RBAC -->

                <!-- Dashboard - Available to all authenticated users -->
                <li role="none">
                  <a
                    href="{{ url_for('dashboard.main_dashboard') }}"
                    class="nvc-nav-link nvc-wcag-focus nvc-touch-target {{ 'active' if current_page == 'dashboard' else '' }}"
                    role="menuitem"
                    aria-label="Go to main dashboard"
                  >
                      <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
                      <span>Dashboard</span>
                  </a>
                </li>

                <!-- Banking Services - Available to users with banking permissions -->
                {% if check_permission('can_access_banking') %}
                <li class="nvc-nav-dropdown" role="none">
                    <button
                      type="button"
                      class="nvc-nav-link nvc-nav-dropdown-toggle nvc-wcag-focus nvc-touch-target {{ 'active' if current_page == 'banking' else '' }}"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                      aria-label="Banking services menu"
                      id="banking-menu-button"
                      role="menuitem"
                      aria-haspopup="true"
                    >
                        <i class="fas fa-university" aria-hidden="true"></i>
                        <span>Banking</span>
                        <i class="fas fa-chevron-down nvc-dropdown-arrow" aria-hidden="true"></i>
                    </button>
                    <ul class="nvc-dropdown-menu" role="menu" aria-labelledby="banking-menu-button">
                        {% if check_permission('can_view_overview') %}
                        <li role="none">
                          <a class="nvc-dropdown-item nvc-wcag-focus" href="{{ url_for('banking.overview') }}" role="menuitem">
                            <i class="fas fa-chart-line" aria-hidden="true"></i>
                            <span>Overview</span>
                          </a>
                        </li>
                        {% endif %}

                        {% if check_permission('can_access_accounts') %}
                        <li role="none">
                          <a class="nvc-dropdown-item nvc-wcag-focus" href="{{ url_for('accounts.account_dashboard') }}" role="menuitem">
                            <i class="fas fa-wallet" aria-hidden="true"></i>
                            <span>Accounts</span>
                          </a>
                        </li>
                        {% endif %}

                        {% if check_permission('can_initiate_transfer') %}
                        <li role="none">
                          <a class="nvc-dropdown-item nvc-wcag-focus" href="{{ url_for('banking.transfers') }}" role="menuitem">
                            <i class="fas fa-exchange-alt" aria-hidden="true"></i>
                            <span>Transfers</span>
                          </a>
                        </li>
                        {% endif %}

                        {% if check_permission('can_access_cards') %}
                        <li role="none">
                          <a class="nvc-dropdown-item nvc-wcag-focus" href="{{ url_for('banking.cards') }}" role="menuitem">
                            <i class="fas fa-credit-card" aria-hidden="true"></i>
                            <span>Cards</span>
                          </a>
                        </li>
                        {% endif %}

                        {% if check_permission('can_make_payments') %}
                        <li role="none">
                          <a class="nvc-dropdown-item nvc-wcag-focus" href="{{ url_for('banking.payments') }}" role="menuitem">
                            <i class="fas fa-money-bill-wave" aria-hidden="true"></i>
                            <span>Payments</span>
                          </a>
                        </li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <div class="nvc-nav-dropdown">
                    <a href="#" class="nvc-nav-link dropdown-toggle {{ 'active' if current_page == 'products' else '' }}" 
                       data-bs-toggle="dropdown">
                        <i class="fas fa-box"></i>
                        <span>Products</span>
                        <i class="fas fa-chevron-down"></i>
                    </a>
                    <ul class="nvc-dropdown-menu">
                        <li><a class="nvc-dropdown-item" href="{{ url_for('products.loans_mortgages.dashboard') }}">
                            <i class="fas fa-home"></i>Loans & Mortgages</a></li>
                        <li><a class="nvc-dropdown-item" href="{{ url_for('products.investments.dashboard') }}">
                            <i class="fas fa-chart-pie"></i>Investments</a></li>
                        <li><a class="nvc-dropdown-item" href="{{ url_for('products.insurance.dashboard') }}">
                            <i class="fas fa-shield-alt"></i>Insurance</a></li>
                        <li><a class="nvc-dropdown-item" href="{{ url_for('products.cards_payments.dashboard') }}">
                            <i class="fas fa-credit-card"></i>Cards & Payments</a></li>
                    </ul>
                </div>

                <a href="{{ url_for('treasury.dashboard') }}" 
                   class="nvc-nav-link {{ 'active' if current_page == 'treasury' else '' }}">
                    <i class="fas fa-coins"></i>
                    <span>Treasury</span>
                </a>

                <a href="{{ url_for('nvct_stablecoin.dashboard') }}" 
                   class="nvc-nav-link {{ 'active' if current_page == 'crypto' else '' }}">
                    <i class="fab fa-bitcoin"></i>
                    <span>NVCT</span>
                </a>

                {% if current_user is defined and current_user and current_user.role in ['admin', 'super_admin'] %}
                <div class="nvc-nav-dropdown">
                    <a href="#" class="nvc-nav-link dropdown-toggle {{ 'active' if current_page == 'admin' else '' }}" 
                       data-bs-toggle="dropdown">
                        <i class="fas fa-cogs"></i>
                        <span>Admin</span>
                        <i class="fas fa-chevron-down"></i>
                    </a>
                    <ul class="nvc-dropdown-menu">
                        <li><a class="nvc-dropdown-item" href="{{ url_for('admin_management.dashboard') }}">
                            <i class="fas fa-tachometer-alt"></i>Admin Dashboard</a></li>
                        <li><a class="nvc-dropdown-item" href="{{ url_for('user_management.dashboard') }}">
                            <i class="fas fa-users"></i>User Management</a></li>
                        <li><a class="nvc-dropdown-item" href="{{ url_for('compliance.dashboard') }}">
                            <i class="fas fa-balance-scale"></i>Compliance</a></li>
                        <li><a class="nvc-dropdown-item" href="{{ url_for('sovereign.dashboard') }}">
                            <i class="fas fa-flag"></i>Sovereign Banking</a></li>
                    </ul>
                </div>
                {% endif %}

            {% else %}
                <!-- Public Navigation - Navigation items removed as requested -->
            {% endif %}
        </ul>
    </div>
</nav>
{% endmacro %}

{% macro render_mobile_navigation() %}
<!-- Mobile Navigation Toggle -->
<div class="nvc-mobile-nav-toggle d-lg-none">
    <button
      type="button"
      class="nvc-mobile-toggle-btn nvc-wcag-focus nvc-touch-target"
      data-bs-toggle="offcanvas"
      data-bs-target="#mobileNavigation"
      aria-label="Open mobile navigation menu"
      aria-controls="mobileNavigation"
      aria-expanded="false"
    >
        <i class="fas fa-bars" aria-hidden="true"></i>
        <span class="nvc-sr-only">Menu</span>
    </button>
</div>

<!-- Mobile Navigation Offcanvas -->
<div
  class="offcanvas offcanvas-start nvc-mobile-nav"
  tabindex="-1"
  id="mobileNavigation"
  aria-labelledby="mobile-nav-title"
  aria-modal="true"
  role="dialog"
>
    <div class="offcanvas-header nvc-mobile-nav-header">
        <h5 class="offcanvas-title" id="mobile-nav-title">
            <i class="fas fa-university" aria-hidden="true"></i>
            NVC Banking Platform
        </h5>
        <button
          type="button"
          class="btn-close nvc-wcag-focus"
          data-bs-dismiss="offcanvas"
          aria-label="Close mobile navigation menu"
        >
          <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="offcanvas-body nvc-mobile-nav-body">
        {% if current_user is defined and current_user and current_user.is_authenticated %}
            <div class="nvc-mobile-user-info">
                <div class="nvc-mobile-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="nvc-mobile-user-details">
                    <h6>{{ current_user.username if (current_user is defined and current_user) else 'Guest' }}</h6>
                    <small>{{ current_user.role|title if (current_user is defined and current_user and current_user.role) else 'Guest' }}</small>
                </div>
            </div>
            <hr class="nvc-mobile-divider">
        {% endif %}
        
        <!-- Mobile Navigation Links -->
        <div class="nvc-mobile-nav-links">
            <!-- Same navigation structure as desktop but optimized for mobile -->
            {{ render_main_navigation() }}
        </div>
    </div>
</div>
{% endmacro %}

<!-- Navigation Styles -->
<style>
.nvc-main-navigation {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    border-bottom: 2px solid #3b82f6;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
}

.nvc-nav-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

.nvc-nav-links {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 0;
}

.nvc-nav-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    color: #e2e8f0 !important;
    text-decoration: none;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-weight: 500;
    white-space: nowrap;
}

.nvc-nav-link:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: #ffffff !important;
    transform: translateY(-1px);
}

.nvc-nav-link.active {
    background-color: #3b82f6;
    color: #ffffff !important;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.nvc-nav-dropdown {
    position: relative;
}

.nvc-dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background: #1e40af;
    border: 1px solid #3b82f6;
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    min-width: 200px;
    z-index: 1001;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
}

.nvc-nav-dropdown:hover .nvc-dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.nvc-dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: #e2e8f0 !important;
    text-decoration: none;
    transition: all 0.2s ease;
}

.nvc-dropdown-item:hover {
    background-color: #3b82f6;
    color: #ffffff !important;
}

/* Mobile Navigation Styles */
.nvc-mobile-nav-toggle {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 1002;
}

.nvc-mobile-toggle-btn {
    background: #1e40af;
    border: none;
    color: white;
    padding: 0.75rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.nvc-mobile-nav {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
}

.nvc-mobile-nav-header {
    background: rgba(255, 255, 255, 0.1);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.nvc-mobile-nav-header .offcanvas-title {
    color: white;
    font-weight: 600;
}

.nvc-mobile-user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 0;
}

.nvc-mobile-avatar i {
    font-size: 2.5rem;
    color: #3b82f6;
}

.nvc-mobile-user-details h6 {
    color: white;
    margin: 0;
    font-weight: 600;
}

.nvc-mobile-user-details small {
    color: #cbd5e1;
}

.nvc-mobile-divider {
    border-color: rgba(255, 255, 255, 0.2);
}

/* Responsive Design */
@media (max-width: 991.98px) {
    .nvc-nav-links {
        flex-direction: column;
        align-items: stretch;
        gap: 0.25rem;
    }
    
    .nvc-nav-link {
        justify-content: flex-start;
    }
    
    .nvc-dropdown-menu {
        position: static;
        opacity: 1;
        visibility: visible;
        transform: none;
        box-shadow: none;
        border: none;
        background: rgba(255, 255, 255, 0.1);
        margin-left: 1rem;
    }
}
</style>