{% extends "unified_base.html" %}
{% from "components/nvc_components.html" import metric_card, action_card, account_card, transaction_row, form_input, form_select, notification_banner, progress_bar, stats_grid, loading_spinner, empty_state %}


{% block content %}
<div class="nvc-page-content">
    <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-white mb-0">Cash Flow Analysis</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-transparent mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('treasury.main_dashboard') }}" class="text-info">Treasury</a></li>
                <li class="breadcrumb-item active text-white">Cash Flow Analysis</li>
            </ol>
        </nav>
    </div>

    <!-- Cash Flow Overview -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="dashboard-stat-nvc-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-light mb-1">Cash Inflows</h6>
                        <h3 class="text-success mb-0">$125.8M</h3>
                        <small class="text-success">+12.5% vs last month</small>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-arrow-up text-success"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="dashboard-stat-nvc-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-light mb-1">Cash Outflows</h6>
                        <h3 class="text-danger mb-0">$89.2M</h3>
                        <small class="text-warning">+5.2% vs last month</small>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-arrow-down text-danger"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="dashboard-stat-nvc-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-light mb-1">Net Cash Flow</h6>
                        <h3 class="text-success mb-0">$36.6M</h3>
                        <small class="text-success">Positive flow</small>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-chart-line text-info"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="dashboard-stat-nvc-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-light mb-1">Cash Position</h6>
                        <h3 class="text-white mb-0">$847.2M</h3>
                        <small class="text-info">Available liquidity</small>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-university text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cash Flow Charts -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="dashboard-stat-nvc-card">
                <div class="nvc-nvc-card-header d-flex justify-content-between align-items-center">
                    <h5 class="text-white mb-0">Cash Flow Trends</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn nvc-btn nvc-btn-outline-info btn-sm active">7D</button>
                        <button type="button" class="btn nvc-btn nvc-btn-outline-info btn-sm">30D</button>
                        <button type="button" class="btn nvc-btn nvc-btn-outline-info btn-sm">90D</button>
                        <button type="button" class="btn nvc-btn nvc-btn-outline-info btn-sm">1Y</button>
                    </div>
                </div>
                <div class="nvc-nvc-card-body">
                    <canvas id="cashFlowChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="dashboard-stat-nvc-card">
                <div class="nvc-nvc-card-header">
                    <h6 class="text-white mb-0">Cash Flow Sources</h6>
                </div>
                <div class="nvc-nvc-card-body">
                    <canvas id="cashSourcesChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Cash Flow Details -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="dashboard-stat-nvc-card">
                <div class="nvc-nvc-card-header">
                    <h6 class="text-white mb-0">Inflow Analysis</h6>
                </div>
                <div class="nvc-nvc-card-body">
                    <div class="cash-flow-item d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="flow-icon bg-success me-3">
                                <i class="fas fa-university text-white"></i>
                            </div>
                            <div>
                                <div class="text-white fw-bold">Deposits</div>
                                <div class="text-light small">Customer deposits</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-success fw-bold">$67.4M</div>
                            <div class="text-light small">53.6%</div>
                        </div>
                    </div>
                    <div class="cash-flow-item d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="flow-icon bg-info me-3">
                                <i class="fas fa-handshake text-white"></i>
                            </div>
                            <div>
                                <div class="text-white fw-bold">Loan Interest</div>
                                <div class="text-light small">Interest income</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-success fw-bold">$34.2M</div>
                            <div class="text-light small">27.2%</div>
                        </div>
                    </div>
                    <div class="cash-flow-item d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="flow-icon bg-primary me-3">
                                <i class="fas fa-credit-nvc-card text-white"></i>
                            </div>
                            <div>
                                <div class="text-white fw-bold">Fee Income</div>
                                <div class="text-light small">Service fees</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-success fw-bold">$15.8M</div>
                            <div class="text-light small">12.6%</div>
                        </div>
                    </div>
                    <div class="cash-flow-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="flow-icon bg-warning me-3">
                                <i class="fas fa-chart-line text-white"></i>
                            </div>
                            <div>
                                <div class="text-white fw-bold">Investment</div>
                                <div class="text-light small">Portfolio returns</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-success fw-bold">$8.4M</div>
                            <div class="text-light small">6.7%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="dashboard-stat-nvc-card">
                <div class="nvc-nvc-card-header">
                    <h6 class="text-white mb-0">Outflow Analysis</h6>
                </div>
                <div class="nvc-nvc-card-body">
                    <div class="cash-flow-item d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="flow-icon bg-danger me-3">
                                <i class="fas fa-money-bill text-white"></i>
                            </div>
                            <div>
                                <div class="text-white fw-bold">Loan Disbursements</div>
                                <div class="text-light small">New loans</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-danger fw-bold">$45.6M</div>
                            <div class="text-light small">51.1%</div>
                        </div>
                    </div>
                    <div class="cash-flow-item d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="flow-icon bg-warning me-3">
                                <i class="fas fa-building text-white"></i>
                            </div>
                            <div>
                                <div class="text-white fw-bold">Operating Expenses</div>
                                <div class="text-light small">Operational costs</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-danger fw-bold">$23.4M</div>
                            <div class="text-light small">26.2%</div>
                        </div>
                    </div>
                    <div class="cash-flow-item d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="flow-icon bg-secondary me-3">
                                <i class="fas fa-percentage text-white"></i>
                            </div>
                            <div>
                                <div class="text-white fw-bold">Interest Paid</div>
                                <div class="text-light small">Deposit interest</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-danger fw-bold">$12.8M</div>
                            <div class="text-light small">14.3%</div>
                        </div>
                    </div>
                    <div class="cash-flow-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="flow-icon bg-dark me-3">
                                <i class="fas fa-shield-alt text-white"></i>
                            </div>
                            <div>
                                <div class="text-white fw-bold">Regulatory</div>
                                <div class="text-light small">Compliance costs</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-danger fw-bold">$7.4M</div>
                            <div class="text-light small">8.3%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Forecast & Scenarios -->
    <div class="row">
        <div class="col-lg-8">
            <div class="dashboard-stat-nvc-card">
                <div class="nvc-nvc-card-header d-flex justify-content-between align-items-center">
                    <h5 class="text-white mb-0">Cash Flow Forecast</h5>
                    <button type="button" class="btn nvc-btn nvc-btn-primary btn-sm">
                        <i class="fas fa-download me-2"></i>Export Report
                    </button>
                </div>
                <div class="nvc-nvc-card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Projected Inflows</th>
                                    <th>Projected Outflows</th>
                                    <th>Net Flow</th>
                                    <th>Cumulative Position</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Next Week</strong></td>
                                    <td class="text-success">$28.5M</td>
                                    <td class="text-danger">$22.1M</td>
                                    <td class="text-success">+$6.4M</td>
                                    <td class="text-white">$853.6M</td>
                                    <td><span class="badge bg-success">95%</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Next Month</strong></td>
                                    <td class="text-success">$134.2M</td>
                                    <td class="text-danger">$98.7M</td>
                                    <td class="text-success">+$35.5M</td>
                                    <td class="text-white">$889.1M</td>
                                    <td><span class="badge bg-info">88%</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Next Quarter</strong></td>
                                    <td class="text-success">$387.6M</td>
                                    <td class="text-danger">$312.4M</td>
                                    <td class="text-success">+$75.2M</td>
                                    <td class="text-white">$964.3M</td>
                                    <td><span class="badge bg-warning">75%</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="dashboard-stat-nvc-card">
                <div class="nvc-nvc-card-header">
                    <h6 class="text-white mb-0">Key Metrics</h6>
                </div>
                <div class="nvc-nvc-card-body">
                    <div class="metric-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-light">Cash Velocity</span>
                            <span class="text-white fw-bold">2.3x</span>
                        </div>
                        <div class="progress mt-1" class="nvc-h-4">
                            <div class="progress-bar bg-info" class="progress-bar-76"></div>
                        </div>
                    </div>
                    <div class="metric-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-light">Liquidity Ratio</span>
                            <span class="text-success fw-bold">15.7%</span>
                        </div>
                        <div class="progress mt-1" class="nvc-h-4">
                            <div class="progress-bar bg-success" class="progress-bar-85"></div>
                        </div>
                    </div>
                    <div class="metric-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-light">Working Capital</span>
                            <span class="text-warning fw-bold">$123.4M</span>
                        </div>
                        <div class="progress mt-1" class="nvc-h-4">
                            <div class="progress-bar bg-warning" class="progress-bar-92"></div>
                        </div>
                    </div>
                    <div class="metric-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-light">Coverage Ratio</span>
                            <span class="text-info fw-bold">4.2x</span>
                        </div>
                        <div class="progress mt-1" class="nvc-h-4">
                            <div class="progress-bar bg-primary" class="progress-bar-88"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cash Flow Trends Chart
    const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
    new Chart(cashFlowCtx, {
        type: 'line',
        data: {
            labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
            datasets: [{
                label: 'Inflows',
                data: [18.2, 22.1, 19.8, 25.3, 21.7, 24.5, 28.1],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                fill: true
            }, {
                label: 'Outflows',
                data: [12.8, 15.2, 14.1, 18.9, 16.3, 17.8, 20.2],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#e2e8f0'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#e2e8f0'
                    },
                    grid: {
                        color: 'rgba(226, 232, 240, 0.1)'
                    }
                },
                y: {
                    ticks: {
                        color: '#e2e8f0',
                        callback: function(value) {
                            return '$' + value + 'M';
                        }
                    },
                    grid: {
                        color: 'rgba(226, 232, 240, 0.1)'
                    }
                }
            }
        }
    });

    // Cash Sources Chart
    const sourcesCtx = document.getElementById('cashSourcesChart').getContext('2d');
    new Chart(sourcesCtx, {
        type: 'doughnut',
        data: {
            labels: ['Deposits', 'Loan Interest', 'Fees', 'Investments'],
            datasets: [{
                data: [53.6, 27.2, 12.6, 6.7],
                backgroundColor: ['#28a745', '#17a2b8', '#007bff', '#ffc107'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#e2e8f0',
                        padding: 10
                    }
                }
            }
        }
    });
});
</script>
</div>
{% endblock %}