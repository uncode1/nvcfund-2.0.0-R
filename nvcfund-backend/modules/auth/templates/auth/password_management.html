{% extends "unified_base.html" %}

{% block title %}Password Management - NVC Banking Platform{% endblock %}

{% block page_title %}Password Management{% endblock %}
{% block page_description %}Password policies, security analysis, and user password management{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-outline-primary">
    <i class="fas fa-download"></i>
    Export Report
</button>
<button type="button" class="btn btn-secondary">
    <i class="fas fa-cog"></i>
    Password Policies
</button>
<button type="button" class="btn btn-primary">
    <i class="fas fa-sync-alt"></i>
    Refresh Analysis
</button>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Password Security Overview -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Strong Passwords</h6>
                            <h3 class="mb-0">{{ password_stats.strong_percentage or '78.5' }}%</h3>
                            <small class="text-light">{{ password_stats.strong_count or '979' }} users</small>
                        </div>
                        <div class="text-white-50">
                            <i class="fas fa-shield-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Weak Passwords</h6>
                            <h3 class="mb-0">{{ password_stats.weak_count or '137' }}</h3>
                            <small class="text-light">Need immediate attention</small>
                        </div>
                        <div class="text-white-50">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Expired Passwords</h6>
                            <h3 class="mb-0">{{ password_stats.expired_count or '23' }}</h3>
                            <small class="text-light">Require reset</small>
                        </div>
                        <div class="text-white-50">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Recent Resets</h6>
                            <h3 class="mb-0">{{ password_stats.recent_resets or '45' }}</h3>
                            <small class="text-light">Last 7 days</small>
                        </div>
                        <div class="text-white-50">
                            <i class="fas fa-redo fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Policy Configuration -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Password Policy Settings
                    </h5>
                </div>
                <div class="card-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">Minimum Password Length</label>
                            <input type="number" class="form-control" value="{{ policy_settings.min_length or '8' }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password Complexity Requirements</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" checked>
                                <label class="form-check-label">Require uppercase letters</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" checked>
                                <label class="form-check-label">Require lowercase letters</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" checked>
                                <label class="form-check-label">Require numbers</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" checked>
                                <label class="form-check-label">Require special characters</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password Expiry (days)</label>
                            <input type="number" class="form-control" value="{{ policy_settings.expiry_days or '90' }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password History</label>
                            <input type="number" class="form-control" value="{{ policy_settings.history_count or '5' }}">
                            <small class="form-text text-muted">Number of previous passwords to remember</small>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                Save Policy Settings
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Password Strength Analysis -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Password Strength Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Very Strong</span>
                            <span class="text-success">{{ strength_distribution.very_strong or '45%' }}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" class="progress-bar-45"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Strong</span>
                            <span class="text-info">{{ strength_distribution.strong or '33%' }}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-info" class="progress-bar-33"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Medium</span>
                            <span class="text-warning">{{ strength_distribution.medium or '15%' }}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-warning" class="progress-bar-15"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Weak</span>
                            <span class="text-danger">{{ strength_distribution.weak or '7%' }}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-danger" class="progress-bar-7"></div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6>Common Issues Found:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>{{ common_issues.dictionary_words or '89' }} dictionary words</li>
                            <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>{{ common_issues.repeated_chars or '45' }} repeated characters</li>
                            <li><i class="fas fa-exclamation-triangle text-danger me-2"></i>{{ common_issues.common_patterns or '23' }} common patterns</li>
                            <li><i class="fas fa-exclamation-triangle text-danger me-2"></i>{{ common_issues.personal_info or '12' }} personal information</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users with Password Issues -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users me-2"></i>
                        Users Requiring Password Action
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary">
                            <i class="fas fa-filter"></i>
                            Filter
                        </button>
                        <button type="button" class="btn btn-outline-warning">
                            <i class="fas fa-envelope"></i>
                            Send Reminders
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filter Options -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" placeholder="Search users...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select">
                                <option value="">All Issues</option>
                                <option value="weak">Weak Password</option>
                                <option value="expired">Expired</option>
                                <option value="compromised">Compromised</option>
                                <option value="reused">Reused</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select">
                                <option value="">All Roles</option>
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                                <option value="teller">Teller</option>
                                <option value="customer">Customer</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select">
                                <option value="">All Priorities</option>
                                <option value="high">High Priority</option>
                                <option value="medium">Medium Priority</option>
                                <option value="low">Low Priority</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>
                                        <input type="checkbox" class="form-check-input">
                                    </th>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Issue</th>
                                    <th>Strength Score</th>
                                    <th>Last Changed</th>
                                    <th>Priority</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in password_issues or [
                                    {'name': 'John Doe', 'email': 'john.doe@nvcbank.com', 'role': 'Manager', 'issue': 'Weak Password', 'strength': '35', 'last_changed': '2023-10-15', 'priority': 'High'},
                                    {'name': 'Jane Smith', 'email': 'jane.smith@nvcbank.com', 'role': 'Teller', 'issue': 'Expired', 'strength': '78', 'last_changed': '2023-09-20', 'priority': 'High'},
                                    {'name': 'Mike Johnson', 'email': 'mike.j@nvcbank.com', 'role': 'Admin', 'issue': 'Compromised', 'strength': '82', 'last_changed': '2024-01-10', 'priority': 'Critical'},
                                    {'name': 'Sarah Wilson', 'email': 'sarah.w@email.com', 'role': 'Customer', 'issue': 'Weak Password', 'strength': '42', 'last_changed': '2023-11-05', 'priority': 'Medium'},
                                    {'name': 'David Brown', 'email': 'david.b@email.com', 'role': 'Customer', 'issue': 'Reused Password', 'strength': '65', 'last_changed': '2023-12-01', 'priority': 'Medium'},
                                    {'name': 'Lisa Garcia', 'email': 'lisa.g@nvcbank.com', 'role': 'Compliance', 'issue': 'Expired', 'strength': '88', 'last_changed': '2023-08-15', 'priority': 'High'}
                                ] %}
                                <tr class="{{ 'table-danger' if user.priority == 'Critical' else 'table-warning' if user.priority == 'High' else '' }}">
                                    <td>
                                        <input type="checkbox" class="form-check-input">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center">
                                                {{ user.name.split()[0][0] }}{{ user.name.split()[1][0] if user.name.split()|length > 1 else '' }}
                                            </div>
                                            <div>
                                                <strong>{{ user.name }}</strong>
                                                <br>
                                                <small class="text-muted">{{ user.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if user.role == 'Admin' else 'warning' if user.role == 'Manager' else 'info' if user.role == 'Teller' else 'secondary' }}">
                                            {{ user.role }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if user.issue == 'Compromised' else 'warning' if user.issue == 'Expired' or user.issue == 'Weak Password' else 'info' }}">
                                            {{ user.issue }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress me-2 nvc-style-c4f265" >
                                                <div class="progress-bar bg-{{ 'success' if user.strength|int > 70 else 'warning' if user.strength|int > 40 else 'danger' }}" 
                                                     style="width: {{ user.strength }}%"></div>
                                            </div>
                                            <small>{{ user.strength }}%</small>
                                        </div>
                                    </td>
                                    <td>{{ user.last_changed }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if user.priority == 'Critical' else 'warning' if user.priority == 'High' else 'info' if user.priority == 'Medium' else 'secondary' }}">
                                            {{ user.priority }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-primary" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-warning" title="Force Password Reset">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-info" title="Send Reminder">
                                                <i class="fas fa-envelope"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span class="text-muted">0 users selected</span>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-warning" disabled>
                                <i class="fas fa-redo"></i>
                                Force Password Reset
                            </button>
                            <button type="button" class="btn btn-outline-info" disabled>
                                <i class="fas fa-envelope"></i>
                                Send Reminders
                            </button>
                            <button type="button" class="btn btn-outline-secondary" disabled>
                                <i class="fas fa-ban"></i>
                                Suspend Accounts
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Analytics -->
    <div class="row mt-4">
        <!-- Password Reset Trends -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Password Reset Trends (30 Days)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container nvc-style-342c8d" >
                        <canvas id="passwordResetChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Recommendations -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Security Recommendations
                    </h5>
                </div>
                <div class="card-body">
                    {% for recommendation in security_recommendations or [
                        {'type': 'warning', 'title': 'Increase Minimum Length', 'description': 'Consider increasing minimum password length to 12 characters'},
                        {'type': 'info', 'title': 'Enable Password Strength Meter', 'description': 'Help users create stronger passwords with real-time feedback'},
                        {'type': 'success', 'title': 'Implement Breach Detection', 'description': 'Check passwords against known breach databases'},
                        {'type': 'warning', 'title': 'Reduce Expiry Period', 'description': 'Consider reducing password expiry to 60 days for admin users'}
                    ] %}
                    <div class="alert alert-{{ recommendation.type }} alert-sm">
                        <h6 class="alert-heading">{{ recommendation.title }}</h6>
                        <p class="mb-0">{{ recommendation.description }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}