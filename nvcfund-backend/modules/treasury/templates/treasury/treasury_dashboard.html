{% extends "unified_base.html" %}
{% from "components/nvc_components.html" import metric_card, action_card, account_card, transaction_row, form_input, form_select, notification_banner, progress_bar, stats_grid, loading_spinner, empty_state %}


{% block title %}Treasury Dashboard - NVC Banking & Crypto Platform{% endblock %}

{% block page_title %}Treasury Operations{% endblock %}
{% block page_description %}Comprehensive treasury management, liquidity operations, and financial risk management{% endblock %}

{% block page_actions %}
<button type="button" class="nvc-btn nvc-btn-outline-enterprise" data-action="custom-action">
    <i class="fas fa-download"></i>
    Export Report
</button>
<button type="button" class="nvc-btn nvc-btn-secondary-enterprise" data-action="custom-action">
    <i class="fas fa-tint"></i>
    Liquidity Management
</button>
<button type="button" class="nvc-btn nvc-btn-primary-enterprise" data-action="custom-action">
    <i class="fas fa-coins"></i>
    Treasury Operations
</button>
{% endblock %}

{% block extra_css %}
<style>
    /* Treasury Specific Styles */
    .treasury-metric-card {
        background: linear-gradient(135deg, var(--success-bg) 0%, var(--success-hover) 100%);
        border: 2px solid var(--success-color);
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        color: white;
        transition: all 0.3s ease;
    }

    .treasury-metric-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }

    .liquidity-indicator {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius);
        font-weight: 600;
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .treasury-operations-card {
        background: linear-gradient(135deg, var(--secondary-bg) 0%, var(--tertiary-bg) 100%);
        border-left: 4px solid var(--success-color);
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .treasury-operations-card:hover {
        border-left-width: 6px;
        transform: translateX(3px);
    }
</style>
{% endblock %}

{% block content %}
<div class="nvc-content-sections">
    <!-- Treasury Overview Section -->
    <div class="nvc-content-section" id="overview">
        <div class="nvc-content-section-header">
            <h3 class="nvc-content-section-title">
                <i class="fas fa-university"></i> Treasury Operations Center
            </h3>
            <div class="nvc-content-section-actions">
                <span class="nvc-badge nvc-badge-success">
                    <i class="fas fa-tint"></i> Optimal Liquidity
                </span>
            </div>
        </div>
        <div class="nvc-content-section-body">
            <div class="nvc-card nvc-card-elevated">
                <div class="nvc-card-body">
                    <p class="nvc-text-muted mb-0">Comprehensive treasury management and liquidity optimization</p>
                </div>
            </div>
        </div>
    </div>
                    <div class="header-text">
                        <h3>Treasury Operations Center</h3>
                        <p>Real-time treasury management and liquidity operations</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="liquidity-indicator">
                        <i class="fas fa-tint"></i>
                        Liquidity Status: Optimal
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Treasury Metrics -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <a href="{{ url_for('treasury.cash_flow_analysis') }}" class="text-decoration-none">
            <div class="nvc-card metric-card treasury-metric-nvc-card">
                <div class="metric-content">
                    <div class="metric-icon success">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="metric-details">
                        <h3>$2.4B</h3>
                        <p>Daily Cash Flow</p>
                        <span class="metric-trend positive">
                            <i class="fas fa-arrow-up"></i> +12.5% vs yesterday
                        </span>
                    </div>
                </div>
                <div class="metric-action">
                    <span class="action-hint">
                        <i class="fas fa-arrow-right"></i> Cash Flow Analysis
                    </span>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <a href="{{ url_for('treasury.liquidity_management') }}" class="text-decoration-none">
            <div class="nvc-card metric-card treasury-metric-nvc-card">
                <div class="metric-content">
                    <div class="metric-icon info">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="metric-details">
                        <h3>98.7%</h3>
                        <p>Liquidity Ratio</p>
                        <span class="metric-trend positive">
                            <i class="fas fa-check"></i> Above regulatory minimum
                        </span>
                    </div>
                </div>
                <div class="metric-action">
                    <span class="action-hint">
                        <i class="fas fa-arrow-right"></i> Liquidity Management
                    </span>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <a href="{{ url_for('treasury.fx_operations') }}" class="text-decoration-none">
            <div class="nvc-card metric-card treasury-metric-nvc-card">
                <div class="metric-content">
                    <div class="metric-icon warning">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="metric-details">
                        <h3>$847M</h3>
                        <p>FX Exposure</p>
                        <span class="metric-trend neutral">
                            <i class="fas fa-minus"></i> Within risk limits
                        </span>
                    </div>
                </div>
                <div class="metric-action">
                    <span class="action-hint">
                        <i class="fas fa-arrow-right"></i> FX Operations
                    </span>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <a href="{{ url_for('treasury.risk_management') }}" class="text-decoration-none">
            <div class="nvc-card metric-card treasury-metric-nvc-card">
                <div class="metric-content">
                    <div class="metric-icon danger">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="metric-details">
                        <h3>Low</h3>
                        <p>Risk Level</p>
                        <span class="metric-trend positive">
                            <i class="fas fa-check"></i> All metrics green
                        </span>
                    </div>
                </div>
                <div class="metric-action">
                    <span class="action-hint">
                        <i class="fas fa-arrow-right"></i> Risk Management
                    </span>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Level 2: Treasury Operation Categories -->
<div class="row mb-4">
    <div class="col-12">
        <div class="enterprise-nvc-card">
            <div class="nvc-nvc-card-header-enterprise">
                <h4><i class="fas fa-layer-group"></i> Treasury Operations</h4>
            </div>
            <div class="nvc-nvc-card-body">
                <div class="row g-3">
                    <div class="col-xl-2 col-md-4">
                        <div class="treasury-operation-nvc-card" data-operation-type="cash_management" >
                            <div class="operation-icon bg-success">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="operation-content">
                                <h4>$2.4B</h4>
                                <p>Cash Management</p>
                                <small class="text-success">Daily operations</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4">
                        <div class="treasury-operation-nvc-card" data-operation-type="liquidity" >
                            <div class="operation-icon bg-primary">
                                <i class="fas fa-tint"></i>
                            </div>
                            <div class="operation-content">
                                <h4>98.7%</h4>
                                <p>Liquidity Management</p>
                                <small class="text-info">Above minimum</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4">
                        <div class="treasury-operation-nvc-card" data-operation-type="fx_operations" >
                            <div class="operation-icon bg-warning">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="operation-content">
                                <h4>$847M</h4>
                                <p>FX Operations</p>
                                <small class="text-warning">Multi-currency</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4">
                        <div class="treasury-operation-nvc-card" data-operation-type="investments" >
                            <div class="operation-icon bg-info">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="operation-content">
                                <h4>$1.8B</h4>
                                <p>Investment Portfolio</p>
                                <small class="text-primary">Diversified</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4">
                        <div class="treasury-operation-nvc-card" data-operation-type="risk_management" >
                            <div class="operation-icon bg-danger">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="operation-content">
                                <h4>Low</h4>
                                <p>Risk Management</p>
                                <small class="text-danger">Controlled</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4">
                        <div class="treasury-operation-nvc-card" data-operation-type="compliance" >
                            <div class="operation-icon bg-secondary">
                                <i class="fas fa-balance-scale"></i>
                            </div>
                            <div class="operation-content">
                                <h4>100%</h4>
                                <p>Compliance</p>
                                <small class="text-secondary">Regulatory</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Level 3: Treasury Transactions Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="enterprise-nvc-card">
            <div class="nvc-nvc-card-header-enterprise">
                <h4><i class="fas fa-table"></i> Treasury Transactions</h4>
                <div class="header-actions">
                    <select id="treasury-operation-filter" class="form-select nvc-form-select-sm">
                        <option value="">All Operations</option>
                        <option value="cash_management">Cash Management</option>
                        <option value="liquidity">Liquidity Management</option>
                        <option value="fx_operations">FX Operations</option>
                        <option value="investments">Investment Portfolio</option>
                        <option value="risk_management">Risk Management</option>
                        <option value="compliance">Compliance</option>
                    </select>
                </div>
            </div>
            <div class="nvc-nvc-card-body">
                <div class="table-responsive">
                    <table class="table enterprise-table">
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>Operation Type</th>
                                <th>Amount</th>
                                <th>Currency</th>
                                <th>Status</th>
                                <th>Risk Level</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="treasury-transactions-table">
                            <tr class="treasury-transaction-row" data-transaction-id="TRS-001" data-operation-type="cash_management" data-status="completed" >
                                <td><strong>TRS-001</strong></td>
                                <td><span class="badge bg-success">Cash Management</span></td>
                                <td class="text-success">$50,000,000</td>
                                <td>USD</td>
                                <td><span class="badge bg-success">Completed</span></td>
                                <td><span class="badge bg-success">Low</span></td>
                                <td>
                                    <button type="button" class="btn btn-sm nvc-btn nvc-btn-outline-primary" data-action="custom-action">Details</button>
                                    <button type="button" class="btn btn-sm nvc-btn nvc-btn-outline-info" data-action="custom-action">Audit</button>
                                </td>
                            </tr>
                            <tr class="treasury-transaction-row" data-transaction-id="TRS-002" data-operation-type="fx_operations" data-status="pending" >
                                <td><strong>TRS-002</strong></td>
                                <td><span class="badge bg-warning">FX Operations</span></td>
                                <td class="text-warning">€25,000,000</td>
                                <td>EUR</td>
                                <td><span class="badge bg-warning">Pending</span></td>
                                <td><span class="badge bg-warning">Medium</span></td>
                                <td>
                                    <button type="button" class="btn btn-sm nvc-btn nvc-btn-outline-primary" data-action="custom-action">Details</button>
                                    <button type="button" class="btn btn-sm nvc-btn nvc-btn-outline-warning" data-action="custom-action">Approve</button>
                                </td>
                            </tr>
                            <tr class="treasury-transaction-row" data-transaction-id="TRS-003" data-operation-type="investments" data-status="completed" >
                                <td><strong>TRS-003</strong></td>
                                <td><span class="badge bg-info">Investment</span></td>
                                <td class="text-info">$100,000,000</td>
                                <td>USD</td>
                                <td><span class="badge bg-success">Completed</span></td>
                                <td><span class="badge bg-info">Medium</span></td>
                                <td>
                                    <button type="button" class="btn btn-sm nvc-btn nvc-btn-outline-primary" data-action="custom-action">Details</button>
                                    <button type="button" class="btn btn-sm nvc-btn nvc-btn-outline-info" data-action="custom-action">Audit</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('treasury.investment_portfolio') }}" class="text-decoration-none">
                <div class="card dashboard-stat-card hover-nvc-card">
                    <div class="nvc-nvc-card-body text-center">
                        <i class="fas fa-dollar-sign fa-3x text-info mb-3"></i>
                        <h5 class="text-light">Volume</h5>
                        <h3 class="text-info">$2.5M</h3>
                        <small class="text-light">Monthly</small>
                        <div class="mt-2">
                            <small class="text-info"><i class="fas fa-arrow-right me-1"></i>Portfolio Details</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('treasury.risk_assessment') }}" class="text-decoration-none">
                <div class="card dashboard-stat-card hover-nvc-card">
                    <div class="nvc-nvc-card-body text-center">
                        <i class="fas fa-shield-alt fa-3x text-danger mb-3"></i>
                        <h5 class="text-light">Security</h5>
                        <h3 class="text-success">100%</h3>
                        <small class="text-light">Compliant</small>
                        <div class="mt-2">
                            <small class="text-info"><i class="fas fa-arrow-right me-1"></i>Risk Analysis</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <!-- Enhanced Treasury Operations Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="nvc-card bg-dark border-primary">
                <div class="nvc-nvc-card-header">
                    <h5 class="text-white mb-0">
                        <i class="fas fa-money-bill-wave me-2"></i>Cash Management
                    </h5>
                </div>
                <div class="nvc-nvc-card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6 class="text-primary">Daily Position</h6>
                            <h4 class="text-success">$125M</h4>
                        </div>
                        <div class="col-6">
                            <h6 class="text-primary">Reserve Ratio</h6>
                            <h4 class="text-info">12.5%</h4>
                        </div>
                    </div>
                    <div class="progress mt-2">
                        <div class="progress-bar bg-success" role="progressbar" class="progress-bar-85"></div>
                    </div>
                    <small class="text-light">Liquidity Status: Optimal</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="nvc-card bg-dark border-info">
                <div class="nvc-nvc-card-header">
                    <h5 class="text-white mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>FX Operations
                    </h5>
                </div>
                <div class="nvc-nvc-card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6 class="text-info">Total Exposure</h6>
                            <h4 class="text-warning">$58M</h4>
                        </div>
                        <div class="col-6">
                            <h6 class="text-info">Hedged</h6>
                            <h4 class="text-success">85.2%</h4>
                        </div>
                    </div>
                    <div class="progress mt-2">
                        <div class="progress-bar bg-success" role="progressbar" class="progress-bar-85"></div>
                    </div>
                    <small class="text-light">Daily P&L: +$125K</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="nvc-card bg-dark border-warning">
                <div class="nvc-nvc-card-header">
                    <h5 class="text-white mb-0">
                        <i class="fas fa-balance-scale me-2"></i>ALM Overview
                    </h5>
                </div>
                <div class="nvc-nvc-card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6 class="text-warning">Duration Gap</h6>
                            <h4 class="text-info">2.3 years</h4>
                        </div>
                        <div class="col-6">
                            <h6 class="text-warning">Net Interest Margin</h6>
                            <h4 class="text-success">3.25%</h4>
                        </div>
                    </div>
                    <div class="progress mt-2">
                        <div class="progress-bar bg-info" role="progressbar" class="progress-bar-75"></div>
                    </div>
                    <small class="text-light">Interest Rate Risk: Moderate</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Money Market & Risk Management -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="nvc-card bg-dark border-success">
                <div class="nvc-nvc-card-header">
                    <h5 class="text-white mb-0">
                        <i class="fas fa-coins me-2"></i>Money Market Operations
                    </h5>
                </div>
                <div class="nvc-nvc-card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6 class="text-success">Interbank Lending</h6>
                            <h4 class="text-info">$75M</h4>
                            <small class="text-light">CD Portfolio: $180M</small>
                        </div>
                        <div class="col-6">
                            <h6 class="text-success">Federal Funds</h6>
                            <h4 class="text-warning">5.25%</h4>
                            <small class="text-light">LIBOR: 5.45%</small>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="badge bg-success me-2">Repo: $25M</span>
                        <span class="badge bg-info">Commercial Paper: $45M</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="nvc-card bg-dark border-danger">
                <div class="nvc-nvc-card-header">
                    <h5 class="text-white mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Risk Management
                    </h5>
                </div>
                <div class="nvc-nvc-card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6 class="text-danger">Credit Risk</h6>
                            <h4 class="text-warning">BBB+</h4>
<!-- Treasury Operations & Activity -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="enterprise-nvc-card">
            <div class="nvc-nvc-card-header-enterprise">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="header-text">
                        <h3>Active Treasury Operations</h3>
                        <p>Real-time treasury activities and transactions</p>
                    </div>
                </div>
            </div>
            <div class="nvc-nvc-card-body-enterprise">
                <div class="treasury-operations-list">
                    <div class="treasury-operations-nvc-card">
                        <div class="operation-header">
                            <div class="operation-icon success">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="operation-details">
                                <h5>Cash Management</h5>
                                <p>Daily liquidity optimization completed</p>
                                <span class="operation-status success">Active</span>
                            </div>
                            <div class="operation-value">$2.4B</div>
                        </div>
                    </div>

                    <div class="treasury-operations-nvc-card">
                        <div class="operation-header">
                            <div class="operation-icon info">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="operation-details">
                                <h5>FX Hedging</h5>
                                <p>Currency exposure management</p>
                                <span class="operation-status info">Processing</span>
                            </div>
                            <div class="operation-value">$847M</div>
                        </div>
                    </div>

                    <div class="treasury-operations-nvc-card">
                        <div class="operation-header">
                            <div class="operation-icon warning">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="operation-details">
                                <h5>Investment Portfolio</h5>
                                <p>Asset allocation rebalancing</p>
                                <span class="operation-status warning">Pending</span>
                            </div>
                            <div class="operation-value">$1.2B</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="enterprise-nvc-card">
            <div class="nvc-nvc-card-header-enterprise">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="header-text">
                        <h3>Risk Management</h3>
                        <p>Treasury risk monitoring and controls</p>
                    </div>
                </div>
            </div>
            <div class="nvc-nvc-card-body-enterprise">
                <div class="risk-metrics-grid">
                    <div class="risk-metric-item">
                        <div class="risk-label">Credit Risk</div>
                        <div class="risk-value success">Low</div>
                        <div class="risk-detail">NPL: 0.8%</div>
                    </div>
                    <div class="risk-metric-item">
                        <div class="risk-label">Market Risk</div>
                        <div class="risk-value info">$2.5M</div>
                        <div class="risk-detail">Value at Risk</div>
                    </div>
                    <div class="risk-metric-item">
                        <div class="risk-label">Liquidity Risk</div>
                        <div class="risk-value success">Optimal</div>
                        <div class="risk-detail">LCR: 142%</div>
                    </div>
                    <div class="risk-metric-item">
                        <div class="risk-label">Operational Risk</div>
                        <div class="risk-value warning">Medium</div>
                        <div class="risk-detail">2 incidents</div>
                    </div>
                </div>
                <div class="risk-score-indicator">
                    <div class="score-label">Overall Risk Score</div>
                    <div class="score-value success">85.5</div>
                    <div class="score-status">Excellent</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Treasury Dashboard Functions
function exportTreasuryData() {
    const csvData = 'Operation,Amount,Status,Risk Level,Timestamp\n';
    const blob = new Blob([csvData], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'treasury_operations_report.csv';
    a.click();
}

function viewLiquidityManagement() {
    window.location.href = "{{ url_for('treasury.liquidity_management') }}";
}

function manageTreasuryOperations() {
    window.location.href = "{{ url_for('treasury.treasury_overview') }}";
}

// Initialize treasury dashboard with drilldown functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers for metric cards with drilldown navigation
    const metricCards = document.querySelectorAll('.metric-card');
    metricCards.forEach(card => {
        card.style.cursor = 'pointer';
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });

        // Add click handlers for drilldown navigation
        card.addEventListener('click', function() {
            const cardTitle = this.querySelector('h3, h4, h5, h6, .metric-title')?.textContent;
            handleTreasuryDrilldown(cardTitle);
        });
    });

    // Update time display
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        const timeElements = document.querySelectorAll('#current-time');
        timeElements.forEach(element => {
            if (element) element.textContent = timeString;
        });
    }

    // Update time every second
    setInterval(updateTime, 1000);
    updateTime(); // Initial call

    // Level 2: Treasury Operation Cards
    const operationCards = document.querySelectorAll('.treasury-operation-card');
    operationCards.forEach(card => {
        card.addEventListener('click', function() {
            const operationType = this.getAttribute('data-operation-type');
            handleTreasuryOperationDrilldown(operationType);
        });

        // Enhanced hover effects
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });

    // Level 3: Treasury Transaction Rows
    const transactionRows = document.querySelectorAll('.treasury-transaction-row');
    transactionRows.forEach(row => {
        row.addEventListener('click', function(e) {
            // Prevent navigation if clicking on action buttons
            if (e.target.closest('.btn')) return;

            const transactionId = this.getAttribute('data-transaction-id');
            viewTreasuryTransactionDetails(transactionId);
        });

        // Add hover effects
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(0,123,255,0.1)';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });

    // Treasury operation filter
    const operationFilter = document.getElementById('treasury-operation-filter');
    if (operationFilter) {
        operationFilter.addEventListener('change', function() {
            filterTransactionsByOperation(this.value);
        });
    }
});

// Level 2: Treasury Operation Drilldown
function handleTreasuryOperationDrilldown(operationType) {
    // Filter the transactions table by operation type
    filterTransactionsByOperation(operationType);

    // Update the filter dropdown
    const operationFilter = document.getElementById('treasury-operation-filter');
    if (operationFilter) {
        operationFilter.value = operationType;
    }

    // Scroll to transactions table
    document.querySelector('#treasury-transactions-table').scrollIntoView({ behavior: 'smooth' });
}

// Level 3: Filter transactions by operation
function filterTransactionsByOperation(operationType) {
    const rows = document.querySelectorAll('.treasury-transaction-row');
    let visibleCount = 0;

    rows.forEach(row => {
        const rowOperation = row.getAttribute('data-operation-type');
        if (!operationType || rowOperation === operationType) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    updateTreasuryTransactionCounts(operationType, visibleCount);
}

// Update transaction counts
function updateTreasuryTransactionCounts(activeFilter, visibleCount) {
    const totalRows = document.querySelectorAll('.treasury-transaction-row').length;
    const header = document.querySelector('.card-header-enterprise h4');
    if (header) {
        if (!activeFilter) {
            header.innerHTML = `<i class="fas fa-table"></i> Treasury Transactions (${totalRows} transactions)`;
        } else {
            const filterName = activeFilter.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            header.innerHTML = `<i class="fas fa-table"></i> ${filterName} Transactions (${visibleCount} transactions)`;
        }
    }
}

// Level 4: View individual transaction details (Level 4 → Level 5 drilldown)
function viewTreasuryTransactionDetails(transactionId) {
    // Navigate to detailed transaction view with comprehensive treasury analysis
    const detailsUrl = "{{ url_for('treasury.transaction_details', transaction_id='TRANSACTION_ID') }}".replace('TRANSACTION_ID', encodeURIComponent(transactionId));
    window.location.href = detailsUrl + '?view=comprehensive&include=risk_analysis,compliance,audit_trail';
}

// Level 5: Specialized treasury functions
function auditTreasuryTransaction(transactionId) {
    // Navigate to transaction audit
    const auditUrl = "{{ url_for('treasury.transaction_audit', transaction_id='TRANSACTION_ID') }}".replace('TRANSACTION_ID', encodeURIComponent(transactionId));
    window.location.href = auditUrl + '?view=detailed&compliance_check=true';
}

function approveTreasuryTransaction(transactionId) {
    if (confirm('Are you sure you want to approve this treasury transaction? This action requires proper authorization.')) {
        // Secure transaction approval
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('treasury.approve_transaction') }}";

        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrf_token';
        csrfToken.value = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        form.appendChild(csrfToken);

        const transactionIdInput = document.createElement('input');
        transactionIdInput.type = 'hidden';
        transactionIdInput.name = 'transaction_id';
        transactionIdInput.value = transactionId;
        form.appendChild(transactionIdInput);

        const action = document.createElement('input');
        action.type = 'hidden';
        action.name = 'action';
        action.value = 'approve';
        form.appendChild(action);

        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }
}

function analyzeTreasuryRisk(transactionId) {
    // Navigate to treasury risk analysis
    const riskUrl = "{{ url_for('treasury.risk_analysis', transaction_id='TRANSACTION_ID') }}".replace('TRANSACTION_ID', encodeURIComponent(transactionId));
    window.location.href = riskUrl + '?view=comprehensive&stress_test=true';
}

function generateTreasuryReport(transactionId) {
    // Navigate to treasury report generation
    const reportUrl = "{{ url_for('treasury.transaction_report', transaction_id='TRANSACTION_ID') }}".replace('TRANSACTION_ID', encodeURIComponent(transactionId));
    window.location.href = reportUrl + '?format=regulatory&export=pdf&audit_trail=true';
}

function viewComplianceStatus(transactionId) {
    // Navigate to compliance status
    const complianceUrl = "{{ url_for('treasury.compliance_status', transaction_id='TRANSACTION_ID') }}".replace('TRANSACTION_ID', encodeURIComponent(transactionId));
    window.location.href = complianceUrl + '?view=detailed&regulatory_check=true';
}

function manageLiquidityPosition(transactionId) {
    // Navigate to liquidity management
    const liquidityUrl = "{{ url_for('treasury.liquidity_management') }}";
    window.location.href = liquidityUrl + `?transaction_id=${encodeURIComponent(transactionId)}&action=optimize`;
}

function handleTreasuryDrilldown(cardTitle) {
    if (!cardTitle) return;

    if (cardTitle.includes('Total Assets') || cardTitle.includes('Portfolio Value')) {
        window.location.href = "{{ url_for('treasury.asset_management') }}?view=portfolio";
    } else if (cardTitle.includes('Liquidity') || cardTitle.includes('Cash')) {
        window.location.href = "{{ url_for('treasury.liquidity_management') }}?view=overview";
    } else if (cardTitle.includes('Risk Score') || cardTitle.includes('Risk')) {
        window.location.href = "{{ url_for('treasury.risk_management') }}?view=assessment";
    } else if (cardTitle.includes('Yield') || cardTitle.includes('Return')) {
        window.location.href = "{{ url_for('treasury.yield_analytics') }}?period=ytd";
    } else if (cardTitle.includes('Investments') || cardTitle.includes('Securities')) {
        window.location.href = "{{ url_for('treasury.investment_portfolio') }}?view=holdings";
    } else if (cardTitle.includes('Compliance') || cardTitle.includes('Regulatory')) {
        window.location.href = "{{ url_for('treasury.compliance_monitoring') }}?view=status";
    } else if (cardTitle.includes('Transactions') || cardTitle.includes('Operations')) {
        window.location.href = "{{ url_for('treasury.transaction_monitoring') }}?view=recent";
    }
}
</script>
</div>
{% endblock %}
{% endblock %}