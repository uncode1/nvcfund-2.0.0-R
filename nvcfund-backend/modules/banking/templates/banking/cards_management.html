{% extends "unified_base.html" %}
{% from "components/nvc_components.html" import metric_card, action_card, account_card, transaction_row, form_input, form_select, notification_banner, progress_bar, stats_grid, loading_spinner, empty_state %}


{% block title %}Digital Cards & Payments - NVC Banking & Crypto Platform{% endblock %}

{% block page_title %}Digital Cards & Payments{% endblock %}
{% block page_description %}Manage traditional cards, crypto cards, and digital payment solutions{% endblock %}

{% block page_actions %}
<button type="button" class="nvc-btn nvc-btn-outline" data-action="export-data" data-target="cards">
    <i class="fas fa-download"></i>
    Export Data
</button>
<button type="button" class="nvc-btn nvc-btn-outline" data-action="order-physical-card">
    <i class="fas fa-credit-card"></i>
    Order Physical Card
</button>
<button type="button" class="nvc-btn nvc-btn-primary" data-action="create-virtual-card">
    <i class="fas fa-plus"></i>
    Create Virtual Card
</button>
{% endblock %}

{% block content %}
<!-- Modern Cards Management Dashboard -->
<div class="row g-4">
    <!-- Cards Overview -->
    <div class="col-12">
        <div class="nvc-card border-0 shadow-sm">
            <div class="nvc-nvc-card-body">
                <div class="row g-4">
                    <div class="col-md-3">
                        <div class="nvc-card-stat-item bg-primary">
                            <div class="stat-icon">
                                <i class="fas fa-credit-nvc-card"></i>
                            </div>
                            <div class="stat-content">
                                <h6>Active Cards</h6>
                                <h3>{{ active_cards_count or '8' }}</h3>
                                <small>Physical & Virtual</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="nvc-card-stat-item bg-success">
                            <div class="stat-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-content">
                                <h6>Monthly Spend</h6>
                                <h3>${{ "%.2f"|format(monthly_spend) if monthly_spend else '12,456.78' }}</h3>
                                <small>+15% vs last month</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="nvc-card-stat-item bg-warning">
                            <div class="stat-icon">
                                <i class="fab fa-bitcoin"></i>
                            </div>
                            <div class="stat-content">
                                <h6>Crypto Cards</h6>
                                <h3>{{ crypto_cards_count or '3' }}</h3>
                                <small>Digital assets</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="nvc-card-stat-item bg-info">
                            <div class="stat-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="stat-content">
                                <h6>Security Score</h6>
                                <h3>{{ security_score or '98' }}%</h3>
                                <small>Excellent</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Card Statistics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="dashboard-stat-nvc-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-light mb-1">Active Cards</h6>
                        <h3 class="text-success mb-0">18,547</h3>
                        <small class="text-success">+247 this month</small>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-credit-nvc-card text-success"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="dashboard-stat-nvc-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-light mb-1">Transaction Volume</h6>
                        <h3 class="text-white mb-0">$12.4M</h3>
                        <small class="text-info">Daily volume</small>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="dashboard-stat-nvc-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-light mb-1">Success Rate</h6>
                        <h3 class="text-success mb-0">99.2%</h3>
                        <small class="text-success">Excellent performance</small>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="dashboard-stat-nvc-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-light mb-1">Fraud Rate</h6>
                        <h3 class="text-danger mb-0">0.08%</h3>
                        <small class="text-success">Industry leading</small>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-shield-alt text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Management Dashboard -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="dashboard-stat-nvc-card">
                <div class="nvc-nvc-card-header d-flex justify-content-between align-items-center">
                    <h5 class="text-white mb-0">Card Portfolio Management</h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn nvc-btn nvc-btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#issueCardModal">
                            <i class="fas fa-plus me-2"></i>Issue Card
                        </button>
                        <button type="button" class="btn nvc-btn nvc-btn-outline btn-sm" data-action="export-data" data-target="cards-table">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                    </div>
                </div>
                <div class="nvc-nvc-card-body">
                    <!-- Card Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select nvc-form-select-sm" id="cardTypeFilter">
                                <option value="">All Card Types</option>
                                <option value="debit">Debit Cards</option>
                                <option value="credit">Credit Cards</option>
                                <option value="prepaid">Prepaid Cards</option>
                                <option value="business">Business Cards</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select nvc-form-select-sm" id="statusFilter">
                                <option value="">All Statuses</option>
                                <option value="active">Active</option>
                                <option value="blocked">Blocked</option>
                                <option value="expired">Expired</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control nvc-form-input-sm" placeholder="Search by card number or holder name..." id="cardSearch">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn nvc-btn nvc-btn-outline btn-sm w-100" data-action="filter-cards">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Cards Table -->
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Card Number</th>
                                    <th>Cardholder</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Limit/Balance</th>
                                    <th>Expiry</th>
                                    <th>Last Transaction</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cardsTable">
                                <tr>
                                    <td>
                                        <span class="text-info">****1234</span>
                                        <br><small class="text-light">Visa</small>
                                    </td>
                                    <td>Sarah Johnson</td>
                                    <td><span class="badge bg-primary">Debit</span></td>
                                    <td><span class="badge bg-success">Active</span></td>
                                    <td class="text-success">$12,450.75</td>
                                    <td class="text-light">12/2027</td>
                                    <td class="text-light">2 hours ago</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn nvc-btn nvc-btn-outline" title="View Details" 
                                                    data-action="view-card" data-target="****1234">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn nvc-btn nvc-btn-outline" title="Block Card" 
                                                    data-action="card-block" data-target="****1234" 
                                                    data-confirm="Are you sure you want to block this card?">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                            <button type="button" class="btn nvc-btn nvc-btn-outline" title="Settings" 
                                                    data-action="card-settings" data-target="****1234">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="text-info">****5678</span>
                                        <br><small class="text-light">Mastercard</small>
                                    </td>
                                    <td>Michael Chen</td>
                                    <td><span class="badge bg-warning">Credit</span></td>
                                    <td><span class="badge bg-success">Active</span></td>
                                    <td class="text-info">$8,500 / $15,000</td>
                                    <td class="text-light">09/2026</td>
                                    <td class="text-light">1 day ago</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn nvc-btn nvc-btn-outline" title="View Details" 
                                                    data-action="view-card" data-target="****5678">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn nvc-btn nvc-btn-outline" title="Block Card" 
                                                    data-action="card-block" data-target="****5678" 
                                                    data-confirm="Are you sure you want to block this card?">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                            <button type="button" class="btn nvc-btn nvc-btn-outline" title="Settings" 
                                                    data-action="card-settings" data-target="****5678">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="text-info">****9012</span>
                                        <br><small class="text-light">Visa</small>
                                    </td>
                                    <td>Tech Solutions LLC</td>
                                    <td><span class="badge bg-success">Business</span></td>
                                    <td><span class="badge bg-warning">Blocked</span></td>
                                    <td class="text-success">$127,543.89</td>
                                    <td class="text-light">03/2028</td>
                                    <td class="text-light">1 week ago</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn nvc-btn nvc-btn-outline" title="View Details" 
                                                    data-action="view-card" data-target="****9012">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn nvc-btn nvc-btn-outline" title="Unblock Card" 
                                                    data-action="card-unblock" data-target="****9012" 
                                                    data-confirm="Are you sure you want to unblock this card?">
                                                <i class="fas fa-unlock"></i>
                                            </button>
                                            <button type="button" class="btn nvc-btn nvc-btn-outline" title="Settings" 
                                                    data-action="card-settings" data-target="****9012">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Card Distribution -->
            <div class="dashboard-stat-nvc-card mb-3">
                <div class="nvc-nvc-card-header">
                    <h6 class="text-white mb-0">Card Type Distribution</h6>
                </div>
                <div class="nvc-nvc-card-body">
                    <canvas id="cardDistributionChart" height="200"></canvas>
                </div>
            </div>

            <!-- Card Insights -->
            <div class="dashboard-stat-nvc-card">
                <div class="nvc-nvc-card-header">
                    <h6 class="text-white mb-0">Card Insights</h6>
                </div>
                <div class="nvc-nvc-card-body">
                    <div class="insight-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-light">Average Monthly Spend</span>
                            <span class="text-white fw-bold">$2,847</span>
                        </div>
                        <div class="progress mt-1" class="nvc-h-4">
                            <div class="progress-bar bg-primary" class="progress-bar-65"></div>
                        </div>
                    </div>
                    <div class="insight-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-light">Card Utilization</span>
                            <span class="text-success fw-bold">67.2%</span>
                        </div>
                        <div class="progress mt-1" class="nvc-h-4">
                            <div class="progress-bar bg-success" class="progress-bar-67"></div>
                        </div>
                    </div>
                    <div class="insight-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-light">Customer Satisfaction</span>
                            <span class="text-warning fw-bold">94.8%</span>
                        </div>
                        <div class="progress mt-1" class="nvc-h-4">
                            <div class="progress-bar bg-warning" class="progress-bar-95"></div>
                        </div>
                    </div>
                    <div class="insight-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-light">Security Score</span>
                            <span class="text-info fw-bold">99.2%</span>
                        </div>
                        <div class="progress mt-1" class="nvc-h-4">
                            <div class="progress-bar bg-info" class="progress-bar-99"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Activity Analytics -->
    <div class="row">
        <div class="col-12">
            <div class="dashboard-stat-nvc-card">
                <div class="nvc-nvc-card-header">
                    <h5 class="text-white mb-0">Card Transaction Analytics</h5>
                </div>
                <div class="nvc-nvc-card-body">
                    <canvas id="cardActivityChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Cards-specific functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('🃏 Cards Management initialized');
    
    // Initialize card-specific features
    initializeCardCharts();
});

function initializeCardCharts() {
    // Card Distribution Chart
    const distributionCtx = document.getElementById('cardDistributionChart').getContext('2d');
    new Chart(distributionCtx, {
        type: 'doughnut',
        data: {
            labels: ['Debit', 'Credit', 'Business', 'Prepaid'],
            datasets: [{
                data: [58, 28, 10, 4],
                backgroundColor: ['#007bff', '#ffc107', '#28a745', '#17a2b8'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#e2e8f0',
                        padding: 10
                    }
                }
            }
        }
    });

    // Card Activity Chart
    const activityCtx = document.getElementById('cardActivityChart').getContext('2d');
    new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
            datasets: [{
                label: 'Transaction Volume ($M)',
                data: [8.5, 9.2, 10.1, 9.8, 11.2, 12.1, 12.4],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Transaction Count (K)',
                data: [15.2, 16.8, 17.5, 16.9, 18.1, 18.8, 18.5],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#e2e8f0'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#e2e8f0'
                    },
                    grid: {
                        color: 'rgba(226, 232, 240, 0.1)'
                    }
                },
                y: {
                    ticks: {
                        color: '#e2e8f0'
                    },
                    grid: {
                        color: 'rgba(226, 232, 240, 0.1)'
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}
{% endblock %}